services:
  # ── MongoDB (conversation state) ───────────────────────────────────────
  mongo:
    image: mongo:7
    container_name: lohono-mongo
    restart: unless-stopped
    ports:
      - "${MONGO_PORT:-27017}:27017"
    volumes:
      - mongodata:/data/db
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ── Redis (shared cache) ──────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: lohono-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redisdata:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  # ── MCP Server (SSE mode) ──────────────────────────────────────────────
  mcp-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: lohono-mcp-server
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      REDASH_URL: ${REDASH_URL:-}
      REDASH_API_KEY: ${REDASH_API_KEY:-}
      DATABASE_DIR: /app/database
      MCP_USER_EMAIL: ${MCP_USER_EMAIL:-}
      SALES_FUNNEL_RULES_PATH: /app/database/schema/sales_funnel_rules_v2.yml
      REDIS_URL: redis://redis:6379
      PORT: "3000"
      # ── Observability ──
      OTEL_SDK_DISABLED: ${OTEL_SDK_DISABLED:-false}
      OTEL_SERVICE_NAME: lohono-mcp-server
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4317}
      NODE_ENV: ${NODE_ENV:-production}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      DEBUG_MODE: ${DEBUG_MODE:-false}
      TZ: Asia/Kolkata
    ports:
      - "${MCP_PORT:-3000}:3000"
    volumes:
      - ./database:/app/database:ro
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ── Help Desk MCP Server (Bedrock Knowledge Base) ─────────────────────
  helpdesk-server:
    build:
      context: .
      dockerfile: Dockerfile.helpdesk
    container_name: lohono-helpdesk-server
    restart: unless-stopped
    environment:
      BEDROCK_KB_ID: ${BEDROCK_KB_ID:-}
      BEDROCK_MODEL_ARN: ${BEDROCK_MODEL_ARN:-}
      AWS_REGION: ${AWS_REGION:-ap-south-1}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      PORT: "3002"
      # ── Observability ──
      OTEL_SDK_DISABLED: ${OTEL_SDK_DISABLED:-false}
      OTEL_SERVICE_NAME: lohono-helpdesk-server
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4317}
      NODE_ENV: ${NODE_ENV:-production}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      DEBUG_MODE: ${DEBUG_MODE:-false}
      TZ: Asia/Kolkata
    ports:
      - "${HELPDESK_PORT:-3002}:3002"
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3002/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ── MCP Client (Claude-powered backend API) ────────────────────────────
  mcp-client:
    build:
      context: .
      dockerfile: Dockerfile.client
    container_name: lohono-mcp-client
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      mongo:
        condition: service_healthy
      mcp-server:
        condition: service_healthy
      helpdesk-server:
        condition: service_healthy
    environment:
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      CLAUDE_MODEL: ${CLAUDE_MODEL:-claude-sonnet-4-5-20250929}
      MCP_SSE_URL: http://mcp-server:3000
      HELPDESK_SSE_URL: ${HELPDESK_SSE_URL:-http://helpdesk-server:3002}
      MONGODB_URI: mongodb://mongo:27017
      MONGODB_DB_NAME: ${MONGODB_DB_NAME:-mcp_client}
      REDIS_URL: redis://redis:6379
      CLIENT_PORT: "3001"
      # PG access for staff email verification during auth
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      # ── Observability ──
      OTEL_SDK_DISABLED: ${OTEL_SDK_DISABLED:-false}
      OTEL_SERVICE_NAME: lohono-mcp-client
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4317}
      NODE_ENV: ${NODE_ENV:-production}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      DEBUG_MODE: ${DEBUG_MODE:-false}
      TZ: Asia/Kolkata
    ports:
      - "${CLIENT_PORT:-3001}:3001"
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/api/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ── Chat Client (React SPA via nginx) ───────────────────────────────────
  chat-client:
    build:
      context: .
      dockerfile: Dockerfile.chat-client
    container_name: lohono-chat-client
    restart: unless-stopped
    depends_on:
      mcp-client:
        condition: service_healthy
    ports:
      - "${WEB_PORT:-8080}:8080"

  # ═══════════════════════════════════════════════════════════════════════════
  # Observability Stack (SigNoz + ClickHouse + OTel Collector)
  # ═══════════════════════════════════════════════════════════════════════════

  # ── ClickHouse (SigNoz storage backend) ────────────────────────────────
  clickhouse:
    image: clickhouse/clickhouse-server:24.1-alpine
    container_name: signoz-clickhouse
    restart: unless-stopped
    volumes:
      - signoz-clickhouse-data:/var/lib/clickhouse
      - ./clickhouse-config/cluster.xml:/etc/clickhouse-server/config.d/cluster.xml:ro
      - ./clickhouse-config/users.xml:/etc/clickhouse-server/users.xml:ro
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:8123/ping"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    environment:
      TZ: Asia/Kolkata

  # ── Schema Migrator (creates ClickHouse tables, runs once) ─────────────
  schema-migrator:
    image: signoz/signoz-schema-migrator:0.111.24
    container_name: signoz-schema-migrator
    command:
      - sync
      - --dsn=tcp://clickhouse:9000
      - --up=
    depends_on:
      clickhouse:
        condition: service_healthy
    restart: on-failure
    environment:
      TZ: Asia/Kolkata

  # ── SigNoz (query service + frontend UI) ───────────────────────────────
  signoz:
    image: signoz/signoz:v0.111.0
    container_name: signoz
    restart: unless-stopped
    depends_on:
      clickhouse:
        condition: service_healthy
      schema-migrator:
        condition: service_completed_successfully
    ports:
      - "${SIGNOZ_PORT:-3301}:8080"
    volumes:
      - signoz-data:/var/lib/signoz
    environment:
      SIGNOZ_CLICKHOUSE_HOST: clickhouse
      SIGNOZ_CLICKHOUSE_PORT: 9000
      STORAGE: clickhouse
      GODEBUG: netdns=go
      TELEMETRY_ENABLED: "true"
      DEPLOYMENT_TYPE: docker-standalone-amd
      TZ: Asia/Kolkata
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:8080"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 60s

  # ── SigNoz OTel Collector (receives from app collector, writes to ClickHouse) ───
  signoz-otel-collector:
    image: signoz/signoz-otel-collector:0.111.24
    container_name: signoz-otel-collector
    restart: unless-stopped
    command:
      - "--config=/etc/otel-collector-config.yaml"
    depends_on:
      clickhouse:
        condition: service_healthy
      schema-migrator:
        condition: service_completed_successfully
      signoz:
        condition: service_healthy
    volumes:
      - ./signoz-otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    environment:
      OTEL_RESOURCE_ATTRIBUTES: host.name=signoz-otel-collector,os.type=linux
      LOW_CARDINAL_EXCEPTION_GROUPING: "false"
      TZ: Asia/Kolkata
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:13133"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ── Application OTel Collector (receives from app services) ────────────
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.102.0
    container_name: lohono-otel-collector
    restart: unless-stopped
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    depends_on:
      signoz-otel-collector:
        condition: service_healthy
    ports:
      - "${OTEL_GRPC_PORT:-4317}:4317"    # OTLP gRPC
      - "${OTEL_HTTP_PORT:-4318}:4318"    # OTLP HTTP
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:13133"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    environment:
      TZ: Asia/Kolkata

volumes:
  mongodata:
    driver: local
  redisdata:
    driver: local
  signoz-clickhouse-data:
    driver: local
  signoz-data:
    driver: local

networks:
  default:
    name: lohono-network
