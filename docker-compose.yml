services:
  # ── MongoDB (conversation state) ───────────────────────────────────────
  mongo:
    image: mongo:7
    container_name: lohono-mongo
    restart: unless-stopped
    ports:
      - "${MONGO_PORT:-27017}:27017"
    volumes:
      - mongodata:/data/db
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ── MCP Server (SSE mode) ──────────────────────────────────────────────
  mcp-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: lohono-mcp-server
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      REDASH_URL: ${REDASH_URL:-}
      REDASH_API_KEY: ${REDASH_API_KEY:-}
      ACL_CONFIG_PATH: /app/database/schema/acl.yml
      DATABASE_DIR: /app/database
      MCP_USER_EMAIL: ${MCP_USER_EMAIL:-}
      SALES_FUNNEL_RULES_PATH: /app/database/schema/sales_funnel_rules_v2.yml
      PORT: "3000"
      # ── Observability ──
      OTEL_SDK_DISABLED: ${OTEL_SDK_DISABLED:-true}
      OTEL_SERVICE_NAME: lohono-mcp-server
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4317}
      NODE_ENV: ${NODE_ENV:-production}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      TZ: Asia/Kolkata
    ports:
      - "${MCP_PORT:-3000}:3000"
    volumes:
      - ./database:/app/database:ro
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ── Help Desk MCP Server (Bedrock Knowledge Base) ─────────────────────
  helpdesk-server:
    build:
      context: .
      dockerfile: Dockerfile.helpdesk
    container_name: lohono-helpdesk-server
    restart: unless-stopped
    environment:
      BEDROCK_KB_ID: ${BEDROCK_KB_ID:-}
      BEDROCK_MODEL_ARN: ${BEDROCK_MODEL_ARN:-}
      AWS_REGION: ${AWS_REGION:-ap-south-1}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      PORT: "3002"
      # ── Observability ──
      OTEL_SDK_DISABLED: ${OTEL_SDK_DISABLED:-true}
      OTEL_SERVICE_NAME: lohono-helpdesk-server
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4317}
      NODE_ENV: ${NODE_ENV:-production}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      TZ: Asia/Kolkata
    ports:
      - "${HELPDESK_PORT:-3002}:3002"
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3002/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ── MCP Client (Claude-powered backend API) ────────────────────────────
  mcp-client:
    build:
      context: .
      dockerfile: Dockerfile.client
    container_name: lohono-mcp-client
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      mongo:
        condition: service_healthy
      mcp-server:
        condition: service_healthy
      helpdesk-server:
        condition: service_healthy
    environment:
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      CLAUDE_MODEL: ${CLAUDE_MODEL:-claude-sonnet-4-5-20250929}
      MCP_SSE_URL: http://mcp-server:3000
      HELPDESK_SSE_URL: ${HELPDESK_SSE_URL:-http://helpdesk-server:3002}
      MONGODB_URI: mongodb://mongo:27017
      MONGODB_DB_NAME: ${MONGODB_DB_NAME:-mcp_client}
      CLIENT_PORT: "3001"
      # PG access for staff email verification during auth
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      # ── Observability ──
      OTEL_SDK_DISABLED: ${OTEL_SDK_DISABLED:-true}
      OTEL_SERVICE_NAME: lohono-mcp-client
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4317}
      NODE_ENV: ${NODE_ENV:-production}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      TZ: Asia/Kolkata
    ports:
      - "${CLIENT_PORT:-3001}:3001"
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/api/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ── Chat Client (React SPA via nginx) ───────────────────────────────────
  chat-client:
    build:
      context: .
      dockerfile: Dockerfile.chat-client
    container_name: lohono-chat-client
    restart: unless-stopped
    depends_on:
      mcp-client:
        condition: service_healthy
    ports:
      - "${WEB_PORT:-8080}:8080"

volumes:
  mongodata:
    driver: local

networks:
  default:
    name: lohono-network
