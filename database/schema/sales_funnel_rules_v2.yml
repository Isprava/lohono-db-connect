# ============================================================================
# SALES FUNNEL SECTION - MASTER CONFIGURATION v2.0
# ============================================================================
# This file defines all business rules, query patterns, and logic for the
# Sales Funnel section. The MCP client uses this to dynamically generate
# queries based on user requests.
#
# Version: 2.0
# Last Updated: 2024-12-08
# Changes: Fixed applies_to logic to use pattern categories instead of query numbers
# ============================================================================

section:
  name: "sales_funnel"
  description: "Marketing and Sales funnel analysis from Leads to Sales"
  vertical: "development"

# ============================================================================
# QUERY CATEGORIES (Used for applies_to references)
# ============================================================================

query_categories:
  mtd_aggregate:
    description: "MTD aggregate funnel metrics"
    patterns: ["mtd_funnel_current", "mtd_funnel_last_year"]
    
  source_breakdown:
    description: "Metrics broken down by source"
    patterns: ["source_daily_breakdown"]
    
  open_count:
    description: "Count of open/active records"
    patterns: ["open_funnel_count"]
    
  detail_listings:
    description: "Row-level detail listings"
    patterns: ["mtd_lead_details"]
    
  aging_reports:
    description: "Aging analysis for open opportunities"
    patterns: ["prospect_aging", "account_aging"]
    
  historical_analysis:
    description: "Historical data with closed reasons"
    patterns: ["historical_funnel_details", "regional_closed_analysis"]

# ============================================================================
# CORE BUSINESS RULES (Apply based on conditions)
# ============================================================================

core_rules:
  
  timezone_conversion:
    description: "Convert all timestamps to IST (UTC+5:30)"
    sql_pattern: "({{column_name}} + interval '330 minutes')"
    alternative_pattern: "({{column_name}} + interval '5 hours 30 minutes')"
    applies_to: "ALL queries"
    mandatory: true
    validation: "All date operations must include timezone conversion"
    note: "Use one format consistently per query - do not mix formats"
    
  slug_exclusions:
    description: "Exclude banned opportunity slugs"
    values: ['569657C6', '5EB1A14A', '075E54DF']
    applies_to: ["mtd_aggregate", "source_breakdown", "detail_listings", "historical_analysis"]
    excludes_from: ["aging_reports"]
    sql_pattern: "slug NOT IN ('569657C6','5EB1A14A','075E54DF')"
    applies_to_tables: ["development_opportunities"]
    never_apply_to_tables: ["enquiries"]
    mandatory: true
    note: "Query 6 & 7 (aging reports) do NOT use slug exclusions"
    
  distinct_counting:
    description: "Always use distinct slug counts for opportunities"
    sql_pattern: "COUNT(DISTINCT(development_opportunities.slug))"
    applies_to: "ALL queries with opportunity counts"
    mandatory: true
    reason: "Prevents double-counting across joins"

  source_exclusion_dnb:
    description: "Exclude DnB source from lead calculations ONLY"
    applies_to: ["mtd_aggregate", "source_breakdown", "historical_analysis"]
    applies_to_metrics: ["leads"]
    never_apply_to_metrics: ["prospects", "accounts", "sales"]
    sql_pattern: "development_opportunities.source != 'DnB'"
    tables: ["development_opportunities"]
    mandatory: true
    note: "Only for leads metric, not prospects/accounts/sales"

# ============================================================================
# DATE FILTER RULES
# ============================================================================

date_filters:
  
  mtd_current_progressive:
    description: "Month-to-date for current month with progressive day filter"
    applies_to: ["mtd_aggregate", "source_breakdown", "open_count", "detail_listings"]
    start_date_sql: "cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)"
    end_date_sql: "cast(date_trunc('month',CURRENT_DATE + interval '330 minutes' + INTERVAL '1 MONTH') AS date)"
    date_filter_sql: |
      ({{timestamp_column}} + interval '330 minutes')::date >= cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)
      AND ({{timestamp_column}} + interval '330 minutes')::date < cast(date_trunc('month',CURRENT_DATE + interval '330 minutes' + INTERVAL '1 MONTH') AS date)
    progressive_day_filter: true
    progressive_filter_sql: "date_part('day',{{timestamp_column}} + interval '330 minutes') <= date_part('day',now() + interval '330 minutes')"
    
  mtd_last_year_progressive:
    description: "Month-to-date for same month last year with progressive day filter"
    applies_to: ["mtd_aggregate"]
    patterns_using: ["mtd_funnel_last_year"]
    start_date_sql: "cast(date_trunc('month', (CURRENT_DATE - interval '1 year') + interval '330 minutes') AS date)"
    end_date_sql: "cast(date_trunc('month', (CURRENT_DATE - interval '1 year') + interval '330 minutes' + INTERVAL '1 MONTH') AS date)"
    date_filter_sql: |
      ({{timestamp_column}} + interval '330 minutes')::date >= cast(date_trunc('month', (CURRENT_DATE - interval '1 year') + interval '330 minutes') AS date)
      AND ({{timestamp_column}} + interval '330 minutes')::date < cast(date_trunc('month', (CURRENT_DATE - interval '1 year') + interval '330 minutes' + INTERVAL '1 MONTH') AS date)
    progressive_day_filter: true
    progressive_filter_sql: "date_part('day',{{timestamp_column}} + interval '330 minutes') <= date_part('day',(now() - interval '1 year') + interval '330 minutes')"
    note: "Reference date is (now() - interval '1 year')"
    
  trailing_12_months:
    description: "Last 12 months of data"
    applies_to: ["historical_analysis"]
    patterns_using: ["historical_funnel_details", "regional_closed_analysis"]
    start_date_sql: "date_trunc('month', CURRENT_DATE) - interval '12 months'"
    end_date_sql: "date_trunc('month', CURRENT_DATE) + interval '1 month'"
    date_filter_sql: |
      date({{timestamp_column}} + interval '5 hours 30 minutes') >= date_trunc('month', CURRENT_DATE) - interval '12 months'
      AND date({{timestamp_column}} + interval '5 hours 30 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
    progressive_day_filter: false
    note: "Uses '5 hours 30 minutes' format instead of '330 minutes'"
    
  since_fy_2022:
    description: "Data from FY 2022-04-01 onwards"
    applies_to: ["aging_reports"]
    patterns_using: ["prospect_aging", "account_aging"]
    start_date_sql: "'2022-04-01'"
    date_filter_sql: "date({{timestamp_column}} + interval '330 minutes') >= '2022-04-01'"
    progressive_day_filter: false

# ============================================================================
# FUNNEL DEFINITIONS
# ============================================================================

funnel_stages:
  
  lead:
    metric_name: "Leads"
    sort_order: 1
    type: "multi_source"
    description: "Initial contact/enquiry"
    timestamp_columns:
      development_opportunities: "enquired_at"
      enquiries: "created_at"

    source_1_opportunities:
      table: "development_opportunities"
      timestamp_column: "enquired_at"
      count_expression: "COUNT(DISTINCT(development_opportunities.slug))"
      mandatory_conditions:
        - "enquired_at IS NOT NULL"
      mandatory_exclusions:
        - "slug_exclusions"
        - "source_exclusion_dnb"
      applies_timezone: true
      applies_date_filter: true
      applies_progressive_filter: true

    source_2_enquiries:
      table: "enquiries"
      timestamp_column: "created_at"
      count_expression: "COUNT(id)"
      mandatory_conditions:
        - "vertical = 'development'"
        - "enquiry_type = 'enquiry'"
        - "leadable_id IS NULL"
      mandatory_exclusions: []
      applies_timezone: true
      applies_date_filter: true
      applies_progressive_filter: true
      note: "No slug exclusions or source exclusions for enquiries"

    combination_logic: "opportunities_count + enquiries_count"

  prospect:
    metric_name: "Prospects"
    sort_order: 2
    type: "single_source"
    description: "Qualified lead, moved to prospect stage"
    timestamp_column: "lead_completed_at"
    table: "development_opportunities"
    count_expression: "COUNT(DISTINCT(development_opportunities.slug))"
    mandatory_conditions:
      - "lead_completed_at IS NOT NULL"
    mandatory_exclusions:
      - "slug_exclusions"
    no_source_exclusion: true
    applies_timezone: true
    applies_date_filter: true
    applies_progressive_filter: true

  account:
    metric_name: "Accounts"
    sort_order: 3
    type: "single_source"
    description: "Prospect converted to account"
    timestamp_column: "prospect_completed_at"
    table: "development_opportunities"
    count_expression: "COUNT(DISTINCT(development_opportunities.slug))"
    mandatory_conditions:
      - "prospect_completed_at IS NOT NULL"
    mandatory_exclusions:
      - "slug_exclusions"
    no_source_exclusion: true
    applies_timezone: true
    applies_date_filter: true
    applies_progressive_filter: true

  sale:
    metric_name: "Sales"
    sort_order: 4
    type: "single_source"
    description: "Closed deal (Maal Laao)"
    timestamp_column: "maal_laao_at"
    table: "development_opportunities"
    count_expression: "COUNT(DISTINCT(development_opportunities.slug))"
    mandatory_conditions:
      - "maal_laao_at IS NOT NULL"
    mandatory_exclusions:
      - "slug_exclusions"
    no_source_exclusion: true
    applies_timezone: true
    applies_date_filter: true
    applies_progressive_filter: true

# ============================================================================
# METRICS DEFINITIONS
# ============================================================================

metrics:
  
  meetings:
    description: "Count of meetings held (distinct opportunities)"
    applies_to: ["mtd_aggregate"]
    patterns_using: ["mtd_funnel_current", "mtd_funnel_last_year"]
    
    required_tables:
      - "tasks"
      - "activities"
      - "medium"
      - "development_opportunities"
      
    join_conditions:
      - "tasks.id = activities.feedable_id"
      - "tasks.medium_id = medium.id"
      - "development_opportunities.id = activities.leadable_id"
      
    filter_conditions:
      - "activities.feedable_type = 'Task'"
      - "activities.leadable_type = 'Development::Opportunity'"
      - "medium.name = 'Meeting'"
      
    timestamp_column: "performed_at"
    count_expression: "COUNT(DISTINCT(development_opportunities.slug))"
    applies_timezone: true
    applies_date_filter: true
    applies_progressive_filter: true
    no_slug_exclusions: true
    note: "Count unique opportunities, not task count"
    
  viewings:
    description: "On-site property viewings (South region only)"
    applies_to: ["mtd_aggregate"]
    patterns_using: ["mtd_funnel_current", "mtd_funnel_last_year"]
    
    required_tables:
      - "tasks"
      - "activities"
      - "medium"
      - "development_opportunities"
      - "staffs"
      
    join_conditions:
      - "tasks.id = activities.feedable_id"
      - "tasks.medium_id = medium.id"
      - "development_opportunities.id = activities.leadable_id"
      - "staffs.id = development_opportunities.poc_exec_id"
      
    filter_conditions:
      - "activities.feedable_type = 'Task'"
      - "activities.leadable_type = 'Development::Opportunity'"
      - "staffs.source_region = 'south'"
      - "medium.name IN ('Goa Viewing', 'Alibaug Viewing', 'Coonoor Viewing', 'Viewing', 'Site Visit')"
      
    timestamp_column: "performed_at"
    count_expression: "COUNT(DISTINCT(development_opportunities.slug))"
    applies_timezone: true
    applies_date_filter: true
    applies_progressive_filter: true
    no_slug_exclusions: true
    regional_filter: "source_region = 'south'"
    
  l2p_duration:
    description: "Lead to Prospect conversion time (days)"
    applies_to: ["mtd_aggregate"]
    patterns_using: ["mtd_funnel_current", "mtd_funnel_last_year"]
    table: "development_opportunities"
    calculation_sql: "date(lead_completed_at + interval '330 minutes') - date(enquired_at + interval '330 minutes')"
    aggregation: "AVG"
    cast_to: "int"
    requires_both_columns: ["enquired_at", "lead_completed_at"]
    filter_on_column: "lead_completed_at"
    applies_timezone: true
    applies_date_filter: true
    applies_progressive_filter: true
    applies_slug_exclusions: true
    
  p2a_duration:
    description: "Prospect to Account conversion time (days)"
    applies_to: ["mtd_aggregate"]
    patterns_using: ["mtd_funnel_current", "mtd_funnel_last_year"]
    table: "development_opportunities"
    calculation_sql: "date(prospect_completed_at + interval '330 minutes') - date(lead_completed_at + interval '330 minutes')"
    aggregation: "AVG"
    cast_to: "int"
    requires_both_columns: ["lead_completed_at", "prospect_completed_at"]
    filter_on_column: "prospect_completed_at"
    applies_timezone: true
    applies_date_filter: true
    applies_progressive_filter: true
    applies_slug_exclusions: true
    
  a2s_duration:
    description: "Account to Sale conversion time (days)"
    applies_to: ["mtd_aggregate"]
    patterns_using: ["mtd_funnel_current", "mtd_funnel_last_year"]
    table: "development_opportunities"
    calculation_sql: "date(maal_laao_at + interval '330 minutes') - date(prospect_completed_at + interval '330 minutes')"
    aggregation: "AVG"
    cast_to: "int"
    requires_both_columns: ["prospect_completed_at", "maal_laao_at"]
    filter_on_column: "maal_laao_at"
    applies_timezone: true
    applies_date_filter: true
    applies_progressive_filter: true
    applies_slug_exclusions: true

# ============================================================================
# SOURCE CATEGORIZATION
# ============================================================================

source_mapping:
  description: "Categorize raw source values into business categories"
  applies_to: ["source_breakdown", "detail_listings", "historical_analysis"]
  
  categories:
    Agent:
      source_values: ["agent"]
      
    Digital:
      source_values:
        - "direct_mailer"
        - "emailer"
        - "google"
        - "facebook"
        - "instagram"
        - "linkedin"
        - "youtube"
        - "signage"
        - "isprava"
        - "isprava.com"
        - "isprava.com_chatbot"
        - "direct_call"
        
    Lohono:
      source_values: ["lohono.com", "lohono"]
      
    "Reference + Word of Mouth":
      source_values:
        - "reference"
        - "word_of_mouth"
        - "isprava_employee"
        - "chapter_employee"
        - "chapter_reference"
        - "homeowner_ref"
        
    "Repeat Client":
      source_values: ["repeat_client"]
      
    Other:
      source_values: ["*"]
      is_default: true
      
  sql_case_statement: |
    CASE 
      WHEN source = 'agent' THEN 'Agent'
      WHEN source IN ('direct_mailer','emailer','google','facebook','instagram','linkedin','youtube','signage','isprava','isprava.com','isprava.com_chatbot','direct_call') THEN 'Digital'
      WHEN source IN ('lohono.com','lohono') THEN 'Lohono'
      WHEN source IN ('reference','word_of_mouth','isprava_employee','chapter_employee','chapter_reference','homeowner_ref') THEN 'Reference + Word of Mouth'
      WHEN source = 'repeat_client' THEN 'Repeat Client'
      ELSE 'Other' 
    END

# ============================================================================
# STATUS AND CLOSED REASON LOGIC
# ============================================================================

status_logic:
  
  open_definition:
    description: "Opportunities still in funnel (not closed, not trash, not sold)"
    applies_to: ["open_count", "aging_reports"]
    patterns_using: ["open_funnel_count", "mtd_lead_details", "prospect_aging", "account_aging"]
    
    for_opportunities:
      conditions:
        - "status != 'closed'"
        - "status != 'trash'"
        - "maal_laao_at IS NULL"
        
    for_enquiries:
      conditions:
        - "is_trash != TRUE"
        
  closed_reason_extraction:
    description: "Get primary closed reason from tasks table"
    applies_to: ["historical_analysis"]
    patterns_using: ["historical_funnel_details", "regional_closed_analysis"]
    
    required_tables:
      - "tasks"
      - "activities"
      - "development_opportunities"
      
    join_conditions:
      - "tasks.id = activities.feedable_id"
      - "activities.leadable_id = development_opportunities.id"
      
    filter_conditions:
      - "tasks.rating = 'closed'"
      - "activities.feedable_type = 'Task'"
      - "activities.leadable_type = 'Development::Opportunity'"
      
    extraction_sql: "(jsonb_array_elements(closed_reason)->>'closed_reason_value')"
    explanation_sql: "(jsonb_array_elements(closed_reason)->>'closed_reason_explanation')"
    
    ranking_logic:
      sql: "RANK() OVER (PARTITION BY activities.leadable_id ORDER BY tasks.performed_at ASC)"
      select_rank: 1
      note: "Take earliest closed reason by performed_at"

    multiple_reasons_handling:
      description: "Handle tasks with multiple closed_reason array elements"
      issue: "jsonb_array_elements creates duplicate rows if task has multiple reasons"
      mandatory: true
      
      deduplication_method: "DISTINCT ON (slug)"
      sql: "SELECT DISTINCT ON (slug) slug, closed_reason FROM ... ORDER BY slug"
      selection_logic: "Takes first closed_reason alphabetically if multiple exist"
      
      alternative_method: "LEFT JOIN on slug"
      alternative_note: "LEFT JOIN implicitly selects one row if duplicates exist"
      
      example_scenario: |
        Task with closed_reason: [{"closed_reason_value": "budget"}, {"closed_reason_value": "not_interested"}]
        - Without deduplication: Creates 2 rows for same slug (both ranking=1)
        - With DISTINCT ON: Creates 1 row (selects 'budget' alphabetically before 'not_interested')
      
    null_handling:
      when_null_or_empty: "Others"
      when_equals_others: "Others"
      
    display_transformation:
      sql: "INITCAP(REPLACE(closed_reason_value, '_', ' '))"
      
    conditional_display:
      sql: |
        CASE 
          WHEN status = 'closed' AND closed_reason IS NOT NULL THEN INITCAP(REPLACE(closed_reason,'_',' '))
          WHEN status = 'closed' AND closed_reason IS NULL THEN 'Others'
          WHEN status = 'closed' AND INITCAP(REPLACE(closed_reason,'_',' ')) = 'Others' THEN 'Others'
          ELSE NULL 
        END
      applies_to_pattern: "regional_closed_analysis"
      
  stage_history_joins:
    description: "Get dates when opportunity moved to prospect/account stages"
    applies_to: ["historical_analysis"]
    patterns_using: ["historical_funnel_details"]
    
    moved_to_prospect:
      tables:
        - "stage_histories"
        - "stages"
      join_conditions:
        - "development_opportunities.id = stage_histories.leadable_id"
        - "stage_histories.leadable_type = 'Development::Opportunity'"
        - "stage_histories.stage_id = stages.id"
      filter_conditions:
        - "stages.vertical = 'development'"
        - "stages.code = 'prospect'"
      ranking:
        sql: "RANK() OVER (PARTITION BY stage_histories.leadable_id, stage_histories.leadable_type ORDER BY stage_histories.updated_at ASC)"
        select_rank: 1
      date_expression: "stage_histories.updated_at + interval '330 minutes'"
      
    moved_to_account:
      tables:
        - "stage_histories"
        - "stages"
      join_conditions:
        - "development_opportunities.id = stage_histories.leadable_id"
        - "stage_histories.leadable_type = 'Development::Opportunity'"
        - "stage_histories.stage_id = stages.id"
      filter_conditions:
        - "stages.vertical = 'development'"
        - "stages.code = 'account'"
      ranking:
        sql: "RANK() OVER (PARTITION BY stage_histories.leadable_id, stage_histories.leadable_type ORDER BY stage_histories.updated_at ASC)"
        select_rank: 1
      date_expression: "stage_histories.updated_at + interval '330 minutes'"
      
  maal_laao_date_from_tasks:
    description: "Alternative way to get sale date from tasks table"
    applies_to: ["historical_analysis"]
    patterns_using: ["historical_funnel_details"]
    
    tables:
      - "tasks"
      - "activities"
      - "development_opportunities"
      
    join_conditions:
      - "tasks.id = activities.feedable_id"
      - "activities.feedable_type = 'Task'"
      - "activities.leadable_type = 'Development::Opportunity'"
      - "activities.leadable_id = development_opportunities.id"
      
    filter_conditions:
      - "tasks.rating = 'maal_laao'"
      
    ranking:
      sql: "RANK() OVER (PARTITION BY activities.leadable_id ORDER BY tasks.performed_at ASC)"
      select_rank: 1
      
    date_expression: "DATE(tasks.performed_at + interval '5 hours 30 minutes')"
    applies_slug_exclusions: true

# ============================================================================
# SPECIAL LOGIC FOR SPECIFIC PATTERNS
# ============================================================================

special_patterns:
  
  source_daily_breakdown:
    description: "Daily metrics by source for current month"
    pattern_name: "source_daily_breakdown"
    applies_to: ["source_breakdown"]
    
    date_series_generation:
      start: "date_trunc('month', current_date)"
      end: "current_date"
      interval: "'1 day'"
      sql: "generate_series(date_trunc('month', current_date)::timestamp, current_date, '1 day'::interval)"
      
    cross_join_sources:
      description: "Generate all date x source combinations"
      note: "Cross join date series with source categories"
      
    left_join_metrics:
      description: "Left join actual metrics for each date + source"
      note: "Metrics will be null for dates/sources with no data"
      
    final_grouping:
      group_by: ["source"]
      aggregate: "SUM metrics across all dates"
      
    no_progressive_filter: true
    note: "Does not use progressive day filter - shows all days in month"
    
  open_funnel_count:
    description: "Count of open opportunities and enquiries"
    pattern_name: "open_funnel_count"
    applies_to: ["open_count"]
    
    calculation_method: "Filter-based counting"
    sql_logic: |
      COUNT(DISTINCT(slug)) - COUNT(DISTINCT(slug)) FILTER (WHERE status='closed') - COUNT(DISTINCT(slug)) FILTER (WHERE status='trash')
      
    union_logic:
      source_1: "development_opportunities"
      source_2: "enquiries"
      filter_enquiries:
        - "vertical = 'development'"
        - "enquiry_type = 'enquiry'"
        - "leadable_id IS NULL"
        
    for_opportunities:
      filters:
        - "maal_laao_at IS NULL"
        
  aging_reports:
    description: "Calculate days in current stage for open opportunities"
    pattern_names: ["prospect_aging", "account_aging"]
    applies_to: ["aging_reports"]
    
    no_slug_exclusions: true
    no_source_exclusions: true
    
    common_filters:
      - "maal_laao_at IS NULL"
      - "status != 'closed'"
      - "LOWER(name) NOT LIKE '%test%'"
      - "LOWER(name) NOT LIKE 'test%'"
      - "LOWER(name) != 'test'"
      
    prospect_aging:
      stage_filter: "current_stage = 'prospect'"
      ageing_calculation: "date(now() + interval '330 minutes') - date(lead_completed_at + interval '330 minutes')"
      order_by: "ageing DESC"
      
    account_aging:
      stage_filter: "current_stage = 'account'"
      ageing_calculation: "date(now() + interval '330 minutes') - date(prospect_completed_at + interval '330 minutes')"
      order_by: "ageing DESC"
      
  detail_listings:
    description: "Row-level detail records"
    pattern_name: "mtd_lead_details"
    applies_to: ["detail_listings"]
    
    union_structure: true
    
    opportunities_section:
      base_table: "development_opportunities"
      left_joins:
        - table: "agents"
          on: "agents.id = development_opportunities.agent_id"
        - table: "staffs AS staffs1"
          on: "staffs1.id = development_opportunities.poc_exec_id"
          alias: "poc_exec"
        - table: "staffs AS staffs2"
          on: "staffs2.id = development_opportunities.poc_head_id"
          alias: "poc_head"
      additional_filter_after_join:
        applies_date_filter: "enquired_date column (already IST converted)"
        
    enquiries_section:
      base_table: "enquiries"
      left_joins:
        - table: "agents"
          on: "agents.id = enquiries.agent_id"
      filters:
        - "vertical = 'development'"
        - "enquiry_type = 'enquiry'"
        - "leadable_id IS NULL"
        
  historical_details:
    description: "12 months of historical records with closed reasons"
    pattern_name: "historical_funnel_details"
    applies_to: ["historical_analysis"]
    
    union_structure: true
    complex_joins: true
    
    includes:
      - "stage_history_joins for prospect/account dates"
      - "maal_laao_date_from_tasks for sale date"
      - "closed_reason_extraction for closure info"
      
    note: "Most complex query with multiple ranking subqueries"
    
  regional_closed_analysis:
    description: "Closed reasons by region"
    pattern_name: "regional_closed_analysis"
    applies_to: ["historical_analysis"]
    
    union_structure: true
    
    source_region_handling:
      when_null: "Unclassified"
      transformation: "INITCAP(source_region)"
      
    includes:
      - "closed_reason_extraction"
      - "conditional_display logic for closed_reason"

# ============================================================================
# QUERY PATTERNS
# ============================================================================

query_patterns:

  mtd_funnel_current:
    category: "mtd_aggregate"
    description: "Current month-to-date funnel metrics with progressive day filter"
    
    user_intent_keywords:
      - "MTD funnel"
      - "month to date metrics"
      - "current month funnel"
      - "this month performance"
      
    structure: "Multiple CTEs joined on 'Metric' constant"
    
    metrics_included:
      - leads (from opportunities + enquiries)
      - prospects
      - accounts
      - sales
      - meetings
      - viewings
      - l2p_duration
      - p2a_duration
      - a2s_duration
      
    applies_date_filter: "mtd_current_progressive"
    applies_timezone: true
    applies_progressive_filter: true
    applies_slug_exclusions: true
    applies_source_exclusion: "leads only"
    applies_distinct_counting: true
    
  mtd_funnel_last_year:
    category: "mtd_aggregate"
    description: "Last year same month-to-date for YoY comparison"
    
    user_intent_keywords:
      - "last year MTD"
      - "LYTD"
      - "year over year"
      - "same period last year"
      
    structure: "Same as mtd_funnel_current but with last year dates"
    
    metrics_included:
      - "Same as mtd_funnel_current"
      
    applies_date_filter: "mtd_last_year_progressive"
    applies_timezone: true
    applies_progressive_filter: true
    applies_slug_exclusions: true
    applies_source_exclusion: "leads only"
    applies_distinct_counting: true
    reference_date: "now() - interval '1 year'"
    
  source_daily_breakdown:
    category: "source_breakdown"
    description: "Funnel metrics by source category for each day (MTD)"
    
    user_intent_keywords:
      - "breakdown by source"
      - "source wise"
      - "daily source"
      - "which sources performing"
      
    structure: "Date series x Source cross join, left join metrics, group by source"
    
    metrics_included:
      - leads
      - prospects
      - accounts
      - sales
      
    uses_special_logic: "source_daily_breakdown"
    applies_date_filter: "mtd_current_progressive"
    applies_timezone: true
    applies_progressive_filter: false
    applies_slug_exclusions: true
    applies_source_exclusion: "leads only"
    applies_source_mapping: true
    
  open_funnel_count:
    category: "open_count"
    description: "Count of open opportunities and enquiries (not closed, not trash, not sold)"
    
    user_intent_keywords:
      - "open leads"
      - "open count"
      - "active opportunities"
      - "pipeline count"
      
    structure: "UNION of opportunities + enquiries, filter-based counting"
    
    output: "Single integer (open count)"
    
    uses_special_logic: "open_funnel_count"
    applies_date_filter: "mtd_current_progressive"
    applies_timezone: true
    applies_progressive_filter: true
    applies_slug_exclusions: true
    applies_open_status_logic: true
    
  mtd_lead_details:
    category: "detail_listings"
    description: "Detailed row-level listing of all leads in current month"
    
    user_intent_keywords:
      - "lead details"
      - "list of leads"
      - "detailed report"
      - "all leads with info"
      
    structure: "UNION of opportunities + enquiries with joins to agents, staffs"
    
    aggregation: false
    row_level: true
    
    uses_special_logic: "detail_listings"
    applies_date_filter: "mtd_current_progressive"
    applies_timezone: true
    applies_progressive_filter: true
    applies_slug_exclusions: true
    
  prospect_aging:
    category: "aging_reports"
    description: "All open prospects with days since moved to prospect stage"
    
    user_intent_keywords:
      - "aging prospects"
      - "how long in prospect"
      - "oldest prospects"
      
    structure: "Single table query with aging calculation"
    
    uses_special_logic: "aging_reports.prospect_aging"
    applies_date_filter: "since_fy_2022"
    applies_timezone: true
    applies_progressive_filter: false
    applies_slug_exclusions: false
    applies_source_exclusions: false
    applies_open_status_logic: true
    test_record_exclusions: true
    
  account_aging:
    category: "aging_reports"
    description: "All open accounts with days since moved to account stage"
    
    user_intent_keywords:
      - "aging accounts"
      - "how long in account"
      - "oldest accounts"
      
    structure: "Single table query with aging calculation"
    
    uses_special_logic: "aging_reports.account_aging"
    applies_date_filter: "since_fy_2022"
    applies_timezone: true
    applies_progressive_filter: false
    applies_slug_exclusions: false
    applies_source_exclusions: false
    applies_open_status_logic: true
    test_record_exclusions: true
    
  historical_funnel_details:
    category: "historical_analysis"
    description: "Detailed records for last 12 months including closed reasons and stage transitions"
    
    user_intent_keywords:
      - "historical leads"
      - "last 12 months details"
      - "closed reason report"
      - "why leads closed"
      
    structure: "UNION of opportunities + enquiries with multiple left joins for stage history and closed reasons"
    
    uses_special_logic: "historical_details"
    applies_date_filter: "trailing_12_months"
    applies_timezone: true
    applies_progressive_filter: false
    applies_slug_exclusions: true
    applies_source_exclusion: true
    includes_stage_history: true
    includes_closed_reasons: true
    includes_maal_laao_from_tasks: true
    
  regional_closed_analysis:
    category: "historical_analysis"
    description: "Closed reasons by source region for last 12 months"
    
    user_intent_keywords:
      - "closed reasons by region"
      - "regional closure"
      - "why leads closed in south"
      
    structure: "UNION of opportunities + enquiries with closed reason conditional display"
    
    uses_special_logic: "regional_closed_analysis"
    applies_date_filter: "trailing_12_months"
    applies_timezone: true
    applies_progressive_filter: false
    applies_slug_exclusions: true
    applies_source_exclusion: true
    includes_closed_reasons: true
    includes_conditional_display: true

# ============================================================================
# ANTI-PATTERNS (What NOT to do)
# ============================================================================

anti_patterns:
  
  - pattern: "Using BETWEEN for date ranges"
    why: "BETWEEN is inclusive on both ends, we need >= and <"
    wrong: "date BETWEEN start_date AND end_date"
    correct: "(date >= start_date) AND (date < end_date)"
    
  - pattern: "Mixing timezone conversion formats in single query"
    why: "Inconsistent and confusing"
    wrong: "Using both '330 minutes' and '5 hours 30 minutes' in same query"
    correct: "Pick one format and use consistently throughout query"
    
  - pattern: "Applying slug exclusions to enquiries table"
    why: "Enquiries table doesn't contain these slugs"
    wrong: "enquiries.slug NOT IN ('569657C6',...)"
    correct: "Only apply slug exclusions to development_opportunities"
    
  - pattern: "Counting tasks for meetings/viewings"
    why: "Double counts - one opportunity can have multiple tasks"
    wrong: "COUNT(tasks.id)"
    correct: "COUNT(DISTINCT(development_opportunities.slug))"
    
  - pattern: "Using date_trunc alone for MTD filtering"
    why: "Less explicit than boundary comparisons"
    wrong: "WHERE date_trunc('month', timestamp) = date_trunc('month', CURRENT_DATE)"
    correct: "WHERE timestamp >= start_of_month AND timestamp < start_of_next_month"
    
  - pattern: "Forgetting progressive day filter for MTD queries"
    why: "Will include future days of partial month"
    wrong: "Only date range filter without day-of-month check"
    correct: "Add: date_part('day', timestamp) <= date_part('day', now())"
    
  - pattern: "Excluding DnB from all funnel stages"
    why: "Only leads should exclude DnB source"
    wrong: "Applying source != 'DnB' to prospects/accounts/sales"
    correct: "Apply source exclusion only to leads metric"
    
  - pattern: "Applying slug exclusions to aging reports"
    why: "Business wants to see ALL aging opportunities including excluded slugs"
    wrong: "slug NOT IN (...) in Query 6 & 7"
    correct: "No slug exclusions for aging reports"
    
  - pattern: "Using closed_reason field directly without extraction"
    why: "closed_reason is a JSON array, must extract value"
    wrong: "SELECT closed_reason FROM development_opportunities"
    correct: "SELECT (jsonb_array_elements(closed_reason)->>'closed_reason_value')"

# ============================================================================
# VALIDATION CHECKLIST
# ============================================================================

validation_checklist:
  description: "Verify generated query has all required business rules applied"
  
  universal_checks:
    - id: "timezone_all_timestamps"
      rule: "All timestamp columns have IST conversion"
      check: "Every timestamp reference includes '+ interval' for IST"
      applies_to: "ALL queries"
      
    - id: "date_range_format"
      rule: "Date ranges use >= and < (not BETWEEN)"
      check: "No BETWEEN clauses, using >= and < operators"
      applies_to: "ALL queries"
      
    - id: "distinct_opportunity_counts"
      rule: "Opportunity counts use DISTINCT(slug)"
      check: "All opportunity counts have COUNT(DISTINCT(slug))"
      applies_to: "ALL queries"
      
  category_specific_checks:
    
    mtd_aggregate:
      - id: "progressive_filter"
        rule: "Progressive day filter included"
        check: "date_part('day', ...) <= date_part('day', now())"
        
      - id: "slug_exclusions"
        rule: "Slug exclusions applied to opportunities"
        check: "slug NOT IN ('569657C6','5EB1A14A','075E54DF')"
        
      - id: "dnb_exclusion_leads_only"
        rule: "DnB excluded from leads only"
        check: "source != 'DnB' only in leads CTE, not in prospects/accounts/sales"
        
      - id: "meetings_distinct_opps"
        rule: "Meetings count distinct opportunities"
        check: "COUNT(DISTINCT(development_opportunities.slug)) not COUNT(tasks.id)"
        
      - id: "viewings_south_only"
        rule: "Viewings filtered to south region"
        check: "staffs.source_region = 'south' present"
        
    source_breakdown:
      - id: "source_case_statement"
        rule: "Source mapping CASE statement present"
        check: "CASE WHEN source = 'agent' THEN 'Agent' ... END"
        
      - id: "no_progressive_filter"
        rule: "No progressive day filter for source breakdown"
        check: "Should NOT have date_part('day', ...) filter"
        
    open_count:
      - id: "filter_based_counting"
        rule: "Uses FILTER(WHERE status=...) syntax"
        check: "COUNT(...) FILTER (WHERE status='closed')"
        
      - id: "union_opps_and_enquiries"
        rule: "Combines opportunities and enquiries"
        check: "UNION present with both sources"
        
      - id: "enquiry_conditions"
        rule: "Enquiries have correct filters"
        check: "vertical='development' AND enquiry_type='enquiry' AND leadable_id IS NULL"
        
    aging_reports:
      - id: "no_slug_exclusions"
        rule: "Aging reports do NOT use slug exclusions"
        check: "Should NOT contain slug NOT IN (...)"
        
      - id: "no_source_exclusions"
        rule: "Aging reports do NOT exclude DnB"
        check: "Should NOT contain source != 'DnB'"
        
      - id: "test_record_exclusions"
        rule: "Exclude test records"
        check: "LOWER(name) NOT LIKE '%test%' AND LOWER(name) != 'test'"
        
      - id: "aging_calculation"
        rule: "Aging calculated correctly"
        check: "date(now() + interval '330 minutes') - date([stage_timestamp] + interval '330 minutes')"
        
    historical_analysis:
      - id: "trailing_12_months_format"
        rule: "Uses '5 hours 30 minutes' format"
        check: "interval '5 hours 30 minutes' (not '330 minutes')"
        
      - id: "closed_reason_extraction"
        rule: "Closed reason extracted from JSON array"
        check: "jsonb_array_elements(closed_reason)->>'closed_reason_value'"
        
      - id: "closed_reason_ranking"
        rule: "Earliest closed reason selected"
        check: "RANK() OVER (... ORDER BY tasks.performed_at ASC) and ranking = 1"

# ============================================================================
# INTENT CLASSIFICATION
# ============================================================================

intent_classification:
  description: "Map user questions to query patterns"
  
  classification_workflow:
    step_1: "Extract time period keywords"
    step_2: "Extract metric keywords"
    step_3: "Extract granularity keywords"
    step_4: "Extract filter keywords"
    step_5: "Match to query pattern category"
    step_6: "Select specific pattern within category"
    
  time_period_keywords:
    mtd_current:
      keywords: ["MTD", "month to date", "this month", "current month"]
      maps_to_filter: "mtd_current_progressive"
      
    mtd_last_year:
      keywords: ["last year", "LYTD", "same period last year", "year over year", "YoY"]
      maps_to_filter: "mtd_last_year_progressive"
      
    trailing_12_months:
      keywords: ["last 12 months", "past year", "historical", "12 month"]
      maps_to_filter: "trailing_12_months"
      
    since_fy_2022:
      keywords: ["since 2022", "from 2022", "FY 2022", "financial year 2022"]
      maps_to_filter: "since_fy_2022"
      
  metric_keywords:
    funnel:
      keywords: ["funnel", "leads", "prospects", "accounts", "sales", "conversion"]
      suggests_categories: ["mtd_aggregate", "source_breakdown"]
      
    meetings:
      keywords: ["meetings", "meet", "appointments"]
      requires_pattern: ["mtd_funnel_current", "mtd_funnel_last_year"]
      
    viewings:
      keywords: ["viewings", "site visits", "property visits"]
      requires_pattern: ["mtd_funnel_current", "mtd_funnel_last_year"]
      
    duration:
      keywords: ["conversion time", "days to convert", "l2p", "p2a", "a2s", "duration"]
      requires_pattern: ["mtd_funnel_current", "mtd_funnel_last_year"]
      
  granularity_keywords:
    aggregate:
      keywords: ["total", "overall", "summary", "count", "how many"]
      suggests_categories: ["mtd_aggregate"]
      
    by_source:
      keywords: ["by source", "source wise", "which source", "source breakdown"]
      suggests_categories: ["source_breakdown"]
      
    detail:
      keywords: ["details", "list", "all leads", "show me", "breakdown", "record level"]
      suggests_categories: ["detail_listings", "historical_analysis"]
      
  filter_keywords:
    open:
      keywords: ["open", "active", "not closed", "pipeline"]
      suggests_categories: ["open_count", "aging_reports"]
      
    closed:
      keywords: ["closed", "lost", "why closed", "closed reason"]
      suggests_categories: ["historical_analysis"]
      
    aging:
      keywords: ["aging", "old", "longest", "time in stage", "days in"]
      suggests_categories: ["aging_reports"]
      
    region:
      keywords: ["by region", "south", "north", "regional", "region wise"]
      suggests_pattern: ["regional_closed_analysis"]

# ============================================================================
# METADATA
# ============================================================================

metadata:
  version: "2.0.0"
  last_updated: "2024-12-08"
  
  change_log:
    - version: "2.0.0"
      date: "2024-12-08"
      changes:
        - "Fixed applies_to references - removed 'Query 1-9' references"
        - "Added query_categories section"
        - "Changed all applies_to to use category names"
        - "Verified all business rules against original 9 queries"
        - "Added special_patterns section for complex query logic"
        - "Enhanced validation_checklist with category-specific checks"
        - "Added notes for exceptions (aging reports, historical queries)"
        
  verification_notes:
    - "Query 1 & 2: mtd_aggregate with all funnel metrics + meetings + viewings + durations"
    - "Query 3: source_breakdown with special date series logic"
    - "Query 4: open_count with filter-based counting"
    - "Query 5: detail_listings with UNION structure"
    - "Query 6 & 7: aging_reports WITHOUT slug exclusions"
    - "Query 8 & 9: historical_analysis with '5 hours 30 minutes' format and closed reasons"
    
  dependencies:
    tables:
      - "development_opportunities"
      - "enquiries"
      - "tasks"
      - "activities"
      - "medium"
      - "staffs"
      - "agents"
      - "stage_histories"
      - "stages"
