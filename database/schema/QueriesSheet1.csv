OrderBook Actuals - Consolidated Dashboard Query,"-- Amount Wise
SELECT 
    location as ""Location"",
    SUM(CASE WHEN property_type = 'Vaddo' THEN amount_cr ELSE 0 END) as ""Vaddo_Actuals"",
    SUM(CASE WHEN property_type = 'Vaddo' THEN units_sold ELSE 0 END) as ""Vaddo_Units"",
    SUM(CASE WHEN property_type = 'Villa' THEN amount_cr ELSE 0 END) as ""Villa_Actuals"",
    SUM(CASE WHEN property_type = 'Villa' THEN units_sold ELSE 0 END) as ""Villa_Units"",
    SUM(CASE WHEN property_type = 'Estate' THEN amount_cr ELSE 0 END) as ""Estate_Actuals"",
    SUM(CASE WHEN property_type = 'Estate' THEN units_sold ELSE 0 END) as ""Estate_Units"",
    SUM(CASE WHEN property_type = 'Chapter' THEN amount_cr ELSE 0 END) as ""Chapter_Actuals"",
    SUM(CASE WHEN property_type = 'Chapter' THEN units_sold ELSE 0 END) as ""Chapter_units"",
    SUM(amount_cr) as total_amount,
    SUM(units_sold) as total_units
FROM (
    -- Isprava Data
    SELECT 
        COALESCE(l.city, 'Unclassified') as location,
        INITCAP(COALESCE(p.property_type, 'Unclassified')) as property_type,
        SUM((budget_sales_consideration)::float)/10000000 as amount_cr,
        COUNT(*) as units_sold
    FROM development_opportunity_properties op
    LEFT JOIN development_properties p ON op.development_property_id = p.id
    LEFT JOIN development_locations l ON l.id = p.development_location_id
    LEFT JOIN development_opportunities o ON op.development_opportunity_id = o.id
    WHERE p.include_in_reports = TRUE 
        AND p.deleted_at IS NULL
        AND (DATE(maal_laao_at + INTERVAL '330 minutes') BETWEEN '2025-04-01' AND DATE(NOW())
            OR o.slug = 'd-ref-a2ff7f98' OR o.slug = '7A5D8F55')
        AND p.name != 'Dattapada Estate 2'
    GROUP BY l.city, p.property_type

    UNION ALL

    -- Chapter Data (displayed as 'Chapter' property type)
    SELECT 
        COALESCE(l.city, 'Unclassified') as location,
        'Chapter' as property_type,
        SUM((budget_sales_consideration)::float)/10000000 as amount_cr,
        COUNT(*) as units_sold
    FROM chapter_opportunity_properties op
    LEFT JOIN chapter_properties p ON op.chapter_property_id = p.id
    LEFT JOIN chapter_locations l ON l.id = p.chapter_location_id
    LEFT JOIN chapter_opportunities o ON op.chapter_opportunity_id = o.id
    WHERE p.include_in_reports = TRUE 
        AND p.deleted_at IS NULL
        AND (DATE(maal_laao_at + INTERVAL '330 minutes') BETWEEN '2025-04-01' AND DATE(NOW())
            OR o.slug = 'd-ref-a2ff7f98')
        AND p.name != 'Dattapada Estate 2'
    GROUP BY l.city
) combined
GROUP BY location
ORDER BY location;"
 Scorecard - Consolidated Dashboard Query,"-- Scorecard Consolidated Data

WITH isprava_base_data AS (
    -- Get all properties
    SELECT p.name as property
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    WHERE p.include_in_reports = TRUE
      AND backed_out_at IS NULL
),

-- LAST YEAR (LYTD) BUDGETED - Construction Linked
lytd_construction AS (
    SELECT 
        p.name as property,
        SUM((dt.breakdown->>'base_amount')::float) as budget_amount
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    INNER JOIN development_locations l ON l.id = p.development_location_id
    INNER JOIN development_opportunities o ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_phase_details phd ON dt.development_delivery_timeline_phase_detail_id = phd.id
    INNER JOIN development_delivery_timeline_phases ph ON dt.development_delivery_timeline_phase_id = ph.id
    LEFT JOIN staffs ON staffs.id = o.post_sales_exec_id
    LEFT JOIN development_opportunity_property_bank_accounts opba ON
        opba.development_opportunity_property_id = op.id
        AND opba.development_delivery_timeline_phase_id = dt.development_delivery_timeline_phase_id
        AND opba.account_type = 'base'
    LEFT JOIN development_bank_accounts ON opba.development_bank_account_id = development_bank_accounts.id
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL
      AND phd.is_construction_linked = TRUE
      AND development_bank_accounts.is_subsidiary = TRUE
      AND dt.ops_actual_date <= '2025-02-28'
    GROUP BY p.name
),

-- LAST YEAR (LYTD) BUDGETED - Construction Linked (FOR REVISED CALCULATION)
lytd_construction_revised AS (
    SELECT 
        p.name as property,
        SUM((dt.breakdown->>'base_amount')::float) as budget_amount
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    INNER JOIN development_locations l ON l.id = p.development_location_id
    INNER JOIN development_opportunities o ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_phase_details phd ON dt.development_delivery_timeline_phase_detail_id = phd.id
    INNER JOIN development_delivery_timeline_phases ph ON dt.development_delivery_timeline_phase_id = ph.id
    LEFT JOIN staffs ON staffs.id = o.post_sales_exec_id
    LEFT JOIN development_opportunity_property_bank_accounts opba ON
        opba.development_opportunity_property_id = op.id
        AND opba.development_delivery_timeline_phase_id = dt.development_delivery_timeline_phase_id
        AND opba.account_type = 'base'
    LEFT JOIN development_bank_accounts ON opba.development_bank_account_id = development_bank_accounts.id
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL
      AND phd.is_construction_linked = TRUE
      AND development_bank_accounts.is_subsidiary = TRUE
      AND dt.ops_actual_date IS NOT NULL  -- Must have ops_actual_date
      AND CASE 
            WHEN dt.client_communication_date > dt.ops_actual_date
            THEN dt.client_communication_date
            ELSE dt.ops_actual_date
          END <= DATE '2025-02-28'
    GROUP BY p.name
),

-- LAST YEAR (LYTD) BUDGETED - Payment Linked
lytd_payment AS (
    SELECT 
        p.name as property,
        SUM(
                    CASE 
                        WHEN phd.step = 'Excess collection'
                        THEN (-1) * COALESCE((dt.breakdown->>'base_amount')::float, 0)
                        ELSE COALESCE((dt.breakdown->>'base_amount')::float, 0)
                    END
                ) as budget_amount
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    INNER JOIN development_locations l ON l.id = p.development_location_id
    INNER JOIN development_opportunities o ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_phase_details phd ON dt.development_delivery_timeline_phase_detail_id = phd.id
    INNER JOIN development_delivery_timeline_phases ph ON dt.development_delivery_timeline_phase_id = ph.id
    LEFT JOIN staffs ON staffs.id = o.post_sales_exec_id
    LEFT JOIN development_opportunity_property_bank_accounts opba ON
        opba.development_opportunity_property_id = op.id
        AND opba.development_delivery_timeline_phase_id = dt.development_delivery_timeline_phase_id
        AND opba.account_type = 'base'
    LEFT JOIN development_bank_accounts ON opba.development_bank_account_id = development_bank_accounts.id
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL
      AND development_bank_accounts.is_subsidiary = TRUE
      AND dt.client_communication_date <= DATE '2025-02-28'
      AND CASE 
            WHEN ph.sub_phase = 'additional' AND development_bank_accounts.is_subsidiary = TRUE THEN FALSE
            ELSE phd.is_construction_linked
          END = FALSE
    GROUP BY p.name
),

-- LAST YEAR (LYTD) ACTUALS - Collected
lytd_collected AS (
    SELECT 
        p.name as property,
        SUM((t.breakdown->>'base_amount')::float) as collected_amount
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    INNER JOIN development_opportunities o ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_details t ON dt.id = t.development_delivery_timeline_id
    LEFT JOIN development_delivery_timeline_phase_details phd ON dt.development_delivery_timeline_phase_detail_id = phd.id
    LEFT JOIN development_bank_accounts ON development_bank_accounts.id = 
        CASE WHEN t.account_type ~ '^[0-9]+$' THEN t.account_type::int ELSE NULL END
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL 
      AND t.deleted_at IS NULL
      AND p.active = TRUE
      AND development_bank_accounts.is_subsidiary = TRUE
      AND t.transaction_type = 'collection'
      AND t.payment_date <= DATE '2025-03-31'
    GROUP BY p.name
),

-- LAST YEAR (LYTD) ACTUALS - Refunds
lytd_refunds AS (
    SELECT 
        p.name as property,
    SUM (
    		CASE 
    		WHEN t.transaction_type = 'refund'
    		THEN (-1) * COALESCE((t.breakdown->>'base_amount')::float,0) 
    		ELSE COALESCE((t.breakdown->>'base_amount')::float,0)
    		END 
    ) as refund_amount
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    INNER JOIN development_opportunities o ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_details t ON dt.id = t.development_delivery_timeline_id
    LEFT JOIN development_bank_accounts ON development_bank_accounts.id = 
        CASE WHEN t.account_type ~ '^[0-9]+$' THEN t.account_type::int ELSE NULL END
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL 
      AND t.deleted_at IS NULL
      AND p.active = TRUE
      AND t.transaction_type = 'refund'
      AND t.payment_date <= DATE '2025-03-31'
    GROUP BY p.name
),

-- CURRENT YEAR (YTD) BUDGETED - Construction Linked
ytd_construction AS (
    SELECT 
        p.name as property,
        SUM((dt.breakdown->>'base_amount')::float) as budget_amount
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    INNER JOIN development_locations l ON l.id = p.development_location_id
    INNER JOIN development_opportunities o ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_phase_details phd ON dt.development_delivery_timeline_phase_detail_id = phd.id
    INNER JOIN development_delivery_timeline_phases ph ON dt.development_delivery_timeline_phase_id = ph.id
    LEFT JOIN staffs ON staffs.id = o.post_sales_exec_id
    LEFT JOIN development_opportunity_property_bank_accounts opba ON
        opba.development_opportunity_property_id = op.id
        AND opba.development_delivery_timeline_phase_id = dt.development_delivery_timeline_phase_id
        AND opba.account_type = 'base'
    LEFT JOIN development_bank_accounts ON opba.development_bank_account_id = development_bank_accounts.id
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL
      AND phd.is_construction_linked = TRUE
      AND development_bank_accounts.is_subsidiary = TRUE
      AND dt.ops_actual_date BETWEEN '2025-03-01' AND date(now() + interval '330 minutes')
    GROUP BY p.name
),

ytd_construction_revised AS (
    SELECT 
        p.name as property,
        SUM((dt.breakdown->>'base_amount')::float) as budget_amount
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    INNER JOIN development_locations l ON l.id = p.development_location_id
    INNER JOIN development_opportunities o ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_phase_details phd ON dt.development_delivery_timeline_phase_detail_id = phd.id
    INNER JOIN development_delivery_timeline_phases ph ON dt.development_delivery_timeline_phase_id = ph.id
    LEFT JOIN staffs ON staffs.id = o.post_sales_exec_id
    LEFT JOIN development_opportunity_property_bank_accounts opba ON
        opba.development_opportunity_property_id = op.id
        AND opba.development_delivery_timeline_phase_id = dt.development_delivery_timeline_phase_id
        AND opba.account_type = 'base'
    LEFT JOIN development_bank_accounts ON opba.development_bank_account_id = development_bank_accounts.id
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL
      AND phd.is_construction_linked = TRUE
      AND development_bank_accounts.is_subsidiary = TRUE
      AND dt.ops_actual_date IS NOT NULL  -- Must have ops_actual_date
      AND CASE 
            WHEN dt.client_communication_date > dt.ops_actual_date
            THEN dt.client_communication_date
            ELSE dt.ops_actual_date
          END BETWEEN DATE '2025-03-01' AND DATE(now() + INTERVAL '330 minutes')
    GROUP BY p.name
),

-- CURRENT YEAR (YTD) BUDGETED - Payment Linked
ytd_payment AS (
    SELECT 
        p.name as property,
        SUM(
                    CASE 
                        WHEN phd.step = 'Excess collection'
                        THEN (-1) * COALESCE((dt.breakdown->>'base_amount')::float, 0)
                        ELSE COALESCE((dt.breakdown->>'base_amount')::float, 0)
                    END
                ) as budget_amount
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    INNER JOIN development_locations l ON l.id = p.development_location_id
    INNER JOIN development_opportunities o ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_phase_details phd ON dt.development_delivery_timeline_phase_detail_id = phd.id
    INNER JOIN development_delivery_timeline_phases ph ON dt.development_delivery_timeline_phase_id = ph.id
    LEFT JOIN staffs ON staffs.id = o.post_sales_exec_id
    LEFT JOIN development_opportunity_property_bank_accounts opba ON
        opba.development_opportunity_property_id = op.id
        AND opba.development_delivery_timeline_phase_id = dt.development_delivery_timeline_phase_id
        AND opba.account_type = 'base'
    LEFT JOIN development_bank_accounts ON opba.development_bank_account_id = development_bank_accounts.id
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL
      AND development_bank_accounts.is_subsidiary = TRUE
      AND dt.client_communication_date BETWEEN DATE '2025-03-01' AND DATE(now() + INTERVAL '330 minutes')
      AND CASE 
            WHEN ph.sub_phase = 'additional' AND development_bank_accounts.is_subsidiary = TRUE THEN FALSE
            ELSE phd.is_construction_linked
          END = FALSE
    GROUP BY p.name
),

-- CURRENT YEAR (YTD) ACTUALS - Collected
ytd_collected AS (
    SELECT 
        p.name as property,
        SUM((t.breakdown->>'base_amount')::float) as collected_amount
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    INNER JOIN development_opportunities o ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_details t ON dt.id = t.development_delivery_timeline_id
    LEFT JOIN development_delivery_timeline_phase_details phd ON dt.development_delivery_timeline_phase_detail_id = phd.id
    LEFT JOIN development_bank_accounts ON development_bank_accounts.id = 
        CASE WHEN t.account_type ~ '^[0-9]+$' THEN t.account_type::int ELSE NULL END
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL 
      AND t.deleted_at IS NULL
      AND p.active = TRUE
      AND development_bank_accounts.is_subsidiary = TRUE
      AND t.transaction_type = 'collection'
      AND t.payment_date BETWEEN DATE '2025-04-01' AND DATE(now() + INTERVAL '330 minutes')
    GROUP BY p.name
),

-- CURRENT YEAR (YTD) ACTUALS - Refunds
ytd_refunds AS (
    SELECT 
        p.name as property,
    SUM (
    		CASE 
    		WHEN t.transaction_type = 'refund'
    		THEN (-1) * COALESCE((t.breakdown->>'base_amount')::float,0) 
    		ELSE COALESCE((t.breakdown->>'base_amount')::float,0)
    		END 
    ) as refund_amount
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    INNER JOIN development_opportunities o ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_details t ON dt.id = t.development_delivery_timeline_id
    LEFT JOIN development_bank_accounts ON development_bank_accounts.id = 
        CASE WHEN t.account_type ~ '^[0-9]+$' THEN t.account_type::int ELSE NULL END
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL 
      AND t.deleted_at IS NULL
      AND p.active = TRUE
      AND t.transaction_type = 'refund'
      AND t.payment_date BETWEEN DATE '2025-04-01' AND DATE(now() + INTERVAL '330 minutes')
    GROUP BY p.name
),

-- Future Budget with Early Payments (Special Case) → used as ADVANCES
future_budget_early_payment AS (
    SELECT 
        p.name as property,
        SUM((t.breakdown->>'base_amount')::float) as early_payment_amount
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    INNER JOIN development_opportunities o ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_details t ON dt.id = t.development_delivery_timeline_id
    LEFT JOIN development_delivery_timeline_phase_details phd ON dt.development_delivery_timeline_phase_detail_id = phd.id
    INNER JOIN development_delivery_timeline_phases ph ON dt.development_delivery_timeline_phase_id = ph.id
    LEFT JOIN development_bank_accounts ON development_bank_accounts.id = 
        CASE WHEN t.account_type ~ '^[0-9]+$' THEN t.account_type::int ELSE NULL END
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL 
      AND t.deleted_at IS NULL
      AND p.active = TRUE
      AND development_bank_accounts.is_subsidiary = TRUE
      AND t.transaction_type = 'collection'
      AND t.payment_date < COALESCE(
            CASE 
                WHEN phd.is_construction_linked = TRUE THEN 
                    CASE 
                        WHEN dt.client_communication_date IS NOT NULL
                             AND (dt.ops_actual_date IS NULL OR dt.client_communication_date > dt.ops_actual_date)
                        THEN dt.client_communication_date
                        ELSE dt.ops_actual_date
                    END
                WHEN phd.is_construction_linked = FALSE THEN dt.client_communication_date
                WHEN CASE 
                        WHEN ph.sub_phase = 'additional' AND development_bank_accounts.is_subsidiary = TRUE THEN FALSE
                        ELSE phd.is_construction_linked
                     END = FALSE THEN dt.client_communication_date
                ELSE dt.ops_actual_date
            END,
            dt.ops_actual_date,
            dt.client_communication_date
        )
      AND COALESCE(
            CASE 
                WHEN phd.is_construction_linked = TRUE THEN 
                    CASE 
                        WHEN dt.client_communication_date IS NOT NULL
                             AND (dt.ops_actual_date IS NULL OR dt.client_communication_date > dt.ops_actual_date)
                        THEN dt.client_communication_date
                        ELSE dt.ops_actual_date
                    END
                WHEN phd.is_construction_linked = FALSE THEN dt.client_communication_date
                WHEN CASE 
                        WHEN ph.sub_phase = 'additional' AND development_bank_accounts.is_subsidiary = TRUE THEN FALSE
                        ELSE phd.is_construction_linked
                     END = FALSE THEN dt.client_communication_date
                ELSE dt.ops_actual_date
            END,
            dt.ops_actual_date,
            dt.client_communication_date
        ) > CURRENT_DATE
    GROUP BY p.name
),

/* -----------------------------------------------------------------
  MILESTONE-LEVEL ACTUAL_PENDING (reusing logic from previous query)
  ----------------------------------------------------------------- */

milestone_base_data AS (
    SELECT 
        o.slug,
        o.name,
        dt.id AS delivery_timeline_id,
        l.city AS location,
        DATE(o.maal_laao_at + INTERVAL '330 minutes') AS sales_date,
        p.name AS property,
        phd.step AS stage_name,
        SUM((dt.breakdown->> 'base_amount')::float) AS base_amount,
        SUM((dt.breakdown->> 'gst_amount')::float) AS gst_amount,
        SUM((dt.breakdown->> 'stamp_duty_amount')::float) AS stamp_duty_amount,
        SUM((dt.breakdown->> 'registration_amount')::float) AS registration_amount,
        SUM((dt.breakdown->> 'tds_amount')::float) AS tds_amount,
        SUM(dt.total_amount) AS total_amount,
        dt.id AS did,
        ops_budget_date,
        ops_actual_date,
        client_communication_date,
        payment_due_date,
        phd.id AS phdid,
        sub_phase,
        is_construction_linked,
        is_subsidiary,
        dt.status AS delivery_tracker_status
    FROM development_opportunity_properties op
    INNER JOIN development_properties p 
        ON op.development_property_id = p.id
    INNER JOIN development_locations l 
        ON l.id = p.development_location_id
    INNER JOIN development_opportunities o 
        ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt 
        ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_phase_details phd 
        ON dt.development_delivery_timeline_phase_detail_id = phd.id
    INNER JOIN development_delivery_timeline_phases ph 
        ON dt.development_delivery_timeline_phase_id = ph.id
    LEFT JOIN staffs 
        ON staffs.id = o.post_sales_exec_id
    LEFT JOIN development_opportunity_property_bank_accounts opba 
        ON opba.development_opportunity_property_id = op.id
      AND opba.development_delivery_timeline_phase_id = dt.development_delivery_timeline_phase_id
      AND opba.account_type = 'base'
    LEFT JOIN development_bank_accounts 
        ON opba.development_bank_account_id = development_bank_accounts.id
    WHERE 
        p.include_in_reports = TRUE 
        AND p.deleted_at IS NULL
        AND dt.deleted_at IS NULL
        AND development_bank_accounts.is_subsidiary = TRUE
        AND (
            -- Construction-linked:
            --   use ops_actual_date, but override with client_communication_date
            --   when client_communication_date > ops_actual_date
            (
                phd.is_construction_linked = TRUE
                AND DATE(
                        CASE 
                            WHEN client_communication_date IS NOT NULL
                                 AND ops_actual_date IS NOT NULL
                                 AND client_communication_date > ops_actual_date
                            THEN client_communication_date
                            ELSE ops_actual_date
                        END
                    ) <= DATE(now() + INTERVAL '330 minutes')
            )
            OR
            -- Payment-linked / NULL → use client_communication_date
            (
                phd.is_construction_linked IS DISTINCT FROM TRUE
                AND client_communication_date IS NOT NULL
                AND DATE(client_communication_date) <= DATE(now() + INTERVAL '330 minutes')
            )
        )
    GROUP BY 
        o.slug,
        o.name,
        l.city,
        DATE(o.maal_laao_at + INTERVAL '330 minutes'),
        phd.step,
        p.name,
        ops_actual_date,
        ops_budget_date,
        client_communication_date,
        dt.id,
        phd.id,
        sub_phase,
        dt.status,
        payment_due_date,
        is_construction_linked,
        is_subsidiary
),


milestone_collection_refund AS (
    SELECT 
        p.id,
        CASE WHEN transaction_type = 'collection' 
             THEN SUM((t.breakdown->> 'base_amount')::float) END AS base_amount_paid, 
        CASE WHEN transaction_type = 'refund' 
             THEN SUM((t.breakdown->> 'base_amount')::float) END AS refund_base_amount,
        t.development_delivery_timeline_id AS did,
        DATE(t.payment_date + INTERVAL '330 minutes') AS payment_date,
        DATE(t.updated_at + INTERVAL '330 minutes') AS payment_updated_at
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    INNER JOIN development_opportunities o ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_details t 
        ON dt.id = t.development_delivery_timeline_id
    WHERE p.active = TRUE
      AND dt.deleted_at IS NULL 
      AND t.deleted_at IS NULL
    GROUP BY 
        p.id,
        t.development_delivery_timeline_id,
        DATE(t.updated_at + INTERVAL '330 minutes'),
        DATE(t.payment_date + INTERVAL '330 minutes'),
        transaction_type
),

milestone_actual_pending AS (
    SELECT 
        mb.property,
        mb.delivery_timeline_id,
        mb.stage_name,
        mb.base_amount,
        SUM(COALESCE(mcr.base_amount_paid, 0)) AS base_amount_paid,
        SUM(COALESCE(mcr.refund_base_amount, 0)) AS refund_base_amount,
        CASE 
            WHEN mb.stage_name = 'Excess collection'
                THEN (-1) * COALESCE(mb.base_amount, 0)
            ELSE 
                COALESCE(mb.base_amount, 0)
                - SUM(COALESCE(mcr.base_amount_paid, 0))
                + SUM(COALESCE(mcr.refund_base_amount, 0))
        END AS actual_pending
    FROM milestone_base_data mb
    LEFT JOIN milestone_collection_refund mcr
        ON mb.did = mcr.did
    GROUP BY 
        mb.property,
        mb.delivery_timeline_id,
        mb.stage_name,
        mb.base_amount
),

property_actual_pending AS (
    SELECT 
        property,
        SUM(actual_pending) AS variance_actual_pending
    FROM milestone_actual_pending
    GROUP BY property
),

isprava_metrics as 
(
-- FINAL CALCULATION WITH SPILLOVER LOGIC AND REFUNDS
SELECT 
    bd.property,
    
    -- LYTD Columns
    COALESCE(lc.budget_amount, 0) + COALESCE(lp.budget_amount, 0) AS budgeted_lytd_plan,
    COALESCE(la.collected_amount, 0) + COALESCE(lr.refund_amount, 0) AS actuals_lytd_collected,
    COALESCE(lr.refund_amount, 0) AS actuals_lytd_refunds,

    -- revised_budget_lytd = actuals_lytd_collected
    COALESCE(la.collected_amount, 0) AS revised_budget_lytd,
    
    -- YTD Columns
    COALESCE(yc.budget_amount, 0) + COALESCE(yp.budget_amount, 0) AS budgeted_ytd_plan,
    
    -- REVISED YTD BUDGET PLAN WITH SPILLOVER (using revised CTEs)
        (
            (COALESCE(lcr.budget_amount, 0) + COALESCE(lp.budget_amount, 0))
            - COALESCE(la.collected_amount, 0)
        )
        +
        (COALESCE(ycr.budget_amount, 0) + COALESCE(yp.budget_amount, 0)) AS revised_ytd_budget_plan,
    
    -- YTD actuals
    COALESCE(ya.collected_amount, 0) AS actuals_ytd_collected,
    COALESCE(yr.refund_amount, 0) AS actuals_ytd_refunds,
    COALESCE(ya.collected_amount, 0) + COALESCE(yr.refund_amount, 0) AS net_actuals_ytd,
    
    -- VARIANCE = actual_pending - advances (early payments)
    COALESCE(pap.variance_actual_pending, 0) 
      - COALESCE(fep.early_payment_amount, 0) AS variance
FROM isprava_base_data bd
LEFT JOIN lytd_construction lc ON bd.property = lc.property
LEFT JOIN lytd_construction_revised lcr ON bd.property = lcr.property  -- NEW JOIN
LEFT JOIN lytd_payment lp ON bd.property = lp.property
LEFT JOIN lytd_collected la ON bd.property = la.property
LEFT JOIN lytd_refunds lr ON bd.property = lr.property
LEFT JOIN ytd_construction yc ON bd.property = yc.property
LEFT JOIN ytd_construction_revised ycr ON bd.property = ycr.property  -- NEW JOIN
LEFT JOIN ytd_payment yp ON bd.property = yp.property
LEFT JOIN ytd_collected ya ON bd.property = ya.property
LEFT JOIN ytd_refunds yr ON bd.property = yr.property
LEFT JOIN future_budget_early_payment fep ON bd.property = fep.property
LEFT JOIN property_actual_pending pap ON bd.property = pap.property
),

-- ==================== CHAPTER SECTION ====================

chapter_base_data AS (
    -- Get all properties
    SELECT p.name as property
    FROM chapter_opportunity_properties op
    INNER JOIN chapter_properties p ON op.chapter_property_id = p.id
    WHERE p.include_in_reports = TRUE
      AND backed_out_at IS NULL
),

-- LAST YEAR (LYTD) BUDGETED - Payment Linked
chapter_lytd_payment AS (
    SELECT 
        p.name as property,
        SUM(
                    CASE 
                        WHEN phd.step = 'Excess collection'
                        THEN (-1) * COALESCE((dt.breakdown->>'base_amount')::float, 0)
                        ELSE COALESCE((dt.breakdown->>'base_amount')::float, 0)
                    END
                ) as budget_amount
    FROM chapter_opportunity_properties op
    INNER JOIN chapter_properties p ON op.chapter_property_id = p.id
    INNER JOIN chapter_locations l ON l.id = p.chapter_location_id
    INNER JOIN chapter_opportunities o ON op.chapter_opportunity_id = o.id
    INNER JOIN chapter_delivery_timelines dt ON dt.chapter_opportunity_property_id = op.id
    LEFT JOIN chapter_delivery_timeline_phase_details phd ON dt.chapter_delivery_timeline_phase_detail_id = phd.id
    INNER JOIN chapter_delivery_timeline_phases ph ON dt.chapter_delivery_timeline_phase_id = ph.id
    LEFT JOIN staffs ON staffs.id = o.post_sales_exec_id
    LEFT JOIN chapter_opportunity_property_bank_accounts opba ON
        opba.chapter_opportunity_property_id = op.id
        AND opba.chapter_delivery_timeline_phase_id = dt.chapter_delivery_timeline_phase_id
        AND opba.account_type = 'base'
    LEFT JOIN chapter_bank_accounts ON opba.chapter_bank_account_id = chapter_bank_accounts.id
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL
      AND dt.client_communication_date <= DATE '2025-02-28'
    GROUP BY p.name
),

-- LAST YEAR (LYTD) ACTUALS - Collected
chapter_lytd_collected AS (
    SELECT 
        p.name as property,
        SUM((t.breakdown->>'base_amount')::float) as collected_amount
    FROM chapter_opportunity_properties op
    INNER JOIN chapter_properties p ON op.chapter_property_id = p.id
    INNER JOIN chapter_opportunities o ON op.chapter_opportunity_id = o.id
    INNER JOIN chapter_delivery_timelines dt ON dt.chapter_opportunity_property_id = op.id
    LEFT JOIN chapter_delivery_timeline_details t ON dt.id = t.chapter_delivery_timeline_id
    LEFT JOIN chapter_delivery_timeline_phase_details phd ON dt.chapter_delivery_timeline_phase_detail_id = phd.id
    LEFT JOIN chapter_bank_accounts ON chapter_bank_accounts.id = 
        CASE WHEN t.account_type ~ '^[0-9]+$' THEN t.account_type::int ELSE NULL END
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL 
      AND t.deleted_at IS NULL
      AND p.active = TRUE
      AND t.transaction_type = 'collection'
      AND t.payment_date <= DATE '2025-03-31'
    GROUP BY p.name
),

-- LAST YEAR (LYTD) ACTUALS - Refunds
chapter_lytd_refunds AS (
    SELECT 
        p.name as property,
    SUM (
    		CASE 
    		WHEN t.transaction_type = 'refund'
    		THEN (-1) * COALESCE((t.breakdown->>'base_amount')::float,0) 
    		ELSE COALESCE((t.breakdown->>'base_amount')::float,0)
    		END 
    ) as refund_amount
    FROM chapter_opportunity_properties op
    INNER JOIN chapter_properties p ON op.chapter_property_id = p.id
    INNER JOIN chapter_opportunities o ON op.chapter_opportunity_id = o.id
    INNER JOIN chapter_delivery_timelines dt ON dt.chapter_opportunity_property_id = op.id
    LEFT JOIN chapter_delivery_timeline_details t ON dt.id = t.chapter_delivery_timeline_id
    LEFT JOIN chapter_bank_accounts ON chapter_bank_accounts.id = 
        CASE WHEN t.account_type ~ '^[0-9]+$' THEN t.account_type::int ELSE NULL END
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL 
      AND t.deleted_at IS NULL
      AND p.active = TRUE
      AND t.transaction_type = 'refund'
      AND t.payment_date <= DATE '2025-03-31'
    GROUP BY p.name
),

-- CURRENT YEAR (YTD) BUDGETED - Payment Linked
chapter_ytd_payment AS (
    SELECT 
        p.name as property,
        SUM(
                    CASE 
                        WHEN phd.step = 'Excess collection'
                        THEN (-1) * COALESCE((dt.breakdown->>'base_amount')::float, 0)
                        ELSE COALESCE((dt.breakdown->>'base_amount')::float, 0)
                    END
                ) as budget_amount
    FROM chapter_opportunity_properties op
    INNER JOIN chapter_properties p ON op.chapter_property_id = p.id
    INNER JOIN chapter_locations l ON l.id = p.chapter_location_id
    INNER JOIN chapter_opportunities o ON op.chapter_opportunity_id = o.id
    INNER JOIN chapter_delivery_timelines dt ON dt.chapter_opportunity_property_id = op.id
    LEFT JOIN chapter_delivery_timeline_phase_details phd ON dt.chapter_delivery_timeline_phase_detail_id = phd.id
    INNER JOIN chapter_delivery_timeline_phases ph ON dt.chapter_delivery_timeline_phase_id = ph.id
    LEFT JOIN staffs ON staffs.id = o.post_sales_exec_id
    LEFT JOIN chapter_opportunity_property_bank_accounts opba ON
        opba.chapter_opportunity_property_id = op.id
        AND opba.chapter_delivery_timeline_phase_id = dt.chapter_delivery_timeline_phase_id
        AND opba.account_type = 'base'
    LEFT JOIN chapter_bank_accounts ON opba.chapter_bank_account_id = chapter_bank_accounts.id
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL
      AND dt.client_communication_date BETWEEN DATE '2025-03-01' AND DATE(now() + INTERVAL '330 minutes')
    GROUP BY p.name
),

-- CURRENT YEAR (YTD) ACTUALS - Collected
chapter_ytd_collected AS (
    SELECT 
        p.name as property,
        SUM((t.breakdown->>'base_amount')::float) as collected_amount
    FROM chapter_opportunity_properties op
    INNER JOIN chapter_properties p ON op.chapter_property_id = p.id
    INNER JOIN chapter_opportunities o ON op.chapter_opportunity_id = o.id
    INNER JOIN chapter_delivery_timelines dt ON dt.chapter_opportunity_property_id = op.id
    LEFT JOIN chapter_delivery_timeline_details t ON dt.id = t.chapter_delivery_timeline_id
    LEFT JOIN chapter_delivery_timeline_phase_details phd ON dt.chapter_delivery_timeline_phase_detail_id = phd.id
    LEFT JOIN chapter_bank_accounts ON chapter_bank_accounts.id = 
        CASE WHEN t.account_type ~ '^[0-9]+$' THEN t.account_type::int ELSE NULL END
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL 
      AND t.deleted_at IS NULL
      AND p.active = TRUE
      AND t.transaction_type = 'collection'
      AND t.payment_date BETWEEN DATE '2025-04-01' AND DATE(now() + INTERVAL '330 minutes')
    GROUP BY p.name
),

-- CURRENT YEAR (YTD) ACTUALS - Refunds
chapter_ytd_refunds AS (
    SELECT 
        p.name as property,
    SUM (
    		CASE 
    		WHEN t.transaction_type = 'refund'
    		THEN (-1) * COALESCE((t.breakdown->>'base_amount')::float,0) 
    		ELSE COALESCE((t.breakdown->>'base_amount')::float,0)
    		END 
    ) as refund_amount
    FROM chapter_opportunity_properties op
    INNER JOIN chapter_properties p ON op.chapter_property_id = p.id
    INNER JOIN chapter_opportunities o ON op.chapter_opportunity_id = o.id
    INNER JOIN chapter_delivery_timelines dt ON dt.chapter_opportunity_property_id = op.id
    LEFT JOIN chapter_delivery_timeline_details t ON dt.id = t.chapter_delivery_timeline_id
    LEFT JOIN chapter_bank_accounts ON chapter_bank_accounts.id = 
        CASE WHEN t.account_type ~ '^[0-9]+$' THEN t.account_type::int ELSE NULL END
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL 
      AND t.deleted_at IS NULL
      AND p.active = TRUE
      AND t.transaction_type = 'refund'
      AND t.payment_date BETWEEN DATE '2025-04-01' AND DATE(now() + INTERVAL '330 minutes')
    GROUP BY p.name
),

-- Future Budget with Early Payments (Special Case) → used as ADVANCES
chapter_future_budget_early_payment AS (
    SELECT 
        p.name as property,
        SUM((t.breakdown->>'base_amount')::float) as early_payment_amount
    FROM chapter_opportunity_properties op
    INNER JOIN chapter_properties p ON op.chapter_property_id = p.id
    INNER JOIN chapter_opportunities o ON op.chapter_opportunity_id = o.id
    INNER JOIN chapter_delivery_timelines dt ON dt.chapter_opportunity_property_id = op.id
    LEFT JOIN chapter_delivery_timeline_details t ON dt.id = t.chapter_delivery_timeline_id
    LEFT JOIN chapter_delivery_timeline_phase_details phd ON dt.chapter_delivery_timeline_phase_detail_id = phd.id
    INNER JOIN chapter_delivery_timeline_phases ph ON dt.chapter_delivery_timeline_phase_id = ph.id
    LEFT JOIN chapter_bank_accounts ON chapter_bank_accounts.id = 
        CASE WHEN t.account_type ~ '^[0-9]+$' THEN t.account_type::int ELSE NULL END
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL 
      AND t.deleted_at IS NULL
      AND p.active = TRUE
      AND t.transaction_type = 'collection'
      AND t.payment_date < (dt.client_communication_date)
      AND dt.client_communication_date > CURRENT_DATE
    GROUP BY p.name
),

/* -----------------------------------------------------------------
  MILESTONE-LEVEL ACTUAL_PENDING (reusing logic from previous query)
  ----------------------------------------------------------------- */

chapter_milestone_base_data AS (
    SELECT 
        o.slug,
        o.name,
        dt.id AS delivery_timeline_id,
        l.city AS location,
        DATE(o.maal_laao_at + INTERVAL '330 minutes') AS sales_date,
        p.name AS property,
        phd.step AS stage_name,
        SUM((dt.breakdown->> 'base_amount')::float) AS base_amount,
        SUM((dt.breakdown->> 'gst_amount')::float) AS gst_amount,
        SUM((dt.breakdown->> 'stamp_duty_amount')::float) AS stamp_duty_amount,
        SUM((dt.breakdown->> 'registration_amount')::float) AS registration_amount,
        SUM((dt.breakdown->> 'tds_amount')::float) AS tds_amount,
        SUM(dt.total_amount) AS total_amount,
        dt.id AS did,
        ops_budget_date,
        ops_actual_date,
        client_communication_date,
        payment_due_date,
        phd.id AS phdid,
        sub_phase,
        is_construction_linked,
        is_subsidiary,
        dt.status AS delivery_tracker_status
    FROM chapter_opportunity_properties op
    INNER JOIN chapter_properties p 
        ON op.chapter_property_id = p.id
    INNER JOIN chapter_locations l 
        ON l.id = p.chapter_location_id
    INNER JOIN chapter_opportunities o 
        ON op.chapter_opportunity_id = o.id
    INNER JOIN chapter_delivery_timelines dt 
        ON dt.chapter_opportunity_property_id = op.id
    LEFT JOIN chapter_delivery_timeline_phase_details phd 
        ON dt.chapter_delivery_timeline_phase_detail_id = phd.id
    INNER JOIN chapter_delivery_timeline_phases ph 
        ON dt.chapter_delivery_timeline_phase_id = ph.id
    LEFT JOIN staffs 
        ON staffs.id = o.post_sales_exec_id
    LEFT JOIN chapter_opportunity_property_bank_accounts opba 
        ON opba.chapter_opportunity_property_id = op.id
      AND opba.chapter_delivery_timeline_phase_id = dt.chapter_delivery_timeline_phase_id
      AND opba.account_type = 'base'
    LEFT JOIN chapter_bank_accounts 
        ON opba.chapter_bank_account_id = chapter_bank_accounts.id
    WHERE 
        p.include_in_reports = TRUE 
        AND p.deleted_at IS NULL
        AND dt.deleted_at IS NULL
        AND DATE(client_communication_date) <= DATE(now() + INTERVAL '330 minutes')
    GROUP BY 
        o.slug,
        o.name,
        l.city,
        DATE(o.maal_laao_at + INTERVAL '330 minutes'),
        phd.step,
        p.name,
        ops_actual_date,
        ops_budget_date,
        client_communication_date,
        dt.id,
        phd.id,
        sub_phase,
        dt.status,
        payment_due_date,
        is_construction_linked,
        is_subsidiary
),


chapter_milestone_collection_refund AS (
    SELECT 
        p.id,
        CASE WHEN transaction_type = 'collection' 
             THEN SUM((t.breakdown->> 'base_amount')::float) END AS base_amount_paid, 
        CASE WHEN transaction_type = 'refund' 
             THEN SUM((t.breakdown->> 'base_amount')::float) END AS refund_base_amount,
        t.chapter_delivery_timeline_id AS did,
        DATE(t.payment_date + INTERVAL '330 minutes') AS payment_date,
        DATE(t.updated_at + INTERVAL '330 minutes') AS payment_updated_at
    FROM chapter_opportunity_properties op
    INNER JOIN chapter_properties p ON op.chapter_property_id = p.id
    INNER JOIN chapter_opportunities o ON op.chapter_opportunity_id = o.id
    INNER JOIN chapter_delivery_timelines dt ON dt.chapter_opportunity_property_id = op.id
    LEFT JOIN chapter_delivery_timeline_details t 
        ON dt.id = t.chapter_delivery_timeline_id
    WHERE p.active = TRUE
      AND dt.deleted_at IS NULL 
      AND t.deleted_at IS NULL
    GROUP BY 
        p.id,
        t.chapter_delivery_timeline_id,
        DATE(t.updated_at + INTERVAL '330 minutes'),
        DATE(t.payment_date + INTERVAL '330 minutes'),
        transaction_type
),

chapter_milestone_actual_pending AS (
    SELECT 
        mb.property,
        mb.delivery_timeline_id,
        mb.stage_name,
        mb.base_amount,
        SUM(COALESCE(mcr.base_amount_paid, 0)) AS base_amount_paid,
        SUM(COALESCE(mcr.refund_base_amount, 0)) AS refund_base_amount,
        CASE 
            WHEN mb.stage_name = 'Excess collection'
                THEN (-1) * COALESCE(mb.base_amount, 0)
            ELSE 
                COALESCE(mb.base_amount, 0)
                - SUM(COALESCE(mcr.base_amount_paid, 0))
                + SUM(COALESCE(mcr.refund_base_amount, 0))
        END AS actual_pending
    FROM chapter_milestone_base_data mb
    LEFT JOIN chapter_milestone_collection_refund mcr
        ON mb.did = mcr.did
    GROUP BY 
        mb.property,
        mb.delivery_timeline_id,
        mb.stage_name,
        mb.base_amount
),

chapter_property_actual_pending AS (
    SELECT 
        property,
        SUM(actual_pending) AS variance_actual_pending
    FROM chapter_milestone_actual_pending
    GROUP BY property
),

chapter_metrics AS 
(
-- FINAL CALCULATION WITH SPILLOVER LOGIC AND REFUNDS
SELECT 
    bd.property,
    
    -- LYTD Columns
    COALESCE(lp.budget_amount, 0) AS budgeted_lytd_plan,
    COALESCE(la.collected_amount, 0) AS actuals_lytd_collected,
    COALESCE(lr.refund_amount, 0) AS actuals_lytd_refunds,

    -- revised_budget_lytd = actuals_lytd_collected
    COALESCE(la.collected_amount, 0) AS revised_budget_lytd,
    
    -- YTD Columns
    COALESCE(yp.budget_amount, 0) AS budgeted_ytd_plan,
    
    -- REVISED YTD BUDGET PLAN WITH SPILLOVER
 (COALESCE(lp.budget_amount, 0) - COALESCE(la.collected_amount, 0))
        + COALESCE(yp.budget_amount, 0)AS revised_ytd_budget_plan,
    
    -- YTD actuals
    COALESCE(ya.collected_amount, 0) AS actuals_ytd_collected,
    COALESCE(yr.refund_amount, 0) AS actuals_ytd_refunds,
    COALESCE(ya.collected_amount, 0) + COALESCE(yr.refund_amount, 0) AS net_actuals_ytd,
    
    -- VARIANCE = actual_pending - advances (early payments)
    COALESCE(pap.variance_actual_pending, 0)
      - COALESCE(fep.early_payment_amount, 0) AS variance

FROM chapter_base_data bd
LEFT JOIN chapter_lytd_payment lp ON bd.property = lp.property
LEFT JOIN chapter_lytd_collected la ON bd.property = la.property
LEFT JOIN chapter_lytd_refunds lr ON bd.property = lr.property
LEFT JOIN chapter_ytd_payment yp ON bd.property = yp.property
LEFT JOIN chapter_ytd_collected ya ON bd.property = ya.property
LEFT JOIN chapter_ytd_refunds yr ON bd.property = yr.property
LEFT JOIN chapter_future_budget_early_payment fep ON bd.property = fep.property
LEFT JOIN chapter_property_actual_pending pap ON bd.property = pap.property
),

combined_union AS (
  -- union all the metric rows from both sources
  SELECT 
      property,
      budgeted_ytd_plan, revised_ytd_budget_plan, net_actuals_ytd, variance, actuals_ytd_refunds
  FROM isprava_metrics
  UNION ALL
  SELECT 
    property,
    budgeted_ytd_plan, revised_ytd_budget_plan, net_actuals_ytd, variance, actuals_ytd_refunds
  FROM chapter_metrics
)

SELECT
    property,
    COALESCE(SUM(budgeted_ytd_plan),0)          AS ytd_planned_budget,
    COALESCE(SUM(revised_ytd_budget_plan),0)    AS normalised_budget,
    COALESCE(SUM(net_actuals_ytd),0)            AS collections,
    COALESCE(SUM(variance),0)                   AS variance,
    COALESCE(SUM(actuals_ytd_refunds),0)        AS ytd_refunds
FROM combined_union
GROUP BY combined_union.property
ORDER BY property;
"
Collection Summary - Consolidated Dashboard Query,"-- Scorecard Consolidated Data

WITH isprava_base_data AS (
    -- Get all properties
    SELECT p.name as property
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    WHERE p.include_in_reports = TRUE
      AND backed_out_at IS NULL
            AND p.name != 'Moira Vaddo F (West)'
),

-- LAST YEAR (LYTD) BUDGETED - Construction Linked
lytd_construction AS (
    SELECT 
        p.name as property,
        SUM((dt.breakdown->>'base_amount')::float) as budget_amount
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    INNER JOIN development_locations l ON l.id = p.development_location_id
    INNER JOIN development_opportunities o ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_phase_details phd ON dt.development_delivery_timeline_phase_detail_id = phd.id
    INNER JOIN development_delivery_timeline_phases ph ON dt.development_delivery_timeline_phase_id = ph.id
    LEFT JOIN staffs ON staffs.id = o.post_sales_exec_id
    LEFT JOIN development_opportunity_property_bank_accounts opba ON
        opba.development_opportunity_property_id = op.id
        AND opba.development_delivery_timeline_phase_id = dt.development_delivery_timeline_phase_id
        AND opba.account_type = 'base'
    LEFT JOIN development_bank_accounts ON opba.development_bank_account_id = development_bank_accounts.id
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL
      AND phd.is_construction_linked = TRUE
      AND development_bank_accounts.is_subsidiary = TRUE
      AND dt.ops_actual_date <= '2025-02-28'
    GROUP BY p.name
),

-- LAST YEAR (LYTD) BUDGETED - Construction Linked (FOR REVISED CALCULATION)
lytd_construction_revised AS (
    SELECT 
        p.name as property,
        SUM((dt.breakdown->>'base_amount')::float) as budget_amount
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    INNER JOIN development_locations l ON l.id = p.development_location_id
    INNER JOIN development_opportunities o ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_phase_details phd ON dt.development_delivery_timeline_phase_detail_id = phd.id
    INNER JOIN development_delivery_timeline_phases ph ON dt.development_delivery_timeline_phase_id = ph.id
    LEFT JOIN staffs ON staffs.id = o.post_sales_exec_id
    LEFT JOIN development_opportunity_property_bank_accounts opba ON
        opba.development_opportunity_property_id = op.id
        AND opba.development_delivery_timeline_phase_id = dt.development_delivery_timeline_phase_id
        AND opba.account_type = 'base'
    LEFT JOIN development_bank_accounts ON opba.development_bank_account_id = development_bank_accounts.id
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL
      AND phd.is_construction_linked = TRUE
      AND development_bank_accounts.is_subsidiary = TRUE
      AND dt.ops_actual_date IS NOT NULL  -- Must have ops_actual_date
      AND CASE 
            WHEN dt.client_communication_date > dt.ops_actual_date
            THEN dt.client_communication_date
            ELSE dt.ops_actual_date
          END <= DATE '2025-02-28'
    GROUP BY p.name
),

-- LAST YEAR (LYTD) BUDGETED - Payment Linked
lytd_payment AS (
    SELECT 
        p.name as property,
        SUM(
                    CASE 
                        WHEN phd.step = 'Excess collection'
                        THEN (-1) * COALESCE((dt.breakdown->>'base_amount')::float, 0)
                        ELSE COALESCE((dt.breakdown->>'base_amount')::float, 0)
                    END
                ) as budget_amount
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    INNER JOIN development_locations l ON l.id = p.development_location_id
    INNER JOIN development_opportunities o ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_phase_details phd ON dt.development_delivery_timeline_phase_detail_id = phd.id
    INNER JOIN development_delivery_timeline_phases ph ON dt.development_delivery_timeline_phase_id = ph.id
    LEFT JOIN staffs ON staffs.id = o.post_sales_exec_id
    LEFT JOIN development_opportunity_property_bank_accounts opba ON
        opba.development_opportunity_property_id = op.id
        AND opba.development_delivery_timeline_phase_id = dt.development_delivery_timeline_phase_id
        AND opba.account_type = 'base'
    LEFT JOIN development_bank_accounts ON opba.development_bank_account_id = development_bank_accounts.id
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL
      AND development_bank_accounts.is_subsidiary = TRUE
      AND dt.client_communication_date <= DATE '2025-02-28'
      AND CASE 
            WHEN ph.sub_phase = 'additional' AND development_bank_accounts.is_subsidiary = TRUE THEN FALSE
            ELSE phd.is_construction_linked
          END = FALSE
    GROUP BY p.name
),

-- LAST YEAR (LYTD) ACTUALS - Collected
lytd_collected AS (
    SELECT 
        p.name as property,
        SUM((t.breakdown->>'base_amount')::float) as collected_amount
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    INNER JOIN development_opportunities o ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_details t ON dt.id = t.development_delivery_timeline_id
    LEFT JOIN development_delivery_timeline_phase_details phd ON dt.development_delivery_timeline_phase_detail_id = phd.id
    LEFT JOIN development_bank_accounts ON development_bank_accounts.id = 
        CASE WHEN t.account_type ~ '^[0-9]+$' THEN t.account_type::int ELSE NULL END
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL 
      AND t.deleted_at IS NULL
      AND p.active = TRUE
      AND development_bank_accounts.is_subsidiary = TRUE
      AND t.transaction_type = 'collection'
      AND t.payment_date <= DATE '2025-03-31'
    GROUP BY p.name
),

-- LAST YEAR (LYTD) ACTUALS - Refunds
lytd_refunds AS (
    SELECT 
        p.name as property,
    SUM (
    		CASE 
    		WHEN t.transaction_type = 'refund'
    		THEN (-1) * COALESCE((t.breakdown->>'base_amount')::float,0) 
    		ELSE COALESCE((t.breakdown->>'base_amount')::float,0)
    		END 
    ) as refund_amount
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    INNER JOIN development_opportunities o ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_details t ON dt.id = t.development_delivery_timeline_id
    LEFT JOIN development_bank_accounts ON development_bank_accounts.id = 
        CASE WHEN t.account_type ~ '^[0-9]+$' THEN t.account_type::int ELSE NULL END
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL 
      AND t.deleted_at IS NULL
      AND p.active = TRUE
      AND t.transaction_type = 'refund'
      AND t.payment_date <= DATE '2025-03-31'
    GROUP BY p.name
),

-- CURRENT YEAR (YTD) BUDGETED - Construction Linked
ytd_construction AS (
    SELECT 
        p.name as property,
        SUM((dt.breakdown->>'base_amount')::float) as budget_amount
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    INNER JOIN development_locations l ON l.id = p.development_location_id
    INNER JOIN development_opportunities o ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_phase_details phd ON dt.development_delivery_timeline_phase_detail_id = phd.id
    INNER JOIN development_delivery_timeline_phases ph ON dt.development_delivery_timeline_phase_id = ph.id
    LEFT JOIN staffs ON staffs.id = o.post_sales_exec_id
    LEFT JOIN development_opportunity_property_bank_accounts opba ON
        opba.development_opportunity_property_id = op.id
        AND opba.development_delivery_timeline_phase_id = dt.development_delivery_timeline_phase_id
        AND opba.account_type = 'base'
    LEFT JOIN development_bank_accounts ON opba.development_bank_account_id = development_bank_accounts.id
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL
      AND phd.is_construction_linked = TRUE
      AND development_bank_accounts.is_subsidiary = TRUE
      AND dt.ops_actual_date BETWEEN '2025-03-01' AND date(now() + interval '330 minutes')
    GROUP BY p.name
),

ytd_construction_revised AS (
    SELECT 
        p.name as property,
        SUM((dt.breakdown->>'base_amount')::float) as budget_amount
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    INNER JOIN development_locations l ON l.id = p.development_location_id
    INNER JOIN development_opportunities o ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_phase_details phd ON dt.development_delivery_timeline_phase_detail_id = phd.id
    INNER JOIN development_delivery_timeline_phases ph ON dt.development_delivery_timeline_phase_id = ph.id
    LEFT JOIN staffs ON staffs.id = o.post_sales_exec_id
    LEFT JOIN development_opportunity_property_bank_accounts opba ON
        opba.development_opportunity_property_id = op.id
        AND opba.development_delivery_timeline_phase_id = dt.development_delivery_timeline_phase_id
        AND opba.account_type = 'base'
    LEFT JOIN development_bank_accounts ON opba.development_bank_account_id = development_bank_accounts.id
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL
      AND phd.is_construction_linked = TRUE
      AND development_bank_accounts.is_subsidiary = TRUE
      AND dt.ops_actual_date IS NOT NULL  -- Must have ops_actual_date
      AND CASE 
            WHEN dt.client_communication_date > dt.ops_actual_date
            THEN dt.client_communication_date
            ELSE dt.ops_actual_date
          END BETWEEN DATE '2025-03-01' AND DATE(now() + INTERVAL '330 minutes')
    GROUP BY p.name
),

-- CURRENT YEAR (YTD) BUDGETED - Payment Linked
ytd_payment AS (
    SELECT 
        p.name as property,
        SUM(
                    CASE 
                        WHEN phd.step = 'Excess collection'
                        THEN (-1) * COALESCE((dt.breakdown->>'base_amount')::float, 0)
                        ELSE COALESCE((dt.breakdown->>'base_amount')::float, 0)
                    END
                ) as budget_amount
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    INNER JOIN development_locations l ON l.id = p.development_location_id
    INNER JOIN development_opportunities o ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_phase_details phd ON dt.development_delivery_timeline_phase_detail_id = phd.id
    INNER JOIN development_delivery_timeline_phases ph ON dt.development_delivery_timeline_phase_id = ph.id
    LEFT JOIN staffs ON staffs.id = o.post_sales_exec_id
    LEFT JOIN development_opportunity_property_bank_accounts opba ON
        opba.development_opportunity_property_id = op.id
        AND opba.development_delivery_timeline_phase_id = dt.development_delivery_timeline_phase_id
        AND opba.account_type = 'base'
    LEFT JOIN development_bank_accounts ON opba.development_bank_account_id = development_bank_accounts.id
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL
      AND development_bank_accounts.is_subsidiary = TRUE
      AND dt.client_communication_date BETWEEN DATE '2025-03-01' AND DATE(now() + INTERVAL '330 minutes')
      AND CASE 
            WHEN ph.sub_phase = 'additional' AND development_bank_accounts.is_subsidiary = TRUE THEN FALSE
            ELSE phd.is_construction_linked
          END = FALSE
    GROUP BY p.name
),

-- CURRENT YEAR (YTD) ACTUALS - Collected
ytd_collected AS (
    SELECT 
        p.name as property,
        SUM((t.breakdown->>'base_amount')::float) as collected_amount
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    INNER JOIN development_opportunities o ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_details t ON dt.id = t.development_delivery_timeline_id
    LEFT JOIN development_delivery_timeline_phase_details phd ON dt.development_delivery_timeline_phase_detail_id = phd.id
    LEFT JOIN development_bank_accounts ON development_bank_accounts.id = 
        CASE WHEN t.account_type ~ '^[0-9]+$' THEN t.account_type::int ELSE NULL END
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL 
      AND t.deleted_at IS NULL
      AND p.active = TRUE
      AND development_bank_accounts.is_subsidiary = TRUE
      AND t.transaction_type = 'collection'
      AND t.payment_date BETWEEN DATE '2025-04-01' AND DATE(now() + INTERVAL '330 minutes')
    GROUP BY p.name
),

-- CURRENT YEAR (YTD) ACTUALS - Refunds
ytd_refunds AS (
    SELECT 
        p.name as property,
    SUM (
    		CASE 
    		WHEN t.transaction_type = 'refund'
    		THEN (-1) * COALESCE((t.breakdown->>'base_amount')::float,0) 
    		ELSE COALESCE((t.breakdown->>'base_amount')::float,0)
    		END 
    ) as refund_amount
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    INNER JOIN development_opportunities o ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_details t ON dt.id = t.development_delivery_timeline_id
    LEFT JOIN development_bank_accounts ON development_bank_accounts.id = 
        CASE WHEN t.account_type ~ '^[0-9]+$' THEN t.account_type::int ELSE NULL END
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL 
      AND t.deleted_at IS NULL
      AND p.active = TRUE
      AND t.transaction_type = 'refund'
      AND t.payment_date BETWEEN DATE '2025-04-01' AND DATE(now() + INTERVAL '330 minutes')
    GROUP BY p.name
),

-- Future Budget with Early Payments (Special Case) → used as ADVANCES
future_budget_early_payment AS (
    SELECT 
        p.name as property,
        SUM((t.breakdown->>'base_amount')::float) as early_payment_amount
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    INNER JOIN development_opportunities o ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_details t ON dt.id = t.development_delivery_timeline_id
    LEFT JOIN development_delivery_timeline_phase_details phd ON dt.development_delivery_timeline_phase_detail_id = phd.id
    INNER JOIN development_delivery_timeline_phases ph ON dt.development_delivery_timeline_phase_id = ph.id
    LEFT JOIN development_bank_accounts ON development_bank_accounts.id = 
        CASE WHEN t.account_type ~ '^[0-9]+$' THEN t.account_type::int ELSE NULL END
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL 
      AND t.deleted_at IS NULL
      AND p.active = TRUE
      AND development_bank_accounts.is_subsidiary = TRUE
      AND t.transaction_type = 'collection'
      AND t.payment_date < COALESCE(
            CASE 
                WHEN phd.is_construction_linked = TRUE THEN 
                    CASE 
                        WHEN dt.client_communication_date IS NOT NULL
                             AND (dt.ops_actual_date IS NULL OR dt.client_communication_date > dt.ops_actual_date)
                        THEN dt.client_communication_date
                        ELSE dt.ops_actual_date
                    END
                WHEN phd.is_construction_linked = FALSE THEN dt.client_communication_date
                WHEN CASE 
                        WHEN ph.sub_phase = 'additional' AND development_bank_accounts.is_subsidiary = TRUE THEN FALSE
                        ELSE phd.is_construction_linked
                     END = FALSE THEN dt.client_communication_date
                ELSE dt.ops_actual_date
            END,
            dt.ops_actual_date,
            dt.client_communication_date
        )
      AND COALESCE(
            CASE 
                WHEN phd.is_construction_linked = TRUE THEN 
                    CASE 
                        WHEN dt.client_communication_date IS NOT NULL
                             AND (dt.ops_actual_date IS NULL OR dt.client_communication_date > dt.ops_actual_date)
                        THEN dt.client_communication_date
                        ELSE dt.ops_actual_date
                    END
                WHEN phd.is_construction_linked = FALSE THEN dt.client_communication_date
                WHEN CASE 
                        WHEN ph.sub_phase = 'additional' AND development_bank_accounts.is_subsidiary = TRUE THEN FALSE
                        ELSE phd.is_construction_linked
                     END = FALSE THEN dt.client_communication_date
                ELSE dt.ops_actual_date
            END,
            dt.ops_actual_date,
            dt.client_communication_date
        ) > CURRENT_DATE
    GROUP BY p.name
),

/* -----------------------------------------------------------------
  MILESTONE-LEVEL ACTUAL_PENDING (reusing logic from previous query)
  ----------------------------------------------------------------- */

milestone_base_data AS (
    SELECT 
        o.slug,
        o.name,
        dt.id AS delivery_timeline_id,
        l.city AS location,
        DATE(o.maal_laao_at + INTERVAL '330 minutes') AS sales_date,
        p.name AS property,
        phd.step AS stage_name,
        SUM((dt.breakdown->> 'base_amount')::float) AS base_amount,
        SUM((dt.breakdown->> 'gst_amount')::float) AS gst_amount,
        SUM((dt.breakdown->> 'stamp_duty_amount')::float) AS stamp_duty_amount,
        SUM((dt.breakdown->> 'registration_amount')::float) AS registration_amount,
        SUM((dt.breakdown->> 'tds_amount')::float) AS tds_amount,
        SUM(dt.total_amount) AS total_amount,
        dt.id AS did,
        ops_budget_date,
        ops_actual_date,
        client_communication_date,
        payment_due_date,
        phd.id AS phdid,
        sub_phase,
        is_construction_linked,
        is_subsidiary,
        dt.status AS delivery_tracker_status
    FROM development_opportunity_properties op
    INNER JOIN development_properties p 
        ON op.development_property_id = p.id
    INNER JOIN development_locations l 
        ON l.id = p.development_location_id
    INNER JOIN development_opportunities o 
        ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt 
        ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_phase_details phd 
        ON dt.development_delivery_timeline_phase_detail_id = phd.id
    INNER JOIN development_delivery_timeline_phases ph 
        ON dt.development_delivery_timeline_phase_id = ph.id
    LEFT JOIN staffs 
        ON staffs.id = o.post_sales_exec_id
    LEFT JOIN development_opportunity_property_bank_accounts opba 
        ON opba.development_opportunity_property_id = op.id
      AND opba.development_delivery_timeline_phase_id = dt.development_delivery_timeline_phase_id
      AND opba.account_type = 'base'
    LEFT JOIN development_bank_accounts 
        ON opba.development_bank_account_id = development_bank_accounts.id
    WHERE 
        p.include_in_reports = TRUE 
        AND p.deleted_at IS NULL
        AND dt.deleted_at IS NULL
        AND development_bank_accounts.is_subsidiary = TRUE
        AND (
            -- Construction-linked:
            --   use ops_actual_date, but override with client_communication_date
            --   when client_communication_date > ops_actual_date
            (
                phd.is_construction_linked = TRUE
                AND DATE(
                        CASE 
                            WHEN client_communication_date IS NOT NULL
                                 AND ops_actual_date IS NOT NULL
                                 AND client_communication_date > ops_actual_date
                            THEN client_communication_date
                            ELSE ops_actual_date
                        END
                    ) <= DATE(now() + INTERVAL '330 minutes')
            )
            OR
            -- Payment-linked / NULL → use client_communication_date
            (
                phd.is_construction_linked IS DISTINCT FROM TRUE
                AND client_communication_date IS NOT NULL
                AND DATE(client_communication_date) <= DATE(now() + INTERVAL '330 minutes')
            )
        )
    GROUP BY 
        o.slug,
        o.name,
        l.city,
        DATE(o.maal_laao_at + INTERVAL '330 minutes'),
        phd.step,
        p.name,
        ops_actual_date,
        ops_budget_date,
        client_communication_date,
        dt.id,
        phd.id,
        sub_phase,
        dt.status,
        payment_due_date,
        is_construction_linked,
        is_subsidiary
),


milestone_collection_refund AS (
    SELECT 
        p.id,
        CASE WHEN transaction_type = 'collection' 
             THEN SUM((t.breakdown->> 'base_amount')::float) END AS base_amount_paid, 
        CASE WHEN transaction_type = 'refund' 
             THEN SUM((t.breakdown->> 'base_amount')::float) END AS refund_base_amount,
        t.development_delivery_timeline_id AS did,
        DATE(t.payment_date + INTERVAL '330 minutes') AS payment_date,
        DATE(t.updated_at + INTERVAL '330 minutes') AS payment_updated_at
    FROM development_opportunity_properties op
    INNER JOIN development_properties p ON op.development_property_id = p.id
    INNER JOIN development_opportunities o ON op.development_opportunity_id = o.id
    INNER JOIN development_delivery_timelines dt ON dt.development_opportunity_property_id = op.id
    LEFT JOIN development_delivery_timeline_details t 
        ON dt.id = t.development_delivery_timeline_id
    WHERE p.active = TRUE
      AND dt.deleted_at IS NULL 
      AND t.deleted_at IS NULL
    GROUP BY 
        p.id,
        t.development_delivery_timeline_id,
        DATE(t.updated_at + INTERVAL '330 minutes'),
        DATE(t.payment_date + INTERVAL '330 minutes'),
        transaction_type
),

milestone_actual_pending AS (
    SELECT 
        mb.property,
        mb.delivery_timeline_id,
        mb.stage_name,
        mb.base_amount,
        SUM(COALESCE(mcr.base_amount_paid, 0)) AS base_amount_paid,
        SUM(COALESCE(mcr.refund_base_amount, 0)) AS refund_base_amount,
        CASE 
            WHEN mb.stage_name = 'Excess collection'
                THEN (-1) * COALESCE(mb.base_amount, 0)
            ELSE 
                COALESCE(mb.base_amount, 0)
                - SUM(COALESCE(mcr.base_amount_paid, 0))
                + SUM(COALESCE(mcr.refund_base_amount, 0))
        END AS actual_pending
    FROM milestone_base_data mb
    LEFT JOIN milestone_collection_refund mcr
        ON mb.did = mcr.did
    GROUP BY 
        mb.property,
        mb.delivery_timeline_id,
        mb.stage_name,
        mb.base_amount
),

property_actual_pending AS (
    SELECT 
        property,
        SUM(actual_pending) AS variance_actual_pending
    FROM milestone_actual_pending
    GROUP BY property
),

isprava_metrics as 
(
-- FINAL CALCULATION WITH SPILLOVER LOGIC AND REFUNDS
SELECT 
    bd.property,
    
    -- LYTD Columns
    COALESCE(lc.budget_amount, 0) + COALESCE(lp.budget_amount, 0) AS budgeted_lytd_plan,
    COALESCE(la.collected_amount, 0) + COALESCE(lr.refund_amount, 0) AS actuals_lytd_collected,
    COALESCE(lr.refund_amount, 0) AS actuals_lytd_refunds,

    -- revised_budget_lytd = actuals_lytd_collected
    COALESCE(la.collected_amount, 0) AS revised_budget_lytd,
    
    -- YTD Columns
    COALESCE(yc.budget_amount, 0) + COALESCE(yp.budget_amount, 0) AS budgeted_ytd_plan,
    
    -- REVISED YTD BUDGET PLAN WITH SPILLOVER (using revised CTEs)
        (
            (COALESCE(lcr.budget_amount, 0) + COALESCE(lp.budget_amount, 0))
            - COALESCE(la.collected_amount, 0)
        )
        +
        (COALESCE(ycr.budget_amount, 0) + COALESCE(yp.budget_amount, 0)) AS revised_ytd_budget_plan,
    
    -- YTD actuals
    COALESCE(ya.collected_amount, 0) AS actuals_ytd_collected,
    COALESCE(yr.refund_amount, 0) AS actuals_ytd_refunds,
    COALESCE(ya.collected_amount, 0) + COALESCE(yr.refund_amount, 0) AS net_actuals_ytd,
    
    -- VARIANCE = actual_pending - advances (early payments)
    COALESCE(pap.variance_actual_pending, 0) 
      - COALESCE(fep.early_payment_amount, 0) AS variance
FROM isprava_base_data bd
LEFT JOIN lytd_construction lc ON bd.property = lc.property
LEFT JOIN lytd_construction_revised lcr ON bd.property = lcr.property  -- NEW JOIN
LEFT JOIN lytd_payment lp ON bd.property = lp.property
LEFT JOIN lytd_collected la ON bd.property = la.property
LEFT JOIN lytd_refunds lr ON bd.property = lr.property
LEFT JOIN ytd_construction yc ON bd.property = yc.property
LEFT JOIN ytd_construction_revised ycr ON bd.property = ycr.property  -- NEW JOIN
LEFT JOIN ytd_payment yp ON bd.property = yp.property
LEFT JOIN ytd_collected ya ON bd.property = ya.property
LEFT JOIN ytd_refunds yr ON bd.property = yr.property
LEFT JOIN future_budget_early_payment fep ON bd.property = fep.property
LEFT JOIN property_actual_pending pap ON bd.property = pap.property
),

-- ==================== CHAPTER SECTION ====================

chapter_base_data AS (
    -- Get all properties
    SELECT p.name as property
    FROM chapter_opportunity_properties op
    INNER JOIN chapter_properties p ON op.chapter_property_id = p.id
    WHERE p.include_in_reports = TRUE
      AND backed_out_at IS NULL
),

-- LAST YEAR (LYTD) BUDGETED - Payment Linked
chapter_lytd_payment AS (
    SELECT 
        p.name as property,
        SUM(
                    CASE 
                        WHEN phd.step = 'Excess collection'
                        THEN (-1) * COALESCE((dt.breakdown->>'base_amount')::float, 0)
                        ELSE COALESCE((dt.breakdown->>'base_amount')::float, 0)
                    END
                ) as budget_amount
    FROM chapter_opportunity_properties op
    INNER JOIN chapter_properties p ON op.chapter_property_id = p.id
    INNER JOIN chapter_locations l ON l.id = p.chapter_location_id
    INNER JOIN chapter_opportunities o ON op.chapter_opportunity_id = o.id
    INNER JOIN chapter_delivery_timelines dt ON dt.chapter_opportunity_property_id = op.id
    LEFT JOIN chapter_delivery_timeline_phase_details phd ON dt.chapter_delivery_timeline_phase_detail_id = phd.id
    INNER JOIN chapter_delivery_timeline_phases ph ON dt.chapter_delivery_timeline_phase_id = ph.id
    LEFT JOIN staffs ON staffs.id = o.post_sales_exec_id
    LEFT JOIN chapter_opportunity_property_bank_accounts opba ON
        opba.chapter_opportunity_property_id = op.id
        AND opba.chapter_delivery_timeline_phase_id = dt.chapter_delivery_timeline_phase_id
        AND opba.account_type = 'base'
    LEFT JOIN chapter_bank_accounts ON opba.chapter_bank_account_id = chapter_bank_accounts.id
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL
      AND dt.client_communication_date <= DATE '2025-02-28'
    GROUP BY p.name
),

-- LAST YEAR (LYTD) ACTUALS - Collected
chapter_lytd_collected AS (
    SELECT 
        p.name as property,
        SUM((t.breakdown->>'base_amount')::float) as collected_amount
    FROM chapter_opportunity_properties op
    INNER JOIN chapter_properties p ON op.chapter_property_id = p.id
    INNER JOIN chapter_opportunities o ON op.chapter_opportunity_id = o.id
    INNER JOIN chapter_delivery_timelines dt ON dt.chapter_opportunity_property_id = op.id
    LEFT JOIN chapter_delivery_timeline_details t ON dt.id = t.chapter_delivery_timeline_id
    LEFT JOIN chapter_delivery_timeline_phase_details phd ON dt.chapter_delivery_timeline_phase_detail_id = phd.id
    LEFT JOIN chapter_bank_accounts ON chapter_bank_accounts.id = 
        CASE WHEN t.account_type ~ '^[0-9]+$' THEN t.account_type::int ELSE NULL END
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL 
      AND t.deleted_at IS NULL
      AND p.active = TRUE
      AND t.transaction_type = 'collection'
      AND t.payment_date <= DATE '2025-03-31'
    GROUP BY p.name
),

-- LAST YEAR (LYTD) ACTUALS - Refunds
chapter_lytd_refunds AS (
    SELECT 
        p.name as property,
    SUM (
    		CASE 
    		WHEN t.transaction_type = 'refund'
    		THEN (-1) * COALESCE((t.breakdown->>'base_amount')::float,0) 
    		ELSE COALESCE((t.breakdown->>'base_amount')::float,0)
    		END 
    ) as refund_amount
    FROM chapter_opportunity_properties op
    INNER JOIN chapter_properties p ON op.chapter_property_id = p.id
    INNER JOIN chapter_opportunities o ON op.chapter_opportunity_id = o.id
    INNER JOIN chapter_delivery_timelines dt ON dt.chapter_opportunity_property_id = op.id
    LEFT JOIN chapter_delivery_timeline_details t ON dt.id = t.chapter_delivery_timeline_id
    LEFT JOIN chapter_bank_accounts ON chapter_bank_accounts.id = 
        CASE WHEN t.account_type ~ '^[0-9]+$' THEN t.account_type::int ELSE NULL END
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL 
      AND t.deleted_at IS NULL
      AND p.active = TRUE
      AND t.transaction_type = 'refund'
      AND t.payment_date <= DATE '2025-03-31'
    GROUP BY p.name
),

-- CURRENT YEAR (YTD) BUDGETED - Payment Linked
chapter_ytd_payment AS (
    SELECT 
        p.name as property,
        SUM(
                    CASE 
                        WHEN phd.step = 'Excess collection'
                        THEN (-1) * COALESCE((dt.breakdown->>'base_amount')::float, 0)
                        ELSE COALESCE((dt.breakdown->>'base_amount')::float, 0)
                    END
                ) as budget_amount
    FROM chapter_opportunity_properties op
    INNER JOIN chapter_properties p ON op.chapter_property_id = p.id
    INNER JOIN chapter_locations l ON l.id = p.chapter_location_id
    INNER JOIN chapter_opportunities o ON op.chapter_opportunity_id = o.id
    INNER JOIN chapter_delivery_timelines dt ON dt.chapter_opportunity_property_id = op.id
    LEFT JOIN chapter_delivery_timeline_phase_details phd ON dt.chapter_delivery_timeline_phase_detail_id = phd.id
    INNER JOIN chapter_delivery_timeline_phases ph ON dt.chapter_delivery_timeline_phase_id = ph.id
    LEFT JOIN staffs ON staffs.id = o.post_sales_exec_id
    LEFT JOIN chapter_opportunity_property_bank_accounts opba ON
        opba.chapter_opportunity_property_id = op.id
        AND opba.chapter_delivery_timeline_phase_id = dt.chapter_delivery_timeline_phase_id
        AND opba.account_type = 'base'
    LEFT JOIN chapter_bank_accounts ON opba.chapter_bank_account_id = chapter_bank_accounts.id
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL
      AND dt.client_communication_date BETWEEN DATE '2025-03-01' AND DATE(now() + INTERVAL '330 minutes')
    GROUP BY p.name
),

-- CURRENT YEAR (YTD) ACTUALS - Collected
chapter_ytd_collected AS (
    SELECT 
        p.name as property,
        SUM((t.breakdown->>'base_amount')::float) as collected_amount
    FROM chapter_opportunity_properties op
    INNER JOIN chapter_properties p ON op.chapter_property_id = p.id
    INNER JOIN chapter_opportunities o ON op.chapter_opportunity_id = o.id
    INNER JOIN chapter_delivery_timelines dt ON dt.chapter_opportunity_property_id = op.id
    LEFT JOIN chapter_delivery_timeline_details t ON dt.id = t.chapter_delivery_timeline_id
    LEFT JOIN chapter_delivery_timeline_phase_details phd ON dt.chapter_delivery_timeline_phase_detail_id = phd.id
    LEFT JOIN chapter_bank_accounts ON chapter_bank_accounts.id = 
        CASE WHEN t.account_type ~ '^[0-9]+$' THEN t.account_type::int ELSE NULL END
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL 
      AND t.deleted_at IS NULL
      AND p.active = TRUE
      AND t.transaction_type = 'collection'
      AND t.payment_date BETWEEN DATE '2025-04-01' AND DATE(now() + INTERVAL '330 minutes')
    GROUP BY p.name
),

-- CURRENT YEAR (YTD) ACTUALS - Refunds
chapter_ytd_refunds AS (
    SELECT 
        p.name as property,
    SUM (
    		CASE 
    		WHEN t.transaction_type = 'refund'
    		THEN (-1) * COALESCE((t.breakdown->>'base_amount')::float,0) 
    		ELSE COALESCE((t.breakdown->>'base_amount')::float,0)
    		END 
    ) as refund_amount
    FROM chapter_opportunity_properties op
    INNER JOIN chapter_properties p ON op.chapter_property_id = p.id
    INNER JOIN chapter_opportunities o ON op.chapter_opportunity_id = o.id
    INNER JOIN chapter_delivery_timelines dt ON dt.chapter_opportunity_property_id = op.id
    LEFT JOIN chapter_delivery_timeline_details t ON dt.id = t.chapter_delivery_timeline_id
    LEFT JOIN chapter_bank_accounts ON chapter_bank_accounts.id = 
        CASE WHEN t.account_type ~ '^[0-9]+$' THEN t.account_type::int ELSE NULL END
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL 
      AND t.deleted_at IS NULL
      AND p.active = TRUE
      AND t.transaction_type = 'refund'
      AND t.payment_date BETWEEN DATE '2025-04-01' AND DATE(now() + INTERVAL '330 minutes')
    GROUP BY p.name
),

-- Future Budget with Early Payments (Special Case) → used as ADVANCES
chapter_future_budget_early_payment AS (
    SELECT 
        p.name as property,
        SUM((t.breakdown->>'base_amount')::float) as early_payment_amount
    FROM chapter_opportunity_properties op
    INNER JOIN chapter_properties p ON op.chapter_property_id = p.id
    INNER JOIN chapter_opportunities o ON op.chapter_opportunity_id = o.id
    INNER JOIN chapter_delivery_timelines dt ON dt.chapter_opportunity_property_id = op.id
    LEFT JOIN chapter_delivery_timeline_details t ON dt.id = t.chapter_delivery_timeline_id
    LEFT JOIN chapter_delivery_timeline_phase_details phd ON dt.chapter_delivery_timeline_phase_detail_id = phd.id
    INNER JOIN chapter_delivery_timeline_phases ph ON dt.chapter_delivery_timeline_phase_id = ph.id
    LEFT JOIN chapter_bank_accounts ON chapter_bank_accounts.id = 
        CASE WHEN t.account_type ~ '^[0-9]+$' THEN t.account_type::int ELSE NULL END
    WHERE p.include_in_reports = TRUE 
      AND p.deleted_at IS NULL
      AND dt.deleted_at IS NULL 
      AND t.deleted_at IS NULL
      AND p.active = TRUE
      AND t.transaction_type = 'collection'
      AND t.payment_date < (dt.client_communication_date)
      AND dt.client_communication_date > CURRENT_DATE
    GROUP BY p.name
),

/* -----------------------------------------------------------------
  MILESTONE-LEVEL ACTUAL_PENDING (reusing logic from previous query)
  ----------------------------------------------------------------- */

chapter_milestone_base_data AS (
    SELECT 
        o.slug,
        o.name,
        dt.id AS delivery_timeline_id,
        l.city AS location,
        DATE(o.maal_laao_at + INTERVAL '330 minutes') AS sales_date,
        p.name AS property,
        phd.step AS stage_name,
        SUM((dt.breakdown->> 'base_amount')::float) AS base_amount,
        SUM((dt.breakdown->> 'gst_amount')::float) AS gst_amount,
        SUM((dt.breakdown->> 'stamp_duty_amount')::float) AS stamp_duty_amount,
        SUM((dt.breakdown->> 'registration_amount')::float) AS registration_amount,
        SUM((dt.breakdown->> 'tds_amount')::float) AS tds_amount,
        SUM(dt.total_amount) AS total_amount,
        dt.id AS did,
        ops_budget_date,
        ops_actual_date,
        client_communication_date,
        payment_due_date,
        phd.id AS phdid,
        sub_phase,
        is_construction_linked,
        is_subsidiary,
        dt.status AS delivery_tracker_status
    FROM chapter_opportunity_properties op
    INNER JOIN chapter_properties p 
        ON op.chapter_property_id = p.id
    INNER JOIN chapter_locations l 
        ON l.id = p.chapter_location_id
    INNER JOIN chapter_opportunities o 
        ON op.chapter_opportunity_id = o.id
    INNER JOIN chapter_delivery_timelines dt 
        ON dt.chapter_opportunity_property_id = op.id
    LEFT JOIN chapter_delivery_timeline_phase_details phd 
        ON dt.chapter_delivery_timeline_phase_detail_id = phd.id
    INNER JOIN chapter_delivery_timeline_phases ph 
        ON dt.chapter_delivery_timeline_phase_id = ph.id
    LEFT JOIN staffs 
        ON staffs.id = o.post_sales_exec_id
    LEFT JOIN chapter_opportunity_property_bank_accounts opba 
        ON opba.chapter_opportunity_property_id = op.id
      AND opba.chapter_delivery_timeline_phase_id = dt.chapter_delivery_timeline_phase_id
      AND opba.account_type = 'base'
    LEFT JOIN chapter_bank_accounts 
        ON opba.chapter_bank_account_id = chapter_bank_accounts.id
    WHERE 
        p.include_in_reports = TRUE 
        AND p.deleted_at IS NULL
        AND dt.deleted_at IS NULL
        AND DATE(client_communication_date) <= DATE(now() + INTERVAL '330 minutes')
    GROUP BY 
        o.slug,
        o.name,
        l.city,
        DATE(o.maal_laao_at + INTERVAL '330 minutes'),
        phd.step,
        p.name,
        ops_actual_date,
        ops_budget_date,
        client_communication_date,
        dt.id,
        phd.id,
        sub_phase,
        dt.status,
        payment_due_date,
        is_construction_linked,
        is_subsidiary
),


chapter_milestone_collection_refund AS (
    SELECT 
        p.id,
        CASE WHEN transaction_type = 'collection' 
             THEN SUM((t.breakdown->> 'base_amount')::float) END AS base_amount_paid, 
        CASE WHEN transaction_type = 'refund' 
             THEN SUM((t.breakdown->> 'base_amount')::float) END AS refund_base_amount,
        t.chapter_delivery_timeline_id AS did,
        DATE(t.payment_date + INTERVAL '330 minutes') AS payment_date,
        DATE(t.updated_at + INTERVAL '330 minutes') AS payment_updated_at
    FROM chapter_opportunity_properties op
    INNER JOIN chapter_properties p ON op.chapter_property_id = p.id
    INNER JOIN chapter_opportunities o ON op.chapter_opportunity_id = o.id
    INNER JOIN chapter_delivery_timelines dt ON dt.chapter_opportunity_property_id = op.id
    LEFT JOIN chapter_delivery_timeline_details t 
        ON dt.id = t.chapter_delivery_timeline_id
    WHERE p.active = TRUE
      AND dt.deleted_at IS NULL 
      AND t.deleted_at IS NULL
    GROUP BY 
        p.id,
        t.chapter_delivery_timeline_id,
        DATE(t.updated_at + INTERVAL '330 minutes'),
        DATE(t.payment_date + INTERVAL '330 minutes'),
        transaction_type
),

chapter_milestone_actual_pending AS (
    SELECT 
        mb.property,
        mb.delivery_timeline_id,
        mb.stage_name,
        mb.base_amount,
        SUM(COALESCE(mcr.base_amount_paid, 0)) AS base_amount_paid,
        SUM(COALESCE(mcr.refund_base_amount, 0)) AS refund_base_amount,
        CASE 
            WHEN mb.stage_name = 'Excess collection'
                THEN (-1) * COALESCE(mb.base_amount, 0)
            ELSE 
                COALESCE(mb.base_amount, 0)
                - SUM(COALESCE(mcr.base_amount_paid, 0))
                + SUM(COALESCE(mcr.refund_base_amount, 0))
        END AS actual_pending
    FROM chapter_milestone_base_data mb
    LEFT JOIN chapter_milestone_collection_refund mcr
        ON mb.did = mcr.did
    GROUP BY 
        mb.property,
        mb.delivery_timeline_id,
        mb.stage_name,
        mb.base_amount
),

chapter_property_actual_pending AS (
    SELECT 
        property,
        SUM(actual_pending) AS variance_actual_pending
    FROM chapter_milestone_actual_pending
    GROUP BY property
),

chapter_metrics AS 
(
-- FINAL CALCULATION WITH SPILLOVER LOGIC AND REFUNDS
SELECT 
    bd.property,
    
    -- LYTD Columns
    COALESCE(lp.budget_amount, 0) AS budgeted_lytd_plan,
    COALESCE(la.collected_amount, 0) AS actuals_lytd_collected,
    COALESCE(lr.refund_amount, 0) AS actuals_lytd_refunds,

    -- revised_budget_lytd = actuals_lytd_collected
    COALESCE(la.collected_amount, 0) AS revised_budget_lytd,
    
    -- YTD Columns
    COALESCE(yp.budget_amount, 0) AS budgeted_ytd_plan,
    
    -- REVISED YTD BUDGET PLAN WITH SPILLOVER
 (COALESCE(lp.budget_amount, 0) - COALESCE(la.collected_amount, 0))
        + COALESCE(yp.budget_amount, 0)AS revised_ytd_budget_plan,
    
    -- YTD actuals
    COALESCE(ya.collected_amount, 0) AS actuals_ytd_collected,
    COALESCE(yr.refund_amount, 0) AS actuals_ytd_refunds,
    COALESCE(ya.collected_amount, 0) + COALESCE(yr.refund_amount, 0) AS net_actuals_ytd,
    
    -- VARIANCE = actual_pending - advances (early payments)
    COALESCE(pap.variance_actual_pending, 0)
      - COALESCE(fep.early_payment_amount, 0) AS variance

FROM chapter_base_data bd
LEFT JOIN chapter_lytd_payment lp ON bd.property = lp.property
LEFT JOIN chapter_lytd_collected la ON bd.property = la.property
LEFT JOIN chapter_lytd_refunds lr ON bd.property = lr.property
LEFT JOIN chapter_ytd_payment yp ON bd.property = yp.property
LEFT JOIN chapter_ytd_collected ya ON bd.property = ya.property
LEFT JOIN chapter_ytd_refunds yr ON bd.property = yr.property
LEFT JOIN chapter_future_budget_early_payment fep ON bd.property = fep.property
LEFT JOIN chapter_property_actual_pending pap ON bd.property = pap.property
),

combined_union AS (
  -- union all the metric rows from both sources
  SELECT 
      property,
      budgeted_ytd_plan, revised_ytd_budget_plan, net_actuals_ytd, variance, actuals_ytd_refunds
  FROM isprava_metrics
  UNION ALL
  SELECT 
    property,
    budgeted_ytd_plan, revised_ytd_budget_plan, net_actuals_ytd, variance, actuals_ytd_refunds
  FROM chapter_metrics
),

calculated_metrics AS 
(
SELECT
    property,
    COALESCE(SUM(budgeted_ytd_plan),0)          AS ytd_planned_budget,
    COALESCE(SUM(revised_ytd_budget_plan),0)    AS normalised_budget,
    COALESCE(SUM(net_actuals_ytd),0)            AS collections,
    COALESCE(SUM(variance),0)                   AS variance,
    COALESCE(SUM(actuals_ytd_refunds),0)        AS ytd_refunds
FROM combined_union
GROUP BY combined_union.property
),

unpivoted_metrics AS (
    SELECT property, 'Already Collected' AS metric, collections AS amount FROM calculated_metrics
    WHERE collections != 0
    
    UNION ALL
    
    SELECT property, 'Collections Due & Not Received' AS metric, variance AS amount FROM calculated_metrics
    WHERE variance > 0
    
    UNION ALL
    
    ---SELECT property, 'Total Refunds' AS metric, combined_actuals_ytd_refunds AS amount FROM calculated_metrics
    ---WHERE combined_actuals_ytd_refunds != 0
    
    ---UNION ALL
    
    SELECT property, 'Excess Collection + Advance' AS metric, (variance) AS amount FROM calculated_metrics
    WHERE variance < 0
)

SELECT 
    property,
    metric,
    amount::numeric(15,2) AS amount_cr
FROM unpivoted_metrics
ORDER BY property, metric;"
Ageing Analysis - Consolidated Dashboard Query,"WITH 

isprava_base_data AS (
    SELECT
        a.slug,
        a.name,
        a.sub_phase,
        a.step,
        a.property,
        a.location,
        a.delivery_timeline_id,
        a.payment_due_date,
        a.delivery_tracker_status,
        a.is_subsidiary,
        a.is_construction_linked,
        a.payment_date,
        a.ops_actual_date,
        a.client_communication_date,
        COALESCE(a.base_amount, 0) AS base_amount,
        COALESCE(b.base_amount_paid, 0) AS base_amount_paid,
        -- Isprava keeps refunds in pending_amount
        COALESCE(a.base_amount, 0) - COALESCE(b.base_amount_paid, 0) + COALESCE(c.refund_amount,0) AS pending_amount
    FROM
    (
        SELECT 
            'https://oi.lohono.com/development/opportunities/' || o.slug AS slug,
            o.name,
            p.name AS property,
            ph.sub_phase,
            phd.step,
            l.city AS location,
            dt.id AS delivery_timeline_id,
            dt.payment_due_date,
            dt.status AS delivery_tracker_status,
            phd.is_construction_linked,
            dt.payment_date,
            dt.ops_actual_date,
            dt.client_communication_date,
                    SUM(
                    CASE 
                        WHEN phd.step = 'Excess collection'
                        THEN (-1) * COALESCE((dt.breakdown->>'base_amount')::float, 0)
                        ELSE COALESCE((dt.breakdown->>'base_amount')::float, 0)
                    END
                ) as base_amount,
            development_bank_accounts.is_subsidiary
        FROM development_opportunity_properties op
        INNER JOIN development_properties p 
            ON op.development_property_id = p.id
        INNER JOIN development_locations l 
            ON l.id = p.development_location_id
        INNER JOIN development_opportunities o 
            ON op.development_opportunity_id = o.id
        INNER JOIN development_delivery_timelines dt 
            ON dt.development_opportunity_property_id = op.id
        LEFT JOIN development_delivery_timeline_phase_details phd 
            ON dt.development_delivery_timeline_phase_detail_id = phd.id
        INNER JOIN development_delivery_timeline_phases ph 
            ON dt.development_delivery_timeline_phase_id = ph.id
        LEFT JOIN development_opportunity_property_bank_accounts opba 
            ON opba.development_opportunity_property_id = op.id
           AND opba.development_delivery_timeline_phase_id = dt.development_delivery_timeline_phase_id
           AND opba.account_type = 'base'
        LEFT JOIN development_bank_accounts 
            ON opba.development_bank_account_id = development_bank_accounts.id
        WHERE
            p.include_in_reports = TRUE
            AND p.deleted_at IS NULL
            AND dt.deleted_at IS NULL
            AND development_bank_accounts.is_subsidiary = TRUE
            AND backed_out_at IS NULL
        GROUP BY 
            o.slug, o.name, p.name, l.city,
            dt.id, dt.payment_due_date, dt.status,
            phd.is_construction_linked,
            dt.payment_date, ops_actual_date, client_communication_date,
            development_bank_accounts.is_subsidiary, sub_phase, step
    ) a
    
    LEFT JOIN
    (
        SELECT
            dt.id AS delivery_timeline_id,
            SUM(
                CASE 
                    WHEN t.transaction_type = 'collection'
                    THEN (t.breakdown->>'base_amount')::FLOAT 
                    ELSE 0 
                END
            ) AS base_amount_paid
        FROM development_opportunity_properties op
        INNER JOIN development_properties p 
            ON op.development_property_id = p.id
        INNER JOIN development_opportunities o 
            ON op.development_opportunity_id = o.id
        INNER JOIN development_delivery_timelines dt 
            ON dt.development_opportunity_property_id = op.id
        LEFT JOIN development_delivery_timeline_details t 
            ON dt.id = t.development_delivery_timeline_id
        LEFT JOIN development_delivery_timeline_phase_details phd 
            ON dt.development_delivery_timeline_phase_detail_id = phd.id
        WHERE
            p.active = TRUE
            AND dt.deleted_at IS NULL
            AND t.deleted_at IS NULL
        GROUP BY dt.id
    ) b 
        ON a.delivery_timeline_id = b.delivery_timeline_id

    LEFT JOIN 
    (
        SELECT 
            p.id,
            p.name,
            SUM((t.breakdown->> 'base_amount')::float) AS refund_amount,
            dt.id AS delivery_timeline_id
        FROM development_opportunity_properties op
        INNER JOIN development_properties p ON op.development_property_id = p.id
        INNER JOIN development_opportunities o ON op.development_opportunity_id = o.id
        INNER JOIN development_delivery_timelines dt ON dt.development_opportunity_property_id = op.id
        LEFT JOIN development_delivery_timeline_details t ON dt.id = t.development_delivery_timeline_id
        LEFT JOIN development_bank_accounts ON development_bank_accounts.id = CASE WHEN t.account_type ~ '^[0-9]+$' THEN t.account_type::int ELSE NULL END
        WHERE p.include_in_reports = TRUE
          AND p.deleted_at IS NULL
          AND dt.deleted_at IS NULL
          AND t.deleted_at IS NULL
          AND p.active = TRUE
          AND t.transaction_type = 'refund'
          AND t.payment_date BETWEEN '2025-04-01' AND date(now() + interval '330 minutes')
        GROUP BY p.name, dt.id, p.id
    ) c
    ON a.delivery_timeline_id = c.delivery_timeline_id
),

isprava_filtered AS (
    SELECT *
    FROM isprava_base_data
    WHERE
        is_subsidiary = TRUE
        AND NOT (
            is_construction_linked = TRUE
            AND ops_actual_date IS NULL
        )
        AND client_communication_date <= CURRENT_DATE
),

isprava_ageing AS (
    SELECT
        f.*,
        (CURRENT_DATE - f.payment_due_date) AS days_overdue,
        CASE
            WHEN (CURRENT_DATE - f.client_communication_date) <= 30 THEN 'Within Timelines'
            WHEN (CURRENT_DATE - f.client_communication_date) > 30
              AND (CURRENT_DATE - f.client_communication_date) <= 60 THEN '0 - 30 Days'
            WHEN (CURRENT_DATE - f.client_communication_date) > 60
              AND (CURRENT_DATE - f.client_communication_date) <= 90 THEN '31 - 60 Days'
            WHEN (CURRENT_DATE - f.client_communication_date) > 90
              AND (CURRENT_DATE - f.client_communication_date) <= 120 THEN '61 - 90 Days'
            ELSE '90+ Days'
        END AS ageing_bucket
    FROM isprava_filtered f
),

isprava_payment_dates AS (
    SELECT
        dt.id AS delivery_timeline_id,
        MIN(
            CASE 
                WHEN t.transaction_type = 'collection'
                     AND t.deleted_at IS NULL
                THEN t.payment_date
            END
        ) AS payment_date_for_advance
    FROM development_delivery_timelines dt
    LEFT JOIN development_delivery_timeline_details t
        ON dt.id = t.development_delivery_timeline_id
    WHERE
        dt.deleted_at IS NULL
    GROUP BY dt.id
),

isprava_advances AS (
    SELECT
        bd.property,
        bd.sub_phase,
        bd.step,
        bd.delivery_tracker_status,
        bd.client_communication_date,
        bd.base_amount_paid,
        pd.payment_date_for_advance,
        bd.delivery_timeline_id     -- :point_left: add this
    FROM isprava_base_data bd
    LEFT JOIN isprava_payment_dates pd
        ON bd.delivery_timeline_id = pd.delivery_timeline_id
    WHERE
        bd.base_amount_paid > 0
        AND bd.client_communication_date > CURRENT_DATE
        AND pd.payment_date_for_advance IS NOT NULL
        AND (
            bd.client_communication_date IS NULL
            OR pd.payment_date_for_advance < bd.client_communication_date
        )
        AND bd.delivery_tracker_status in ('upcoming','not_due')
),

isprava_additional_advances AS (
    SELECT
        bd.property,
        bd.sub_phase,
        bd.step,
        bd.delivery_tracker_status,
        bd.client_communication_date,
        bd.base_amount_paid,
        pd.payment_date_for_advance,
        bd.delivery_timeline_id     -- optional, but usually useful downstream
    FROM isprava_base_data bd
    LEFT JOIN isprava_payment_dates pd
        ON bd.delivery_timeline_id = pd.delivery_timeline_id
    WHERE
        bd.is_subsidiary = TRUE
        AND bd.sub_phase = 'additional'
        AND bd.base_amount_paid > 0
        AND bd.client_communication_date > CURRENT_DATE
        AND pd.payment_date_for_advance < bd.client_communication_date
        AND NOT EXISTS (
            SELECT 1
            FROM isprava_advances ia
            WHERE ia.delivery_timeline_id = bd.delivery_timeline_id
        )
),

isprava_ageing_agg AS (
    SELECT
        property,
        step,
        ageing_bucket,
        ROUND(SUM(pending_amount)::numeric, 2) AS amount_in_cr
    FROM isprava_ageing
    GROUP BY property, step, ageing_bucket
),

isprava_advances_agg AS (
    -- Note: original Isprava query used negative for advances
    SELECT
        property,
        step,
        'Advance'::text AS ageing_bucket,
        ROUND((SUM(base_amount_paid)::numeric * -1), 2) AS amount_in_cr
    FROM (
        SELECT * FROM isprava_advances
        UNION ALL
        SELECT * FROM isprava_additional_advances
    ) x
    GROUP BY property, step
),


/* =========================
   CHAPTER: base / ageing / advances
   ========================= */
chapter_base_data AS (
    SELECT
        a.slug,
        a.name,
        a.sub_phase,
        a.step,
        a.property,
        a.location,
        a.delivery_timeline_id,
        a.payment_due_date,
        a.delivery_tracker_status,
        a.is_subsidiary,
        a.is_construction_linked,
        a.payment_date,
        a.ops_actual_date,
        a.client_communication_date,
        COALESCE(a.base_amount, 0) AS base_amount,
        COALESCE(b.base_amount_paid, 0) AS base_amount_paid,
        -- Chapter excludes refunds here (kept as original)
        COALESCE(a.base_amount, 0) - COALESCE(b.base_amount_paid, 0) + COALESCE(c.refund_amount,0) AS pending_amount
    FROM
    (
        SELECT 
            'https://oi.lohono.com/chapter/opportunities/' || o.slug AS slug,
            o.name,
            p.name AS property,
            ph.sub_phase,
            phd.step,
            l.city AS location,
            dt.id AS delivery_timeline_id,
            dt.payment_due_date,
            dt.status AS delivery_tracker_status,
            phd.is_construction_linked,
            dt.payment_date,
            dt.ops_actual_date,
            dt.client_communication_date,
                                SUM(
                    CASE 
                        WHEN phd.step = 'Excess collection'
                        THEN (-1) * COALESCE((dt.breakdown->>'base_amount')::float, 0)
                        ELSE COALESCE((dt.breakdown->>'base_amount')::float, 0)
                    END
                ) as base_amount,
            chapter_bank_accounts.is_subsidiary
        FROM chapter_opportunity_properties op
        INNER JOIN chapter_properties p 
            ON op.chapter_property_id = p.id
        INNER JOIN chapter_locations l 
            ON l.id = p.chapter_location_id
        INNER JOIN chapter_opportunities o 
            ON op.chapter_opportunity_id = o.id
        INNER JOIN chapter_delivery_timelines dt 
            ON dt.chapter_opportunity_property_id = op.id
        LEFT JOIN chapter_delivery_timeline_phase_details phd 
            ON dt.chapter_delivery_timeline_phase_detail_id = phd.id
        INNER JOIN chapter_delivery_timeline_phases ph 
            ON dt.chapter_delivery_timeline_phase_id = ph.id
        LEFT JOIN chapter_opportunity_property_bank_accounts opba 
            ON opba.chapter_opportunity_property_id = op.id
           AND opba.chapter_delivery_timeline_phase_id = dt.chapter_delivery_timeline_phase_id
           AND opba.account_type = 'base'
        LEFT JOIN chapter_bank_accounts 
            ON opba.chapter_bank_account_id = chapter_bank_accounts.id
        WHERE
            p.include_in_reports = TRUE
            AND p.deleted_at IS NULL
            AND dt.deleted_at IS NULL
            and p.name != 'Chapter Test Property'
        GROUP BY 
            o.slug, o.name, p.name, l.city,
            dt.id, dt.payment_due_date, dt.status,
            phd.is_construction_linked,
            dt.payment_date, ops_actual_date, client_communication_date,
            chapter_bank_accounts.is_subsidiary, sub_phase, step
    ) a
    LEFT JOIN
    (
        SELECT
            dt.id AS delivery_timeline_id,
            SUM(
                CASE 
                    WHEN t.transaction_type = 'collection'
                    THEN (t.breakdown->>'base_amount')::FLOAT 
                    ELSE 0 
                END
            ) AS base_amount_paid
        FROM chapter_opportunity_properties op
        INNER JOIN chapter_properties p 
            ON op.chapter_property_id = p.id
        INNER JOIN chapter_opportunities o 
            ON op.chapter_opportunity_id = o.id
        INNER JOIN chapter_delivery_timelines dt 
            ON dt.chapter_opportunity_property_id = op.id
        LEFT JOIN chapter_delivery_timeline_details t 
            ON dt.id = t.chapter_delivery_timeline_id
        WHERE
            p.active = TRUE
            AND dt.deleted_at IS NULL
            AND t.deleted_at IS NULL
        GROUP BY dt.id
    ) b 
        ON a.delivery_timeline_id = b.delivery_timeline_id
        
    LEFT JOIN 
    (
        SELECT 
            p.id,
            p.name,
            SUM((t.breakdown->> 'base_amount')::float) AS refund_amount,
            dt.id AS delivery_timeline_id
        FROM chapter_opportunity_properties op
        INNER JOIN chapter_properties p ON op.chapter_property_id = p.id
        INNER JOIN chapter_opportunities o ON op.chapter_opportunity_id = o.id
        INNER JOIN chapter_delivery_timelines dt ON dt.chapter_opportunity_property_id = op.id
        LEFT JOIN chapter_delivery_timeline_details t ON dt.id = t.chapter_delivery_timeline_id
        LEFT JOIN chapter_bank_accounts ON chapter_bank_accounts.id = CASE WHEN t.account_type ~ '^[0-9]+$' THEN t.account_type::int ELSE NULL END
        WHERE p.include_in_reports = TRUE
          AND p.deleted_at IS NULL
          AND dt.deleted_at IS NULL
          AND t.deleted_at IS NULL
          AND p.active = TRUE
          AND t.transaction_type = 'refund'
          AND t.payment_date BETWEEN '2025-04-01' AND date(now() + interval '330 minutes')
        GROUP BY p.name, dt.id, p.id
    ) c
    ON a.delivery_timeline_id = c.delivery_timeline_id
),

chapter_filtered AS (
    SELECT *
    FROM chapter_base_data
    WHERE
        client_communication_date <= CURRENT_DATE
),

chapter_ageing AS (
    SELECT
        f.*,
        (CURRENT_DATE - f.payment_due_date) AS days_overdue,
        CASE
            WHEN (CURRENT_DATE - f.client_communication_date) <= 30 THEN 'Within Timelines'
            WHEN (CURRENT_DATE - f.client_communication_date) > 30
              AND (CURRENT_DATE - f.client_communication_date) <= 60 THEN '0 - 30 Days'
            WHEN (CURRENT_DATE - f.client_communication_date) > 60
              AND (CURRENT_DATE - f.client_communication_date) <= 90 THEN '31 - 60 Days'
            WHEN (CURRENT_DATE - f.client_communication_date) > 90
              AND (CURRENT_DATE - f.client_communication_date) <= 120 THEN '61 - 90 Days'
            ELSE '90+ Days'
        END AS ageing_bucket
    FROM chapter_filtered f
),

chapter_payment_dates AS (
    SELECT
        dt.id AS delivery_timeline_id,
        MIN(
            CASE 
                WHEN t.transaction_type = 'collection'
                     AND t.deleted_at IS NULL
                THEN t.payment_date
            END
        ) AS payment_date_for_advance
    FROM chapter_delivery_timelines dt
    LEFT JOIN chapter_delivery_timeline_details t
        ON dt.id = t.chapter_delivery_timeline_id
    WHERE dt.deleted_at IS NULL
    GROUP BY dt.id
),

chapter_advances AS (
    SELECT
        bd.property,
        bd.sub_phase,
        bd.step,
        bd.delivery_tracker_status,
        bd.client_communication_date,
        bd.base_amount_paid,
        pd.payment_date_for_advance,
        bd.delivery_timeline_id     -- :point_left: add this
    FROM chapter_base_data bd
    LEFT JOIN chapter_payment_dates pd
        ON bd.delivery_timeline_id = pd.delivery_timeline_id
    WHERE
        bd.base_amount_paid > 0
        AND bd.client_communication_date > CURRENT_DATE
        AND pd.payment_date_for_advance IS NOT NULL
        AND (
            bd.client_communication_date IS NULL
            OR pd.payment_date_for_advance < bd.client_communication_date
        )
        AND bd.delivery_tracker_status in ( 'upcoming', 'not_due')
),

chapter_additional_advances AS (
    SELECT
        bd.property,
        bd.sub_phase,
        bd.step,
        bd.delivery_tracker_status,
        bd.client_communication_date,
        bd.base_amount_paid,
        pd.payment_date_for_advance,
        bd.delivery_timeline_id     -- optional, but usually useful downstream
    FROM chapter_base_data bd
    LEFT JOIN chapter_payment_dates pd
        ON bd.delivery_timeline_id = pd.delivery_timeline_id
    WHERE
        bd.sub_phase = 'additional'
        AND bd.base_amount_paid > 0
        AND bd.client_communication_date > CURRENT_DATE
        AND pd.payment_date_for_advance < bd.client_communication_date
        AND NOT EXISTS (
            SELECT 1
            FROM chapter_advances ia
            WHERE ia.delivery_timeline_id = bd.delivery_timeline_id
        )
),

chapter_ageing_agg AS (
    SELECT
        property,
        step,
        ageing_bucket,
        ROUND(SUM(pending_amount)::numeric, 2) AS amount_in_cr
    FROM chapter_ageing
    GROUP BY property, step, ageing_bucket
),

chapter_advances_agg AS (
    SELECT
        property,
        step,
        'Advance'::text AS ageing_bucket,
        ROUND((SUM(base_amount_paid)::numeric * -1), 2) AS amount_in_cr
    FROM (
        SELECT * FROM chapter_advances
        UNION ALL
        SELECT * FROM chapter_additional_advances
    ) x
    GROUP BY property, step
)

/* =========================
   FINAL: UNION ALL both sources and add brand
   ========================= */
SELECT
    property,
    step,
    ageing_bucket,
    amount_in_cr,
    'Isprava' AS brand,
    CASE 
        WHEN ageing_bucket = 'Within Timelines' THEN 1
        WHEN ageing_bucket = '0 - 30 Days' THEN 2
        WHEN ageing_bucket = '31 - 60 Days' THEN 3
        WHEN ageing_bucket = '61 - 90 Days' THEN 4
        WHEN ageing_bucket = '90+ Days' THEN 5
        WHEN ageing_bucket = 'Advance' THEN 6
        ELSE 7
    END AS sort_key
FROM isprava_ageing_agg

UNION ALL

SELECT
    property,
    step,
    ageing_bucket,
    amount_in_cr,
    'Isprava' AS brand,
    6 AS sort_key
FROM isprava_advances_agg

UNION ALL

SELECT
    property,
    step,
    ageing_bucket,
    amount_in_cr,
    'Chapter' AS brand,
    CASE 
        WHEN ageing_bucket = 'Within Timelines' THEN 1
        WHEN ageing_bucket = '0 - 30 Days' THEN 2
        WHEN ageing_bucket = '31 - 60 Days' THEN 3
        WHEN ageing_bucket = '61 - 90 Days' THEN 4
        WHEN ageing_bucket = '90+ Days' THEN 5
        WHEN ageing_bucket = 'Advance' THEN 6
        ELSE 7
    END AS sort_key
FROM chapter_ageing_agg

UNION ALL

SELECT
    property,
    step,
    ageing_bucket,
    amount_in_cr,
    'Chapter' AS brand,
    6 AS sort_key
FROM chapter_advances_agg

ORDER BY sort_key, brand, property, step, amount_in_cr DESC;"
YTD Funnel - Isprava,"select * from
(
select  a.metric,
    (coalesce((leads),0) + coalesce((leads2),0)) as count
    from
(    
select 'Leads' as metric,
count(distinct(development_opportunities.slug)) as leads
FROM development_opportunities
WHERE date(enquired_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
and development_opportunities.source != 'DnB'
) a

left join
(
select 'Leads' as metric,
      count(id) as leads2
from enquiries
WHERE enquiries.vertical='development'
and enquiry_type='enquiry'
and leadable_id is null
and date(enquiries.created_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
) b on a.metric=b.metric

union 

SELECT 'Prospects' as metric,
count(distinct(development_opportunities.slug)) as prospects
FROM development_opportunities
WHERE date(lead_completed_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')

union


SELECT 'Accounts' as metric,
      count(distinct(development_opportunities.slug)) as accounts
FROM development_opportunities
WHERE date(prospect_completed_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')

union 

SELECT  'Sales',
        count(distinct(development_opportunities.slug))
   FROM development_opportunities
   WHERE date(maal_laao_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes') 
   OR development_opportunities.slug = 'd-ref-a2ff7f98' OR development_opportunities.slug = '7A5D8F55'
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
) x
order by case when metric='Leads' then '1'
              when metric = 'Prospects' then '2'
              when metric='Accounts' then '3'
              else metric end"
LYTD - Funnel Isprava,"select * from
(
select  a.metric,
    (coalesce((leads),0) + coalesce((leads2),0)) as count
    from
(    
select 'Leads' as metric,
count(distinct(development_opportunities.slug)) as leads
FROM development_opportunities
WHERE enquired_at::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
and development_opportunities.source != 'DnB'
) a

left join
(
select 'Leads' as metric,
      count(id) as leads2
from enquiries
WHERE enquiries.vertical='development'
and enquiry_type='enquiry'
and leadable_id is null
and enquiries.created_at::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
) b on a.metric=b.metric

union 

SELECT 'Prospects' as metric,
count(distinct(development_opportunities.slug)) as prospects
FROM development_opportunities
WHERE lead_completed_at::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')

union


SELECT 'Accounts' as metric,
      count(distinct(development_opportunities.slug)) as accounts
FROM development_opportunities
WHERE prospect_completed_at::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')

union 

SELECT  'Sales',
        count(distinct(development_opportunities.slug))
   FROM development_opportunities
   WHERE maal_laao_at::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
) x
order by case when metric='Leads' then '1'
              when metric = 'Prospects' then '2'
              when metric='Accounts' then '3'
              else metric end"
FY 24-25 - Isprava,"select * from
(
select  a.metric,
    (coalesce((leads),0) + coalesce((leads2),0)) as count
    from
(    
select 'Leads' as metric,
count(distinct(development_opportunities.slug)) as leads
FROM development_opportunities
WHERE date(enquired_at + interval '330 minutes') between '2024-04-01' and '2025-03-31'
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
and development_opportunities.source != 'DnB'
) a

left join
(
select 'Leads' as metric,
      count(id) as leads2
from enquiries
WHERE enquiries.vertical='development'
and enquiry_type='enquiry'
and leadable_id is null
and date(enquiries.created_at + interval '330 minutes') between '2024-04-01' and '2025-03-31'
) b on a.metric=b.metric

union 

SELECT 'Prospects' as metric,
count(distinct(development_opportunities.slug)) as prospects
FROM development_opportunities
WHERE date(lead_completed_at + interval '330 minutes') between '2024-04-01' and '2025-03-31'
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')

union


SELECT 'Accounts' as metric,
      count(distinct(development_opportunities.slug)) as accounts
FROM development_opportunities
WHERE date(prospect_completed_at + interval '330 minutes') between '2024-04-01' and '2025-03-31'
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')

union 

SELECT  'Sales',
        count(distinct(development_opportunities.slug))
   FROM development_opportunities
   WHERE date(maal_laao_at + interval '330 minutes') between '2024-04-01' and '2025-03-31'
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
) x
order by case when metric='Leads' then '1'
              when metric = 'Prospects' then '2'
              when metric='Accounts' then '3'
              else metric end"
YTD Funnel  - Chapter,"select * from
(
select  a.metric,
    (coalesce((leads),0) + coalesce((leads2),0)) as count
    from
(    
select 'Leads' as metric,
count(distinct(chapter_opportunities.slug)) as leads
FROM chapter_opportunities
WHERE date(enquired_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
) a

left join
(
select 'Leads' as metric,
      count(id) as leads2
from enquiries
WHERE enquiries.vertical='chapter'
and enquiry_type='enquiry'
and leadable_id is null
and date(enquiries.created_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
and (lower(enquiries.name) not like '%test%' and lower(enquiries.name) not like 'test%'
and lower(enquiries.name) != 'test')
) b on a.metric=b.metric

union 

SELECT 'Prospects' as metric,
count(distinct(chapter_opportunities.slug)) as prospects
FROM chapter_opportunities
WHERE date(lead_completed_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')

union


SELECT 'Accounts' as metric,
      count(distinct(chapter_opportunities.slug)) as accounts
FROM chapter_opportunities
WHERE date(prospect_completed_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')

union 

SELECT  'Sales',
        count(distinct(chapter_opportunities.slug))
   FROM chapter_opportunities
   WHERE date(maal_laao_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
) x
order by case when metric='Leads' then '1'
              when metric = 'Prospects' then '2'
              when metric='Accounts' then '3'
              else metric end"
LYTD Funnel - Chapter,"select * from
(
select  a.metric,
    (coalesce((leads),0) + coalesce((leads2),0)) as count
    from
(    
select 'Leads' as metric,
count(distinct(development_opportunities.slug)) as leads
FROM development_opportunities
WHERE enquired_at::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
and development_opportunities.source != 'DnB'
) a

left join
(
select 'Leads' as metric,
      count(id) as leads2
from enquiries
WHERE enquiries.vertical='development'
and enquiry_type='enquiry'
and leadable_id is null
and enquiries.created_at::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
) b on a.metric=b.metric

union 

SELECT 'Prospects' as metric,
count(distinct(development_opportunities.slug)) as prospects
FROM development_opportunities
WHERE lead_completed_at::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')

union


SELECT 'Accounts' as metric,
      count(distinct(development_opportunities.slug)) as accounts
FROM development_opportunities
WHERE prospect_completed_at::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')

union 

SELECT  'Sales',
        count(distinct(development_opportunities.slug))
   FROM development_opportunities
   WHERE maal_laao_at::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
) x
order by case when metric='Leads' then '1'
              when metric = 'Prospects' then '2'
              when metric='Accounts' then '3'
              else metric end"
FY 24-24 - Chapter,"select * from
(
select  a.metric,
    (coalesce((leads),0) + coalesce((leads2),0)) as count
    from
(    
select 'Leads' as metric,
count(distinct(chapter_opportunities.slug)) as leads
FROM chapter_opportunities
WHERE date(enquired_at + interval '330 minutes') between '2024-04-01' and '2025-03-31'
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
) a

left join
(
select 'Leads' as metric,
      count(id) as leads2
from enquiries
WHERE enquiries.vertical='chapter'
and enquiry_type='enquiry'
and leadable_id is null
and (lower(enquiries.name) not like '%test%' and lower(enquiries.name) not like 'test%'
and lower(enquiries.name) != 'test')
and date(enquiries.created_at + interval '330 minutes') between '2024-04-01' and '2025-03-31'
) b on a.metric=b.metric

union 

SELECT 'Prospects' as metric,
count(distinct(chapter_opportunities.slug)) as prospects
FROM chapter_opportunities
WHERE date(lead_completed_at + interval '330 minutes') between '2024-04-01' and '2025-03-31'
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')

union


SELECT 'Accounts' as metric,
      count(distinct(chapter_opportunities.slug)) as accounts
FROM chapter_opportunities
WHERE date(prospect_completed_at + interval '330 minutes') between '2024-04-01' and '2025-03-31'
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')

union 

SELECT  'Sales',
        count(distinct(chapter_opportunities.slug))
   FROM chapter_opportunities
   WHERE date(maal_laao_at + interval '330 minutes') between '2024-04-01' and '2025-03-31'
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
) x
order by case when metric='Leads' then '1'
              when metric = 'Prospects' then '2'
              when metric='Accounts' then '3'
              else metric end"
Weekly Insights - Isprava,"-- Isprava Marketing Leads (Leads includes Enquiries) - Year-over-Year Comparison
WITH date_ranges AS (
  SELECT
    /* Last Week (most recent fully completed week) */
    (date_trunc('week', current_date) - interval '7 days')::date  AS last_week_start,
    (date_trunc('week', current_date) - interval '1 day')::date   AS last_week_end,

    /* Last-to-Last Week (two weeks ago) */
    (date_trunc('week', current_date) - interval '14 days')::date AS l2w_start,
    (date_trunc('week', current_date) - interval '8 days')::date  AS l2w_end,

    /* Last 12 Completed Weeks (EXCLUDES current week) */
    (date_trunc('week', current_date) - interval '84 days')::date AS last_12w_start,
    (date_trunc('week', current_date) - interval '1 day')::date   AS last_12w_end,

    /* Same 12 weeks period from last year (365 days back) */
    ((date_trunc('week', current_date) - interval '84 days') - interval '365 days')::date AS ly_12w_start,
    ((date_trunc('week', current_date) - interval '1 day') - interval '365 days')::date   AS ly_12w_end
),

get_source AS (
  SELECT 
    slug, 
    CASE 
      WHEN source = 'agent' THEN 'Agent'
      WHEN source IN ('direct_mailer','emailer','google','facebook','instagram','linkedin','youtube','signage','isprava','isprava.com','isprava.com_chatbot','direct_call') THEN 'Digital'
      WHEN source IN ('lohono.com','lohono') THEN 'Lohono'
      WHEN source IN ('reference','word_of_mouth','isprava_employee','chapter_employee','chapter_reference','homeowner_ref') THEN 'Reference + Word of Mouth'
      WHEN source = 'repeat_client' THEN 'Repeat Client'
      ELSE 'Other'
    END AS source,
    date(enquired_at + interval '330 minutes')         AS enquired_at,
    date(lead_completed_at + interval '330 minutes')   AS lead_completed_at,
    date(prospect_completed_at + interval '330 minutes') AS prospect_completed_at,
    date(maal_laao_at + interval '330 minutes')        AS maal_laao_at
  FROM development_opportunities
  WHERE slug NOT IN ('569657C6','5EB1A14A','075E54DF') 
    AND source != 'DnB'
),

get_enquiries AS (
  SELECT
    CASE 
      WHEN enquiries.source = 'agent' THEN 'Agent'
      WHEN enquiries.source IN ('direct_mailer','emailer','google','facebook','instagram','linkedin','youtube','signage','isprava','isprava.com','isprava.com_chatbot','direct_call') THEN 'Digital'
      WHEN enquiries.source IN ('lohono.com','lohono') THEN 'Lohono'
      WHEN enquiries.source IN ('reference','word_of_mouth','isprava_employee','chapter_employee','chapter_reference','homeowner_ref') THEN 'Reference + Word of Mouth'
      WHEN enquiries.source = 'repeat_client' THEN 'Repeat Client'
      ELSE 'Other'
    END AS source,
    date(enquiries.created_at + interval '330 minutes') AS enquired_at
  FROM enquiries
  WHERE enquiries.vertical = 'development'
    AND enquiries.enquiry_type = 'enquiry'
    AND enquiries.leadable_id IS NULL
),

-- Combine DO Leads + Enquiry Leads
all_leads AS (
  SELECT enquired_at FROM get_source
  UNION ALL
  SELECT enquired_at FROM get_enquiries
),

metrics AS (

  /* LEADS */
  SELECT 
    1 AS sort_order,
    'Leads' AS metric,
    SUM(CASE WHEN al.enquired_at BETWEEN dr.last_week_start AND dr.last_week_end THEN 1 ELSE 0 END)::int AS last_week,
    SUM(CASE WHEN al.enquired_at BETWEEN dr.l2w_start AND dr.l2w_end THEN 1 ELSE 0 END)::int AS last_to_last_week,
    ROUND(SUM(CASE WHEN al.enquired_at BETWEEN dr.last_12w_start AND dr.last_12w_end THEN 1 ELSE 0 END)::numeric / 12, 2) AS last_12w_avg,
    ROUND(SUM(CASE WHEN al.enquired_at BETWEEN dr.ly_12w_start AND dr.ly_12w_end THEN 1 ELSE 0 END)::numeric / 12, 2) AS ly_12w_avg
  FROM all_leads al, date_ranges dr


  UNION ALL

  /* PROSPECTS */
  SELECT 
    2 AS sort_order,
    'Prospects' AS metric,
    SUM(CASE WHEN lead_completed_at BETWEEN dr.last_week_start AND dr.last_week_end THEN 1 ELSE 0 END)::int AS last_week,
    SUM(CASE WHEN lead_completed_at BETWEEN dr.l2w_start AND dr.l2w_end THEN 1 ELSE 0 END)::int AS last_to_last_week,
    ROUND(SUM(CASE WHEN lead_completed_at BETWEEN dr.last_12w_start AND dr.last_12w_end THEN 1 ELSE 0 END)::numeric / 12, 2) AS last_12w_avg,
    ROUND(SUM(CASE WHEN lead_completed_at BETWEEN dr.ly_12w_start AND dr.ly_12w_end THEN 1 ELSE 0 END)::numeric / 12, 2) AS ly_12w_avg
  FROM get_source, date_ranges dr
  WHERE lead_completed_at IS NOT NULL


  UNION ALL

  /* ACCOUNTS */
  SELECT 
    3 AS sort_order,
    'Accounts' AS metric,
    SUM(CASE WHEN prospect_completed_at BETWEEN dr.last_week_start AND dr.last_week_end THEN 1 ELSE 0 END)::int AS last_week,
    SUM(CASE WHEN prospect_completed_at BETWEEN dr.l2w_start AND dr.l2w_end THEN 1 ELSE 0 END)::int AS last_to_last_week,
    ROUND(SUM(CASE WHEN prospect_completed_at BETWEEN dr.last_12w_start AND dr.last_12w_end THEN 1 ELSE 0 END)::numeric / 12, 2) AS last_12w_avg,
    ROUND(SUM(CASE WHEN prospect_completed_at BETWEEN dr.ly_12w_start AND dr.ly_12w_end THEN 1 ELSE 0 END)::numeric / 12, 2) AS ly_12w_avg
  FROM get_source, date_ranges dr
  WHERE prospect_completed_at IS NOT NULL


  UNION ALL

  /* SALES */
  SELECT 
    4 AS sort_order,
    'Sales' AS metric,
    SUM(CASE WHEN maal_laao_at BETWEEN dr.last_week_start AND dr.last_week_end THEN 1 ELSE 0 END)::int AS last_week,
    SUM(CASE WHEN maal_laao_at BETWEEN dr.l2w_start AND dr.l2w_end THEN 1 ELSE 0 END)::int AS last_to_last_week,
    ROUND(SUM(CASE WHEN maal_laao_at BETWEEN dr.last_12w_start AND dr.last_12w_end THEN 1 ELSE 0 END)::numeric / 12, 2) AS last_12w_avg,
    ROUND(SUM(CASE WHEN maal_laao_at BETWEEN dr.ly_12w_start AND dr.ly_12w_end THEN 1 ELSE 0 END)::numeric / 12, 2) AS ly_12w_avg
  FROM get_source, date_ranges dr
  WHERE maal_laao_at IS NOT NULL
)

SELECT 
  metric, 
  last_week, 
  last_to_last_week, 
  last_12w_avg,
  ly_12w_avg AS last_year_12w_avg
FROM metrics
ORDER BY sort_order;"
Weekly Insights - Chapter,"-- Chapter Marketing Leads (Leads includes Enquiries) - Year-over-Year Comparison
WITH date_ranges AS (
  SELECT
    /* Last Week (most recent fully completed week) */
    (date_trunc('week', current_date) - interval '7 days')::date  AS last_week_start,
    (date_trunc('week', current_date) - interval '1 day')::date   AS last_week_end,

    /* Last-to-Last Week (two weeks ago) */
    (date_trunc('week', current_date) - interval '14 days')::date AS l2w_start,
    (date_trunc('week', current_date) - interval '8 days')::date  AS l2w_end,

    /* Last 12 Completed Weeks (EXCLUDES current week) */
    (date_trunc('week', current_date) - interval '84 days')::date AS last_12w_start,
    (date_trunc('week', current_date) - interval '1 day')::date   AS last_12w_end,

    /* Same 12 weeks period from last year (365 days back) */
    ((date_trunc('week', current_date) - interval '84 days') - interval '365 days')::date AS ly_12w_start,
    ((date_trunc('week', current_date) - interval '1 day') - interval '365 days')::date   AS ly_12w_end
),

get_source AS (
  SELECT 
    slug, 
    CASE 
      WHEN source = 'agent' THEN 'Agent'
      WHEN source IN ('direct_mailer','emailer','google','facebook','instagram','linkedin','youtube','signage','isprava','isprava.com','isprava.com_chatbot','direct_call') THEN 'Digital'
      WHEN source IN ('lohono.com','lohono') THEN 'Lohono'
      WHEN source IN ('reference','word_of_mouth','isprava_employee','chapter_employee','chapter_reference','homeowner_ref') THEN 'Reference + Word of Mouth'
      WHEN source = 'repeat_client' THEN 'Repeat Client'
      ELSE 'Other'
    END AS source,
    date(enquired_at + interval '330 minutes')         AS enquired_at,
    date(lead_completed_at + interval '330 minutes')   AS lead_completed_at,
    date(prospect_completed_at + interval '330 minutes') AS prospect_completed_at,
    date(maal_laao_at + interval '330 minutes')        AS maal_laao_at
  FROM chapter_opportunities
  WHERE (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
    and lower(chapter_opportunities.name) != 'test')
    and chapter_opportunities.source != 'DnB'
),

get_enquiries AS (
  SELECT
    CASE 
      WHEN enquiries.source = 'agent' THEN 'Agent'
      WHEN enquiries.source IN ('direct_mailer','emailer','google','facebook','instagram','linkedin','youtube','signage','isprava','isprava.com','isprava.com_chatbot','direct_call') THEN 'Digital'
      WHEN enquiries.source IN ('lohono.com','lohono') THEN 'Lohono'
      WHEN enquiries.source IN ('reference','word_of_mouth','isprava_employee','chapter_employee','chapter_reference','homeowner_ref') THEN 'Reference + Word of Mouth'
      WHEN enquiries.source = 'repeat_client' THEN 'Repeat Client'
      ELSE 'Other'
    END AS source,
    date(enquiries.created_at + interval '330 minutes') AS enquired_at
  FROM enquiries
  WHERE enquiries.vertical = 'chapter'
    AND enquiries.enquiry_type = 'enquiry'
    AND enquiries.leadable_id IS NULL
    AND (lower(enquiries.name) not like '%test%' and lower(enquiries.name) not like 'test%'
    and lower(enquiries.name) != 'test')

),

-- Combine Chapter Opportunities + Enquiry Leads
all_leads AS (
  SELECT enquired_at FROM get_source
  UNION ALL
  SELECT enquired_at FROM get_enquiries
),

metrics AS (

  /* LEADS */
  SELECT 
    1 AS sort_order,
    'Leads' AS metric,
    SUM(CASE WHEN al.enquired_at BETWEEN dr.last_week_start AND dr.last_week_end THEN 1 ELSE 0 END)::int AS last_week,
    SUM(CASE WHEN al.enquired_at BETWEEN dr.l2w_start AND dr.l2w_end THEN 1 ELSE 0 END)::int AS last_to_last_week,
    ROUND(SUM(CASE WHEN al.enquired_at BETWEEN dr.last_12w_start AND dr.last_12w_end THEN 1 ELSE 0 END)::numeric / 12, 2) AS last_12w_avg,
    ROUND(SUM(CASE WHEN al.enquired_at BETWEEN dr.ly_12w_start AND dr.ly_12w_end THEN 1 ELSE 0 END)::numeric / 12, 2) AS ly_12w_avg
  FROM all_leads al, date_ranges dr


  UNION ALL

  /* PROSPECTS */
  SELECT 
    2 AS sort_order,
    'Prospects' AS metric,
    SUM(CASE WHEN lead_completed_at BETWEEN dr.last_week_start AND dr.last_week_end THEN 1 ELSE 0 END)::int AS last_week,
    SUM(CASE WHEN lead_completed_at BETWEEN dr.l2w_start AND dr.l2w_end THEN 1 ELSE 0 END)::int AS last_to_last_week,
    ROUND(SUM(CASE WHEN lead_completed_at BETWEEN dr.last_12w_start AND dr.last_12w_end THEN 1 ELSE 0 END)::numeric / 12, 2) AS last_12w_avg,
    ROUND(SUM(CASE WHEN lead_completed_at BETWEEN dr.ly_12w_start AND dr.ly_12w_end THEN 1 ELSE 0 END)::numeric / 12, 2) AS ly_12w_avg
  FROM get_source, date_ranges dr
  WHERE lead_completed_at IS NOT NULL


  UNION ALL

  /* ACCOUNTS */
  SELECT 
    3 AS sort_order,
    'Accounts' AS metric,
    SUM(CASE WHEN prospect_completed_at BETWEEN dr.last_week_start AND dr.last_week_end THEN 1 ELSE 0 END)::int AS last_week,
    SUM(CASE WHEN prospect_completed_at BETWEEN dr.l2w_start AND dr.l2w_end THEN 1 ELSE 0 END)::int AS last_to_last_week,
    ROUND(SUM(CASE WHEN prospect_completed_at BETWEEN dr.last_12w_start AND dr.last_12w_end THEN 1 ELSE 0 END)::numeric / 12, 2) AS last_12w_avg,
    ROUND(SUM(CASE WHEN prospect_completed_at BETWEEN dr.ly_12w_start AND dr.ly_12w_end THEN 1 ELSE 0 END)::numeric / 12, 2) AS ly_12w_avg
  FROM get_source, date_ranges dr
  WHERE prospect_completed_at IS NOT NULL


  UNION ALL

  /* SALES */
  SELECT 
    4 AS sort_order,
    'Sales' AS metric,
    SUM(CASE WHEN maal_laao_at BETWEEN dr.last_week_start AND dr.last_week_end THEN 1 ELSE 0 END)::int AS last_week,
    SUM(CASE WHEN maal_laao_at BETWEEN dr.l2w_start AND dr.l2w_end THEN 1 ELSE 0 END)::int AS last_to_last_week,
    ROUND(SUM(CASE WHEN maal_laao_at BETWEEN dr.last_12w_start AND dr.last_12w_end THEN 1 ELSE 0 END)::numeric / 12, 2) AS last_12w_avg,
    ROUND(SUM(CASE WHEN maal_laao_at BETWEEN dr.ly_12w_start AND dr.ly_12w_end THEN 1 ELSE 0 END)::numeric / 12, 2) AS ly_12w_avg
  FROM get_source, date_ranges dr
  WHERE maal_laao_at IS NOT NULL
)

SELECT 
  metric, 
  last_week, 
  last_to_last_week, 
  last_12w_avg,
  ly_12w_avg AS last_year_12w_avg
FROM metrics
ORDER BY sort_order;"
Score Card MTD - Isprava,"select 
    a.metric, 
    leads + coalesce(leads2,0) as leads,
    coalesce(prospects,0) as Prospects,
    coalesce(accounts,0) as Accounts,
    coalesce(sales,0) as Sales,
    f.meetings,
    g.viewings,
    l2p::int as l2p,
    p2a::int as p2a,
    a2s::int as a2s
from
(
SELECT 'Metric' as metric,
count(distinct(development_opportunities.slug)) as leads
FROM development_opportunities
WHERE (enquired_at + interval '330 minutes')::date >= cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)
and (enquired_at + interval '330 minutes')::date < (cast(date_trunc('month',CURRENT_DATE + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',enquired_at + interval '330 minutes') <= date_part('day',now() + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
and development_opportunities.source != 'DnB'

) a 

left join
(
select 'Metric' as metric,
      count(id) as leads2
from enquiries
WHERE enquiries.vertical='development'
and enquiry_type='enquiry'
and leadable_id is null
and (created_at + interval '330 minutes')::date >= cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)
and (created_at + interval '330 minutes')::date < (cast(date_trunc('month',CURRENT_DATE + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',created_at + interval '330 minutes') <= date_part('day',now() + interval '330 minutes')
) b on a.metric = b.metric


left join
(
SELECT
    'Metric' as metric,
     count(distinct(development_opportunities.slug)) as prospects
FROM development_opportunities
WHERE (lead_completed_at + interval '330 minutes')::date >= cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)
and (lead_completed_at + interval '330 minutes')::date < (cast(date_trunc('month',CURRENT_DATE + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',lead_completed_at + interval '330 minutes') <= date_part('day',now() + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)c on a.metric = c.metric 

left join
(
SELECT
      'Metric' as metric,
      count(distinct(development_opportunities.slug)) as accounts
FROM development_opportunities
WHERE (prospect_completed_at + interval '330 minutes')::date >= cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)
and (prospect_completed_at + interval '330 minutes')::date < (cast(date_trunc('month',CURRENT_DATE + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',prospect_completed_at + interval '330 minutes') <= date_part('day',now() + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)d on a.metric = d.metric 

left join
(
SELECT 
    'Metric' as metric,
    COUNT(distinct(development_opportunities.slug)) AS sales
FROM development_opportunities
WHERE (maal_laao_at + interval '330 minutes')::date >= cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)
and (maal_laao_at + interval '330 minutes')::date < (cast(date_trunc('month',CURRENT_DATE + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',maal_laao_at + interval '330 minutes') <= date_part('day',now() + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)e on a.metric = e.metric 

left join 
(
select
    'Metric' as metric,
    count(distinct(development_opportunities.slug)) as meetings
from tasks
inner join activities on tasks.id= activities.feedable_id
inner join medium on tasks.medium_id=medium.id
inner join development_opportunities on development_opportunities.id=activities.leadable_id
WHERE (performed_at + interval '330 minutes')::date >= cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)
and (performed_at + interval '330 minutes')::date < (cast(date_trunc('month',CURRENT_DATE + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',performed_at + interval '330 minutes') <= date_part('day',now() + interval '330 minutes')
AND activities.feedable_type='Task' and activities.leadable_type='Development::Opportunity'
and ( medium.name='Meeting')
)f on a.metric = f.metric

left join
(
    select 'Metric' as metric,
    count(distinct(development_opportunities.slug)) as viewings
from tasks
inner join activities on tasks.id= activities.feedable_id
inner join medium on tasks.medium_id=medium.id
inner join development_opportunities on development_opportunities.id=activities.leadable_id
inner join staffs on staffs.id=development_opportunities.poc_exec_id
where activities.feedable_type='Task' and activities.leadable_type='Development::Opportunity'
and medium.name in ('Goa Viewing','Alibaug Viewing','Coonoor Viewing','Viewing','Site Visit')
and (performed_at + interval '330 minutes')::date >= cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)
and (performed_at + interval '330 minutes')::date < (cast(date_trunc('month',CURRENT_DATE + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',performed_at + interval '330 minutes') <= date_part('day',now() + interval '330 minutes')
) g on a.metric = g.metric

left join 
(
SELECT
    'Metric' as metric, 
    avg(date(lead_completed_at + interval '330 minutes') - date(enquired_at + interval '330 minutes')) as l2p
FROM development_opportunities
WHERE (lead_completed_at + interval '330 minutes')::date >= cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)
and (lead_completed_at + interval '330 minutes')::date < (cast(date_trunc('month',CURRENT_DATE + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',lead_completed_at + interval '330 minutes') <= date_part('day',now() + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)h on a.metric = h.metric 

left join
(
SELECT
      'Metric' as metric,
      avg(date(prospect_completed_at + interval '330 minutes') - date(lead_completed_at + interval '330 minutes')) as p2a
FROM development_opportunities
WHERE (prospect_completed_at + interval '330 minutes')::date >= cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)
and (prospect_completed_at + interval '330 minutes')::date < (cast(date_trunc('month',CURRENT_DATE + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',prospect_completed_at + interval '330 minutes') <= date_part('day',now() + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)i on a.metric = i.metric 

left join
(
SELECT 
    'Metric' as metric,
    avg(date(maal_laao_at + interval '330 minutes') - date(prospect_completed_at + interval '330 minutes')) as a2s
FROM development_opportunities
WHERE (maal_laao_at + interval '330 minutes')::date >= cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)
and (maal_laao_at + interval '330 minutes')::date < (cast(date_trunc('month',CURRENT_DATE + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',maal_laao_at + interval '330 minutes') <= date_part('day',now() + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)j on a.metric = j.metric "
LYMTD Scorecard - Isprava,"SELECT 
a.metric,
leads + coalesce(leads2,0) as leads,
coalesce(prospects,0) as Prospects,
coalesce(accounts,0) as Accounts,
coalesce(sales,0) as Sales,
f.meetings,
g.viewings,
l2p::int,
p2a::int,
a2s::int

FROM
(
SELECT 'Metric' as metric,
  count(distinct(development_opportunities.slug)) as leads
FROM development_opportunities
WHERE (enquired_at + interval '330 minutes')::date >= 
        cast(date_trunc('month', (CURRENT_DATE - interval '1 year') + interval '330 minutes') AS date)
  AND (enquired_at + interval '330 minutes')::date < 
        cast(date_trunc('month', (CURRENT_DATE - interval '1 year') + interval '330 minutes' + INTERVAL '1 MONTH') AS date)
  AND date_part('day', enquired_at + interval '330 minutes') <= 
        date_part('day', (now() - interval '1 year') + interval '330 minutes')
  AND development_opportunities.slug NOT IN ('569657C6','5EB1A14A','075E54DF')
  and development_opportunities.source != 'DnB'
) a

left join
(
select 'Metric' as metric,
      count(id) as leads2
from enquiries
WHERE enquiries.vertical='development'
and enquiry_type='enquiry'
and leadable_id is null
and (created_at + interval '330 minutes')::date >= 
    cast(date_trunc('month', (CURRENT_DATE - interval '1 year') + interval '330 minutes') AS date)
and (created_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',created_at + interval '330 minutes') <= 
    date_part('day',(now() - interval '1 year') + interval '330 minutes')
) b on a.metric = b.metric

left join
(
SELECT
    'Metric' as metric,
     count(distinct(development_opportunities.slug)) as prospects
FROM development_opportunities
WHERE (lead_completed_at + interval '330 minutes')::date >=
    cast(date_trunc('month',(CURRENT_DATE-interval '1 year') + interval '330 minutes') AS date)
and (lead_completed_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',lead_completed_at + interval '330 minutes') <= 
    date_part('day',(now()- interval '1 day') + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)c on a.metric = c.metric 

left join
(
SELECT
      'Metric' as metric,
      count(distinct(development_opportunities.slug)) as accounts
FROM development_opportunities
WHERE (prospect_completed_at + interval '330 minutes')::date >= 
    cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes') AS date)
and (prospect_completed_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',prospect_completed_at + interval '330 minutes') <= 
    date_part('day',(now()- interval '1 day') + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)d on a.metric = d.metric 

left join
(
SELECT 
    'Metric' as metric,
    COUNT(distinct(development_opportunities.slug)) AS sales
FROM development_opportunities
WHERE (maal_laao_at + interval '330 minutes')::date >= 
    cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes') AS date)
and (maal_laao_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',maal_laao_at + interval '330 minutes') <= 
    date_part('day',(now()- interval '1 day') + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)e on a.metric = e.metric 

left join 
(
select
    'Metric' as metric,
    count(distinct(development_opportunities.slug)) as meetings
from tasks
inner join activities on tasks.id= activities.feedable_id
inner join medium on tasks.medium_id=medium.id
inner join development_opportunities on development_opportunities.id=activities.leadable_id
WHERE (performed_at + interval '330 minutes')::date >= 
    cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes') AS date)
and (performed_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',performed_at + interval '330 minutes') <= 
    date_part('day',(now()- interval '1 day') + interval '330 minutes')
AND activities.feedable_type='Task' and activities.leadable_type='Development::Opportunity'
and ( medium.name='Meeting')
)f on a.metric = f.metric

left join
(
    select 'Metric' as metric,
    count(distinct(development_opportunities.slug)) as viewings
from tasks
inner join activities on tasks.id= activities.feedable_id
inner join medium on tasks.medium_id=medium.id
inner join development_opportunities on development_opportunities.id=activities.leadable_id
inner join staffs on staffs.id=development_opportunities.poc_exec_id
where activities.feedable_type='Task' and activities.leadable_type='Development::Opportunity'
and medium.name in ('Goa Viewing','Alibaug Viewing','Coonoor Viewing','Viewing','Site Visit')
and (performed_at + interval '330 minutes')::date >= 
    cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes') AS date)
and (performed_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',performed_at + interval '330 minutes') <= 
    date_part('day',(now()- interval '1 day') + interval '330 minutes')
) g on a.metric = g.metric

left join 
(
SELECT
    'Metric' as metric, 
    avg(date(lead_completed_at + interval '330 minutes') - date(enquired_at + interval '330 minutes')) as l2p
FROM development_opportunities
WHERE (lead_completed_at + interval '330 minutes')::date >= 
    cast(date_trunc('month',(CURRENT_DATE - interval '1 year') + interval '330 minutes') AS date)
and (lead_completed_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE - interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',lead_completed_at + interval '330 minutes') <= 
    date_part('day',(now() - interval '1 year') + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)h on a.metric = h.metric 

left join
(
SELECT
      'Metric' as metric,
      avg(date(prospect_completed_at + interval '330 minutes') - date(lead_completed_at + interval '330 minutes')) as p2a
FROM development_opportunities
WHERE (prospect_completed_at + interval '330 minutes')::date >= 
    cast(date_trunc('month',(CURRENT_DATE - interval '1 year') + interval '330 minutes') AS date)
and (prospect_completed_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE - interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',prospect_completed_at + interval '330 minutes') <= 
    date_part('day',(now() - interval '1 year') + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)i on a.metric = i.metric 

left join
(
SELECT 
    'Metric' as metric,
    avg(date(maal_laao_at + interval '330 minutes') - date(prospect_completed_at + interval '330 minutes')) as a2s
FROM development_opportunities
WHERE (maal_laao_at + interval '330 minutes')::date >= 
    cast(date_trunc('month',(CURRENT_DATE - interval '1 year') + interval '330 minutes') AS date)
and (maal_laao_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE - interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',maal_laao_at + interval '330 minutes') <= 
    date_part('day',(now() - interval '1 year') + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)j on a.metric = j.metric "
MTD Source-wise Bifurcation - Isprava,"SELECT 
a.metric,
leads + coalesce(leads2,0) as leads,
coalesce(prospects,0) as Prospects,
coalesce(accounts,0) as Accounts,
coalesce(sales,0) as Sales,
f.meetings,
g.viewings,
l2p::int,
p2a::int,
a2s::int

FROM
(
SELECT 'Metric' as metric,
  count(distinct(development_opportunities.slug)) as leads
FROM development_opportunities
WHERE (enquired_at + interval '330 minutes')::date >= 
        cast(date_trunc('month', (CURRENT_DATE - interval '1 year') + interval '330 minutes') AS date)
  AND (enquired_at + interval '330 minutes')::date < 
        cast(date_trunc('month', (CURRENT_DATE - interval '1 year') + interval '330 minutes' + INTERVAL '1 MONTH') AS date)
  AND date_part('day', enquired_at + interval '330 minutes') <= 
        date_part('day', (now() - interval '1 year') + interval '330 minutes')
  AND development_opportunities.slug NOT IN ('569657C6','5EB1A14A','075E54DF')
  and development_opportunities.source != 'DnB'
) a

left join
(
select 'Metric' as metric,
      count(id) as leads2
from enquiries
WHERE enquiries.vertical='development'
and enquiry_type='enquiry'
and leadable_id is null
and (created_at + interval '330 minutes')::date >= 
    cast(date_trunc('month', (CURRENT_DATE - interval '1 year') + interval '330 minutes') AS date)
and (created_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',created_at + interval '330 minutes') <= 
    date_part('day',(now() - interval '1 year') + interval '330 minutes')
) b on a.metric = b.metric

left join
(
SELECT
    'Metric' as metric,
     count(distinct(development_opportunities.slug)) as prospects
FROM development_opportunities
WHERE (lead_completed_at + interval '330 minutes')::date >=
    cast(date_trunc('month',(CURRENT_DATE-interval '1 year') + interval '330 minutes') AS date)
and (lead_completed_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',lead_completed_at + interval '330 minutes') <= 
    date_part('day',(now()- interval '1 day') + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)c on a.metric = c.metric 

left join
(
SELECT
      'Metric' as metric,
      count(distinct(development_opportunities.slug)) as accounts
FROM development_opportunities
WHERE (prospect_completed_at + interval '330 minutes')::date >= 
    cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes') AS date)
and (prospect_completed_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',prospect_completed_at + interval '330 minutes') <= 
    date_part('day',(now()- interval '1 day') + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)d on a.metric = d.metric 

left join
(
SELECT 
    'Metric' as metric,
    COUNT(distinct(development_opportunities.slug)) AS sales
FROM development_opportunities
WHERE (maal_laao_at + interval '330 minutes')::date >= 
    cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes') AS date)
and (maal_laao_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',maal_laao_at + interval '330 minutes') <= 
    date_part('day',(now()- interval '1 day') + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)e on a.metric = e.metric 

left join 
(
select
    'Metric' as metric,
    count(distinct(development_opportunities.slug)) as meetings
from tasks
inner join activities on tasks.id= activities.feedable_id
inner join medium on tasks.medium_id=medium.id
inner join development_opportunities on development_opportunities.id=activities.leadable_id
WHERE (performed_at + interval '330 minutes')::date >= 
    cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes') AS date)
and (performed_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',performed_at + interval '330 minutes') <= 
    date_part('day',(now()- interval '1 day') + interval '330 minutes')
AND activities.feedable_type='Task' and activities.leadable_type='Development::Opportunity'
and ( medium.name='Meeting')
)f on a.metric = f.metric

left join
(
    select 'Metric' as metric,
    count(distinct(development_opportunities.slug)) as viewings
from tasks
inner join activities on tasks.id= activities.feedable_id
inner join medium on tasks.medium_id=medium.id
inner join development_opportunities on development_opportunities.id=activities.leadable_id
inner join staffs on staffs.id=development_opportunities.poc_exec_id
where activities.feedable_type='Task' and activities.leadable_type='Development::Opportunity'
and medium.name in ('Goa Viewing','Alibaug Viewing','Coonoor Viewing','Viewing','Site Visit')
and (performed_at + interval '330 minutes')::date >= 
    cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes') AS date)
and (performed_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',performed_at + interval '330 minutes') <= 
    date_part('day',(now()- interval '1 day') + interval '330 minutes')
) g on a.metric = g.metric

left join 
(
SELECT
    'Metric' as metric, 
    avg(date(lead_completed_at + interval '330 minutes') - date(enquired_at + interval '330 minutes')) as l2p
FROM development_opportunities
WHERE (lead_completed_at + interval '330 minutes')::date >= 
    cast(date_trunc('month',(CURRENT_DATE - interval '1 year') + interval '330 minutes') AS date)
and (lead_completed_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE - interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',lead_completed_at + interval '330 minutes') <= 
    date_part('day',(now() - interval '1 year') + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)h on a.metric = h.metric 

left join
(
SELECT
      'Metric' as metric,
      avg(date(prospect_completed_at + interval '330 minutes') - date(lead_completed_at + interval '330 minutes')) as p2a
FROM development_opportunities
WHERE (prospect_completed_at + interval '330 minutes')::date >= 
    cast(date_trunc('month',(CURRENT_DATE - interval '1 year') + interval '330 minutes') AS date)
and (prospect_completed_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE - interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',prospect_completed_at + interval '330 minutes') <= 
    date_part('day',(now() - interval '1 year') + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)i on a.metric = i.metric 

left join
(
SELECT 
    'Metric' as metric,
    avg(date(maal_laao_at + interval '330 minutes') - date(prospect_completed_at + interval '330 minutes')) as a2s
FROM development_opportunities
WHERE (maal_laao_at + interval '330 minutes')::date >= 
    cast(date_trunc('month',(CURRENT_DATE - interval '1 year') + interval '330 minutes') AS date)
and (maal_laao_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE - interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',maal_laao_at + interval '330 minutes') <= 
    date_part('day',(now() - interval '1 year') + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)j on a.metric = j.metric "
Open Leads- Isprava,"select a.*, '-' as trash FROM
(
SELECT development_opportunities.slug,
       development_opportunities.name,
 development_opportunities.current_stage,
 INITCAP(REPLACE(development_opportunities.status,'_',' ')) as status,
 development_opportunities.interested_location,
 date(development_opportunities.enquired_at + interval '330 minutes') as enquired_date,
 to_char(date(development_opportunities.enquired_at + interval '330 minutes'),'Mon-YY') as enquired_month,
 development_opportunities.source,
 agents.name as agent_name,
 development_opportunities.source_city,
 development_opportunities.source_region,
 --development_opportunities.interested_home_types,
 development_opportunities.source_others,
 staffs1.name AS poc_exec_name,
 staffs2.name AS poc_head_name,
 development_opportunities.meta -> 'utm_source' as utm_source,	development_opportunities.meta -> 'utm_campaign' as utm_campaign, 
 development_opportunities.meta -> 'utm_medium' as utm_medium
FROM development_opportunities
left join agents on agents.id=development_opportunities.agent_id
LEFT JOIN staffs AS staffs1 ON development_opportunities.poc_exec_id = staffs1.id
LEFT JOIN staffs AS staffs2 ON development_opportunities.poc_head_id = staffs2.id
where development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
  and development_opportunities.status != 'closed'
) as a


WHERE (a.enquired_date + interval '330 minutes')::date >= cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)
and (a.enquired_date + interval '330 minutes')::date < (cast(date_trunc('month',CURRENT_DATE + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',a.enquired_date + interval '330 minutes') <= date_part('day',now() + interval '330 minutes')


union

select enquiries.slug, enquiries.name,
'Enquiry', case when is_trash=TRUE then 'trash' else 'Enquiry' end, enquiries.location, date(enquiries.created_at + interval '5 hours 30 minutes'),
to_char(date(enquiries.created_at + interval '330 minutes'),'Mon-YY') as enquired_month,
INITCAP(REPLACE(enquiries.source, '_', ' ')) AS status,
agents.name, enquiries.source_city, enquiries.source_region, '', '', '',
meta -> 'utm_source' as utm_source,	meta -> 'utm_campaign' as utm_campaign, meta -> 'utm_medium' as utm_medium,
case when is_trash is TRUE then 'Yes' else 'No' end as trash
from enquiries
left join agents on enquiries.agent_id=agents.id
WHERE enquiries.vertical='development'
and enquiry_type='enquiry'
and leadable_id is null
and is_trash=FALSE
and (enquiries.created_at + interval '330 minutes')::date >= cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)
and (enquiries.created_at + interval '330 minutes')::date < (cast(date_trunc('month',CURRENT_DATE + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',enquiries.created_at + interval '330 minutes') <= date_part('day',now() + interval '330 minutes')"
Open Prospects MTD - Isprava,"SELECT 
    slug,
    name,
    date(enquired_at + interval '330 minutes') AS enquired_date,
    date(lead_completed_at + interval '330 minutes') AS moved_to_prospect,
    date(now() + interval '330 minutes') - date(lead_completed_at + interval '330 minutes') AS ageing,
    current_stage,
    maal_laao_at,
    INITCAP(replace(status,'_',' ')) as status
FROM development_opportunities
WHERE current_stage= 'prospect'
AND (lower(name) not like '%test%' and lower(name) not like 'test%'
AND lower(name) != 'test')
and date(lead_completed_at + interval '330 minutes') >= '2022-04-01'
AND maal_laao_at IS NULL
AND status != 'closed' 
ORDER BY ageing DESC"
Open Accounts - MTD | Isprava,"SELECT 
    slug,
    name,
    current_stage,
    date(enquired_at + interval '330 minutes') AS enquired_date,
    date(prospect_completed_at + interval '330 minutes') AS moved_to_account,
    date(now() + interval '330 minutes') - date(prospect_completed_at + interval '330 minutes') AS ageing,
    maal_laao_at,
    INITCAP(replace(status,'_',' ')) as status
FROM development_opportunities
WHERE current_stage= 'account'
AND (lower(name) not like '%test%' and lower(name) not like 'test%'
and date(prospect_completed_at + interval '330 minutes') >= '2022-04-01'
AND lower(name) != 'test')
AND maal_laao_at IS NULL
AND status != 'closed' 
ORDER BY ageing DESC"
Overall Leads - Isprava,"select a.*,b.moved_to_prospect,c.moved_to_account,d.maal_laao_date, 
INITCAP(REPLACE(closed_reason,'_',' ')) AS closed_reason, explanation, '-' as Trash FROM
(
SELECT development_opportunities.slug,
       development_opportunities.name,
 development_opportunities.current_stage,
 development_opportunities.status,
 development_opportunities.interested_location,
 date(development_opportunities.enquired_at + interval '330 minutes') as enquired_date,
date_trunc('month',development_opportunities.enquired_at + interval '5 hours 30 minutes') as enquired_month,
 development_opportunities.source,
 agents.name as agent_name,
 development_opportunities.source_city,
 INITCAP(development_opportunities.source_region) as source_region,
 --development_opportunities.interested_home_types,
 development_opportunities.source_others,
 staffs1.name AS poc_exec_name,
 staffs2.name AS poc_head_name,
 development_opportunities.meta -> 'utm_source' as utm_source,	development_opportunities.meta -> 'utm_campaign' as utm_campaign, 
 development_opportunities.meta -> 'utm_medium' as utm_medium
FROM development_opportunities
left join agents on agents.id=development_opportunities.agent_id
LEFT JOIN staffs AS staffs1 ON development_opportunities.poc_exec_id = staffs1.id
LEFT JOIN staffs AS staffs2 ON development_opportunities.poc_head_id = staffs2.id
where development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
and development_opportunities.source != 'DnB'
) as a

left JOIN
(
select sub_query.slug,date(sub_query.moved_to_prospect) as moved_to_prospect,sub_query.current_stage
FROM
(
select development_opportunities.slug as slug,
stage_histories.updated_at + interval '330 minutes' as moved_to_prospect,development_opportunities.current_stage as current_stage,
 RANK() OVER (PARTITION BY stage_histories.leadable_id,
                            stage_histories.leadable_type
                             ORDER BY stage_histories.updated_at ASC) date_rank
FROM development_opportunities 
inner join stage_histories on development_opportunities.id=stage_histories.leadable_id AND leadable_type='Development::Opportunity'
inner join stages on stage_histories.stage_id=stages.id
WHERE vertical = 'development' AND code = 'prospect'
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
) sub_query
WHERE date_rank=1
) as b on a.slug=b.slug

left join
(
select sub_query.slug,date(sub_query.moved_to_account) as moved_to_account,sub_query.current_stage
FROM
(
select development_opportunities.slug as slug,
stage_histories.updated_at + interval '330 minutes' as moved_to_account,development_opportunities.current_stage as current_stage,
 RANK() OVER (PARTITION BY stage_histories.leadable_id,
                            stage_histories.leadable_type
                             ORDER BY stage_histories.updated_at ASC) date_rank
FROM development_opportunities 
inner join stage_histories on development_opportunities.id=stage_histories.leadable_id AND leadable_type='Development::Opportunity'
inner join stages on stage_histories.stage_id=stages.id
WHERE vertical = 'development' AND code = 'account'
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
) sub_query
WHERE date_rank=1
) as c on a.slug=c.slug

left join
(
SELECT x.slug,resolved_at_date_ist as maal_laao_date
FROM
  (SELECT DATE(tasks.performed_at + interval '5 hours 30 minutes') as resolved_at_date_ist,
          rank() over(PARTITION BY activities.leadable_id
                      ORDER BY tasks.performed_at) AS ranking,
          tasks.rating AS rating, development_opportunities.source as source, development_opportunities.slug
   FROM tasks
   inner join activities on tasks.id= activities.feedable_id
   INNER JOIN development_opportunities ON development_opportunities.id=activities.leadable_id
   where activities.feedable_type='Task' and activities.leadable_type='Development::Opportunity'
   AND tasks.rating = 'maal_laao'
   and (development_opportunities.slug!= 'd-0010K00001mCaxRQAS' and development_opportunities.slug!='d-0012800001IqdMOAAZ'
       and development_opportunities.slug!= 'd-0012800001Y94DuAAJ'and development_opportunities.slug!= 'd-0012800001Y947rAAB' 
       and development_opportunities.slug!='d-00Q2800000cjE3iEAE' and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
       )
 ) x
WHERE ranking = 1
group by resolved_at_date_ist, x.slug
) as d on a.slug=d.slug

left JOIN
(
select slug,case when closed_reason is null or closed_reason = '' then 'other'
when closed_reason in ('others','other') then 'other' else closed_reason end as closed_reason, explanation
from
(
select development_opportunities.slug,(jsonb_array_elements(closed_reason)->>'closed_reason_value') as closed_reason,
(jsonb_array_elements(closed_reason)->>'closed_reason_explanation') as explanation,
rank() OVER (Partition by activities.leadable_id order by tasks.performed_at asc) as ranking
from tasks
inner join activities on tasks.id= activities.feedable_id
inner join development_opportunities on development_opportunities.id=activities.leadable_id
where tasks.rating='closed' and
activities.feedable_type='Task' and activities.leadable_type='Development::Opportunity'
) x 
where ranking=1
) e on a.slug=e.slug

WHERE date(a.enquired_date) >= date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(a.enquired_date) <= date_trunc('month', CURRENT_DATE) + interval '1 month'

union

select enquiries.slug, enquiries.name,
'enquiry', '', enquiries.location, date(enquiries.created_at + interval '5 hours 30 minutes'),
date_trunc('month',enquiries.created_at + interval '5 hours 30 minutes'),
enquiries.source,
agents.name, enquiries.source_city, INITCAP(enquiries.source_region) AS source_region, '', '', '',
meta -> 'utm_source' as utm_source,	meta -> 'utm_campaign' as utm_campaign, meta -> 'utm_medium' as utm_medium,
null, null, null, '', '', 
case when is_trash is TRUE then 'Yes' else 'No' end as trash
from enquiries
left join agents on enquiries.agent_id=agents.id
WHERE enquiries.vertical='development'
and enquiry_type='enquiry'
and leadable_id is null
and date(enquiries.created_at + interval '5 hours 30 minutes') >= date_trunc('month', CURRENT_DATE) - interval '12 months'
and date(enquiries.created_at + interval '5 hours 30 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'"
Closed Leads - Isprava,"select a.*, 
case when status = 'closed' and closed_reason is not null then INITCAP(REPLACE(closed_reason,'_',' ')) 
    --  when status = 'closed' and source = 'DnB' then 'DnB'
     when status = 'closed' and closed_reason  is null then 'Others'
     when status = 'closed' and INITCAP(REPLACE(closed_reason,'_',' ')) = 'Others' then 'Others'
     else null end AS closed_reason, explanation, '-' as Trash FROM
(
SELECT development_opportunities.slug,
       development_opportunities.name,
 development_opportunities.current_stage,
 development_opportunities.status,
 case when source_region is null then 'Unclassified' else INITCAP(source_region) end as source_region,
 date(development_opportunities.enquired_at + interval '330 minutes') as enquired_date,
date_trunc('month',development_opportunities.enquired_at + interval '5 hours 30 minutes') as enquired_month,
date(maal_laao_at + interval '330 minutes') as moved_to_sale,
 development_opportunities.source
FROM development_opportunities
where development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
and development_opportunities.source != 'DnB'
) as a

left JOIN
(
select slug, closed_reason, explanation
from
(
select development_opportunities.slug,(jsonb_array_elements(closed_reason)->>'closed_reason_value') as closed_reason,
(jsonb_array_elements(closed_reason)->>'closed_reason_explanation') as explanation,
rank() OVER (Partition by activities.leadable_id order by tasks.performed_at asc) as ranking
from tasks
inner join activities on tasks.id= activities.feedable_id
inner join development_opportunities on development_opportunities.id=activities.leadable_id
where tasks.rating='closed' and
activities.feedable_type='Task' and activities.leadable_type='Development::Opportunity'
) x 
where ranking=1
) e on a.slug=e.slug

WHERE date(a.enquired_date + interval '5 hours 30 minutes') >= date_trunc('month', CURRENT_DATE) - interval '12 months'
and date(a.enquired_date + interval '5 hours 30 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'

union

select enquiries.slug, enquiries.name,
'enquiry', '', case when source_region is null then 'Unclassified' else INITCAP(source_region) end as source_region, date(enquiries.created_at + interval '5 hours 30 minutes'),
date_trunc('month',enquiries.created_at + interval '5 hours 30 minutes'),null, source,
null, null,
case when is_trash is TRUE then 'Yes' else 'No' end as trash
from enquiries
WHERE enquiries.vertical='development'
and enquiry_type='enquiry'
and leadable_id is null
and date(enquiries.created_at + interval '5 hours 30 minutes') >= date_trunc('month', CURRENT_DATE) - interval '12 months'
and date(enquiries.created_at + interval '5 hours 30 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'"
Scorecard - YTD | Isprava,"select 
    a.metric, 
    coalesce(leads,0) + coalesce(leads2,0) as leads,
    coalesce(prospects,0) as Prospects,
    coalesce(accounts,0) as Accounts,
    coalesce(sales,0) as Sales,
    f.meetings,
    g.viewings,
    l2p::int as l2p,
    p2a::int as p2a,
    a2s::int as a2s
from
(
SELECT 'Metric' as metric,
count(distinct(development_opportunities.slug)) as leads
FROM development_opportunities
WHERE date(enquired_at + interval '330 minutes') >= '2025-04-01' 
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
and development_opportunities.source != 'DnB'

) a 

left join
(
select 'Metric' as metric,
      count(id) as leads2
from enquiries
WHERE enquiries.vertical='development'
and enquiry_type='enquiry'
and leadable_id is null
and (created_at + interval '330 minutes') >= '2025-04-01'
) b on a.metric = b.metric


left join
(
SELECT
    'Metric' as metric,
     count(distinct(development_opportunities.slug)) as prospects
FROM development_opportunities
WHERE date(lead_completed_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)c on a.metric = c.metric 

left join
(
SELECT
      'Metric' as metric,
      count(distinct(development_opportunities.slug)) as accounts
FROM development_opportunities
WHERE date(prospect_completed_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)d on a.metric = d.metric 

left join
(
SELECT 
    'Metric' as metric,
    COUNT(distinct(development_opportunities.slug)) AS sales
FROM development_opportunities
WHERE date(maal_laao_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
OR development_opportunities.slug IN ('d-ref-a2ff7f98','7A5D8F55')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)e on a.metric = e.metric 

left join 
(
select
    'Metric' as metric,
    count(distinct(development_opportunities.slug)) as meetings
from tasks
inner join activities on tasks.id= activities.feedable_id
inner join medium on tasks.medium_id=medium.id
inner join development_opportunities on development_opportunities.id=activities.leadable_id
WHERE date(performed_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
AND activities.feedable_type='Task' and activities.leadable_type='Development::Opportunity'
and ( medium.name='Meeting')
)f on a.metric = f.metric

left join
(
    select 'Metric' as metric,
    count(distinct(development_opportunities.slug)) as viewings
from tasks
inner join activities on tasks.id= activities.feedable_id
inner join medium on tasks.medium_id=medium.id
inner join development_opportunities on development_opportunities.id=activities.leadable_id
inner join staffs on staffs.id=development_opportunities.poc_exec_id
where activities.feedable_type='Task' and activities.leadable_type='Development::Opportunity'
and medium.name in ('Goa Viewing','Alibaug Viewing','Coonoor Viewing','Viewing','Site Visit')
and date(performed_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
) g on a.metric = g.metric

left join 
(
SELECT
    'Metric' as metric, 
    avg(date(lead_completed_at + interval '330 minutes') - date(enquired_at + interval '330 minutes')) as l2p
FROM development_opportunities
WHERE date(lead_completed_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)h on a.metric = h.metric 

left join
(
SELECT
      'Metric' as metric,
      avg(date(prospect_completed_at + interval '330 minutes') - date(lead_completed_at + interval '330 minutes')) as p2a
FROM development_opportunities
WHERE date(prospect_completed_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)i on a.metric = i.metric 

left join
(
SELECT 
    'Metric' as metric,
    avg(date(maal_laao_at + interval '330 minutes') - date(prospect_completed_at + interval '330 minutes')) as a2s
FROM development_opportunities
WHERE date(maal_laao_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)j on a.metric = j.metric "
Scorecard - LYTD | Isprava,"SELECT 
a.metric,
leads + coalesce(leads2,0) as leads,
coalesce(prospects,0) as Prospects,
coalesce(accounts,0) as Accounts,
coalesce(sales,0) as Sales,
f.meetings,
g.viewings,
l2p::int,
p2a::int,
a2s::int

FROM
(
SELECT 'Metric' as metric,
  count(distinct(development_opportunities.slug)) as leads
FROM development_opportunities
WHERE (enquired_at)::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
  AND development_opportunities.slug NOT IN ('569657C6','5EB1A14A','075E54DF')
  AND development_opportunities.source != 'DnB'
) a

left join
(
select 'Metric' as metric,
      count(id) as leads2
from enquiries
WHERE enquiries.vertical='development'
and enquiry_type='enquiry'
and leadable_id is null
and (created_at)::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
) b on a.metric = b.metric

left join
(
SELECT
    'Metric' as metric,
     count(distinct(development_opportunities.slug)) as prospects
FROM development_opportunities
WHERE (lead_completed_at + interval '330 minutes')::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)c on a.metric = c.metric 

left join
(
SELECT
      'Metric' as metric,
      count(distinct(development_opportunities.slug)) as accounts
FROM development_opportunities
WHERE (prospect_completed_at + interval '330 minutes')::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)d on a.metric = d.metric 

left join
(
SELECT 
    'Metric' as metric,
    COUNT(distinct(development_opportunities.slug)) AS sales
FROM development_opportunities
WHERE (maal_laao_at + interval '330 minutes')::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)e on a.metric = e.metric 

left join 
(
select
    'Metric' as metric,
    count(distinct(development_opportunities.slug)) as meetings
from tasks
inner join activities on tasks.id= activities.feedable_id
inner join medium on tasks.medium_id=medium.id
inner join development_opportunities on development_opportunities.id=activities.leadable_id
WHERE (performed_at + interval '330 minutes')::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
AND activities.feedable_type='Task' and activities.leadable_type='Development::Opportunity'
and ( medium.name='Meeting')
)f on a.metric = f.metric

left join
(
    select 'Metric' as metric,
    count(distinct(development_opportunities.slug)) as viewings
from tasks
inner join activities on tasks.id= activities.feedable_id
inner join medium on tasks.medium_id=medium.id
inner join development_opportunities on development_opportunities.id=activities.leadable_id
inner join staffs on staffs.id=development_opportunities.poc_exec_id
where activities.feedable_type='Task' and activities.leadable_type='Development::Opportunity'
and medium.name in ('Goa Viewing','Alibaug Viewing','Coonoor Viewing','Viewing','Site Visit')
and (performed_at + interval '330 minutes')::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
) g on a.metric = g.metric

left join 
(
SELECT
    'Metric' as metric, 
    avg(date(lead_completed_at + interval '330 minutes') - date(enquired_at + interval '330 minutes')) as l2p
FROM development_opportunities
WHERE (lead_completed_at + interval '330 minutes')::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)h on a.metric = h.metric 

left join
(
SELECT
      'Metric' as metric,
      avg(date(prospect_completed_at + interval '330 minutes') - date(lead_completed_at + interval '330 minutes')) as p2a
FROM development_opportunities
WHERE (prospect_completed_at + interval '330 minutes')::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)i on a.metric = i.metric 

left join
(
SELECT 
    'Metric' as metric,
    avg(date(maal_laao_at + interval '330 minutes') - date(prospect_completed_at + interval '330 minutes')) as a2s
FROM development_opportunities
WHERE (maal_laao_at + interval '330 minutes')::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
)j on a.metric = j.metric 

"
YTD Source Bifurcation - Isprava,"select 
    a.source,
    -- CAST(A.MONTH AS DATE) AS MONTH_SORT,
    -- TO_CHAR(a.month,'Mon-YY') AS MONTH,
    sum(coalesce(leads,0) + coalesce(leads2,0)) as leads,
    sum(coalesce((prospects),0)) as prospects, 
    sum(coalesce((accounts),0)) as accounts,
    sum(coalesce((sales),0)) as sales
    /*
    case when (coalesce(leads,0) + coalesce(leads2,0)) > 0 then 
    coalesce(prospects,0)::float * 100 / (coalesce(leads,0) + coalesce(leads2,0)) else 0 end as l2p,
    case when coalesce(prospects,0) > 0 then coalesce(accounts,0)::float * 100 / coalesce(prospects,0) else 0 end as p2a,
    case when coalesce(accounts,0) > 0 then coalesce(sales,0)::float * 100 / coalesce(accounts,0) else 0 end as a2s,
    case when (coalesce(leads,0) + coalesce(leads2,0)) > 0 
    then coalesce(sales,0)::float * 100 / (coalesce(leads,0) + coalesce(leads2,0)) else 0 end as l2s */

from
(
SELECT date::date, source
FROM generate_series(
        DATE '2025-04-01',  -- YTD start date
        current_date,       -- today's date
        '1 day'::interval
) AS date
        CROSS JOIN (
       select distinct source FROM
        (
        select 
        CASE WHEN development_opportunities.source = 'agent' 
        then 'Agent'
        WHEN development_opportunities.source IN ('direct_mailer','emailer','google','facebook','instagram','linkedin','youtube','signage','isprava','isprava.com','isprava.com_chatbot','direct_call') 
        THEN 'Digital'
        WHEN development_opportunities.source IN ('lohono.com','lohono') 
        THEN 'Lohono'
        WHEN development_opportunities.source IN ('reference','word_of_mouth','isprava_employee','chapter_employee','chapter_reference','homeowner_ref') 
        THEN 'Reference + Word of Mouth'
        WHEN development_opportunities.source= 'repeat_client' 
        THEN 'Repeat Client'
        ELSE 'Other' end as source
    --   date_trunc('month',development_opportunities.enquired_at + interval '5 hours 30 minutes') as month
      from development_opportunities) as source)
group by source, date      
) a

left join
(
select 
    source, date,
    sum(coalesce(leads,0))::int as leads
FROM
(
SELECT date(enquired_at + interval '330 minutes') as date,
CASE WHEN development_opportunities.source = 'agent' 
        then 'Agent'
        WHEN development_opportunities.source IN ('direct_mailer','emailer','google','facebook','instagram','linkedin','youtube','signage','isprava','isprava.com','isprava.com_chatbot','direct_call') 
        THEN 'Digital'
        WHEN development_opportunities.source IN ('lohono.com','lohono') 
        THEN 'Lohono'
        WHEN development_opportunities.source IN ('reference','word_of_mouth','isprava_employee','chapter_employee','chapter_reference','homeowner_ref') 
        THEN 'Reference + Word of Mouth'
        WHEN development_opportunities.source= 'repeat_client' 
        THEN 'Repeat Client'
        ELSE 'Other' end as source,
count(distinct(development_opportunities.slug)) as leads
-- date_trunc('month',development_opportunities.enquired_at + interval '5 hours 30 minutes') as month
FROM development_opportunities
WHERE development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
AND development_opportunities.source != 'DnB'
group by source, development_opportunities.meta, date
) query_1 
group by source, date
) b on a.source=b.source  and a.date = b.date

left join
(
select 
    source, 
    date,
    sum(coalesce(leads2,0))::int as leads2
FROM
(
select date(enquiries.created_at + interval '330 minutes') as date,
CASE WHEN enquiries.source = 'agent' 
        then 'Agent'
        WHEN enquiries.source IN ('direct_mailer','emailer','google','facebook','instagram','linkedin','youtube','signage','isprava','isprava.com','isprava.com_chatbot','direct_call') 
        THEN 'Digital'
        WHEN enquiries.source IN ('lohono.com','lohono') 
        THEN 'Lohono'
        WHEN enquiries.source IN ('reference','word_of_mouth','isprava_employee','chapter_employee','chapter_reference','homeowner_ref') 
        THEN 'Reference + Word of Mouth'
        WHEN enquiries.source= 'repeat_client' 
        THEN 'Repeat Client'
        ELSE 'Other' end as source, 
      count(id) as leads2
    --   date_trunc('month',enquiries.created_at + interval '5 hours 30 minutes') as month
from enquiries
WHERE enquiries.vertical='development'
and enquiry_type='enquiry'
and leadable_id is null
group by source, enquiries.meta,date(enquiries.created_at + interval '5 hours 30 minutes')
) x 
group by source, date
) c on a.source=c.source and a.date= c.date 

left join
(
select 
    source, 
    date,
    sum(coalesce(prospects,0))::int as prospects
FROM
(
SELECT
date(lead_completed_at + interval '5 hours 30 minutes') as date,
CASE WHEN development_opportunities.source = 'agent' 
        then 'Agent'
        WHEN development_opportunities.source IN ('direct_mailer','emailer','google','facebook','instagram','linkedin','youtube','signage','isprava','isprava.com','isprava.com_chatbot','direct_call') 
        THEN 'Digital'
        WHEN development_opportunities.source IN ('lohono.com','lohono') 
        THEN 'Lohono'
        WHEN development_opportunities.source IN ('reference','word_of_mouth','isprava_employee','chapter_employee','chapter_reference','homeowner_ref') 
        THEN 'Reference + Word of Mouth'
        WHEN development_opportunities.source= 'repeat_client' 
        THEN 'Repeat Client'
        ELSE 'Other' end as source,
      count(distinct(development_opportunities.slug)) as prospects
FROM development_opportunities
WHERE development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
group by source,development_opportunities.meta, date(lead_completed_at + interval '5 hours 30 minutes')
) query_1 
group by source, date
) d on a.source=d.source and a.date = d.date 

left join
(
select 
    source,
    date, 
    sum(coalesce(accounts,0))::int as accounts
FROM
(
SELECT
CASE WHEN development_opportunities.source = 'agent' 
        then 'Agent'
        WHEN development_opportunities.source IN ('direct_mailer','emailer','google','facebook','instagram','linkedin','youtube','signage','isprava','isprava.com','isprava.com_chatbot','direct_call') 
        THEN 'Digital'
        WHEN development_opportunities.source IN ('lohono.com','lohono') 
        THEN 'Lohono'
        WHEN development_opportunities.source IN ('reference','word_of_mouth','isprava_employee','chapter_employee','chapter_reference','homeowner_ref') 
        THEN 'Reference + Word of Mouth'
        WHEN development_opportunities.source= 'repeat_client' 
        THEN 'Repeat Client'
        ELSE 'Other' end as source,
      count(distinct(development_opportunities.slug)) as accounts,
      date(prospect_completed_at + interval '5 hours 30 minutes') as date
FROM development_opportunities
WHERE development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
group by source, development_opportunities.meta, date(prospect_completed_at + interval '5 hours 30 minutes')
) query_1 
group by source, date
) e on a.source=e.source and a.date=e.date

left join
(
SELECT 
    x.source,
    x.date,
    sum((slug))::int as sales
FROM
  (SELECT 
        date(development_opportunities.maal_laao_at + interval '5 hours 30 minutes') as date,
        COUNT(distinct(development_opportunities.slug)) AS slug, 
        CASE WHEN development_opportunities.source = 'agent' 
        then 'Agent'
        WHEN development_opportunities.source IN ('direct_mailer','emailer','google','facebook','instagram','linkedin','youtube','signage','isprava','isprava.com','isprava.com_chatbot','direct_call') 
        THEN 'Digital'
        WHEN development_opportunities.source IN ('lohono.com','lohono') 
        THEN 'Lohono'
        WHEN development_opportunities.source IN ('reference','word_of_mouth','isprava_employee','chapter_employee','chapter_reference','homeowner_ref') 
        THEN 'Reference + Word of Mouth'
        WHEN development_opportunities.source= 'repeat_client' 
        THEN 'Repeat Client'
        ELSE 'Other' end as source
   FROM development_opportunities
  WHERE development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
group by source, development_opportunities.meta, date(development_opportunities.maal_laao_at + interval '5 hours 30 minutes')
) x
group by source, date 
) f on a.source=f.source and a.date = f.date 
-- order by a.date 
group by a.source
order by leads"
Closed Leads YTD- Isprava,"select a.*, 
case when status = 'closed' and closed_reason is not null then INITCAP(REPLACE(closed_reason,'_',' ')) 
     --when status = 'closed' and source = 'DnB' then 'DnB'
     when status = 'closed' and closed_reason  is null then 'Others'
     when status = 'closed' and INITCAP(REPLACE(closed_reason,'_',' ')) = 'Others' then 'Others'
     else null end AS closed_reason, explanation, '-' as Trash FROM
(
SELECT development_opportunities.slug,
       development_opportunities.name,
 development_opportunities.current_stage,
 development_opportunities.status,
 development_opportunities.interested_location,
 date(development_opportunities.enquired_at + interval '330 minutes') as enquired_date,
date_trunc('month',development_opportunities.enquired_at + interval '5 hours 30 minutes') as enquired_month,
date(maal_laao_at + interval '330 minutes') as moved_to_sale,
 development_opportunities.source
FROM development_opportunities
where development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
  and development_opportunities.source != 'DnB'
) as a

left JOIN
(
select slug, closed_reason, explanation
from
(
select development_opportunities.slug,(jsonb_array_elements(closed_reason)->>'closed_reason_value') as closed_reason,
(jsonb_array_elements(closed_reason)->>'closed_reason_explanation') as explanation,
rank() OVER (Partition by activities.leadable_id order by tasks.performed_at asc) as ranking
from tasks
inner join activities on tasks.id= activities.feedable_id
inner join development_opportunities on development_opportunities.id=activities.leadable_id
where tasks.rating='closed' and
activities.feedable_type='Task' and activities.leadable_type='Development::Opportunity'
) x 
where ranking=1
) e on a.slug=e.slug

WHERE date(a.enquired_date) between '2025-04-01' and  date(now() + interval '330 minutes')

union

select enquiries.slug, enquiries.name,
'enquiry', '', enquiries.location, date(enquiries.created_at + interval '5 hours 30 minutes'),
date_trunc('month',enquiries.created_at + interval '5 hours 30 minutes'),null, source,
null, null,
case when is_trash is TRUE then 'Yes' else 'No' end as trash
from enquiries
WHERE enquiries.vertical='development'
and enquiry_type='enquiry'
and leadable_id is null
and date(enquiries.created_at + interval '5 hours 30 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
"
MTD - Scorecard | Chapter,"select 
    a.metric, 
    leads + coalesce(leads2,0) as leads,
    coalesce(prospects,0) as Prospects,
    coalesce(accounts,0) as Accounts,
    coalesce(sales,0) as Sales,
    f.meetings,
    g.viewings,
    l2p::int as l2p,
    p2a::int as p2a,
    a2s::int as a2s
from
(
SELECT 'Metric' as metric,
count(distinct(chapter_opportunities.slug)) as leads
FROM chapter_opportunities
WHERE (enquired_at + interval '330 minutes')::date >= cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)
and (enquired_at + interval '330 minutes')::date < (cast(date_trunc('month',CURRENT_DATE + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',enquired_at + interval '330 minutes') <= date_part('day',now() + interval '330 minutes')
and chapter_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
and chapter_opportunities.source != 'DnB'

) a 

left join
(
select 'Metric' as metric,
      count(id) as leads2
from enquiries
WHERE enquiries.vertical='chapter'
and enquiry_type='enquiry'
and leadable_id is null
and (created_at + interval '330 minutes')::date >= cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)
and (created_at + interval '330 minutes')::date < (cast(date_trunc('month',CURRENT_DATE + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',created_at + interval '330 minutes') <= date_part('day',now() + interval '330 minutes')
and (lower(enquiries.name) not like '%test%' and lower(enquiries.name) not like 'test%'
and lower(enquiries.name) != 'test')
) b on a.metric = b.metric


left join
(
SELECT
    'Metric' as metric,
     count(distinct(chapter_opportunities.slug)) as prospects
FROM chapter_opportunities
WHERE (lead_completed_at + interval '330 minutes')::date >= cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)
and (lead_completed_at + interval '330 minutes')::date < (cast(date_trunc('month',CURRENT_DATE + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',lead_completed_at + interval '330 minutes') <= date_part('day',now() + interval '330 minutes')
and chapter_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)c on a.metric = c.metric 

left join
(
SELECT
      'Metric' as metric,
      count(distinct(chapter_opportunities.slug)) as accounts
FROM chapter_opportunities
WHERE (prospect_completed_at + interval '330 minutes')::date >= cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)
and (prospect_completed_at + interval '330 minutes')::date < (cast(date_trunc('month',CURRENT_DATE + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',prospect_completed_at + interval '330 minutes') <= date_part('day',now() + interval '330 minutes')
and chapter_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)d on a.metric = d.metric 

left join
(
SELECT 
    'Metric' as metric,
    COUNT(distinct(chapter_opportunities.slug)) AS sales
FROM chapter_opportunities
WHERE (maal_laao_at + interval '330 minutes')::date >= cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)
and (maal_laao_at + interval '330 minutes')::date < (cast(date_trunc('month',CURRENT_DATE + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',maal_laao_at + interval '330 minutes') <= date_part('day',now() + interval '330 minutes')
and chapter_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)e on a.metric = e.metric 

left join 
(
select
    'Metric' as metric,
    count(distinct(chapter_opportunities.slug)) as meetings
from tasks
inner join activities on tasks.id= activities.feedable_id
inner join medium on tasks.medium_id=medium.id
inner join chapter_opportunities on chapter_opportunities.id=activities.leadable_id
WHERE (performed_at + interval '330 minutes')::date >= cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)
and (performed_at + interval '330 minutes')::date < (cast(date_trunc('month',CURRENT_DATE + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',performed_at + interval '330 minutes') <= date_part('day',now() + interval '330 minutes')
AND activities.feedable_type='Task' and activities.leadable_type='Chapter::Opportunity'
and ( medium.name='Meeting')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)f on a.metric = f.metric

left join
(
    select 'Metric' as metric,
    count(distinct(chapter_opportunities.slug)) as viewings
from tasks
inner join activities on tasks.id= activities.feedable_id
inner join medium on tasks.medium_id=medium.id
inner join chapter_opportunities on chapter_opportunities.id=activities.leadable_id
inner join staffs on staffs.id=chapter_opportunities.poc_exec_id
where activities.feedable_type='Task' and activities.leadable_type='Chapter::Opportunity'
and medium.name in ('Goa Viewing','Alibaug Viewing','Coonoor Viewing','Viewing','Site Visit')
and (performed_at + interval '330 minutes')::date >= cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)
and (performed_at + interval '330 minutes')::date < (cast(date_trunc('month',CURRENT_DATE + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',performed_at + interval '330 minutes') <= date_part('day',now() + interval '330 minutes')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
) g on a.metric = g.metric

left join 
(
SELECT
    'Metric' as metric, 
    avg(date(lead_completed_at + interval '330 minutes') - date(enquired_at + interval '330 minutes')) as l2p
FROM chapter_opportunities
WHERE (lead_completed_at + interval '330 minutes')::date >= cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)
and (lead_completed_at + interval '330 minutes')::date < (cast(date_trunc('month',CURRENT_DATE + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',lead_completed_at + interval '330 minutes') <= date_part('day',now() + interval '330 minutes')
and chapter_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)h on a.metric = h.metric 

left join
(
SELECT
      'Metric' as metric,
      avg(date(prospect_completed_at + interval '330 minutes') - date(lead_completed_at + interval '330 minutes')) as p2a
FROM chapter_opportunities
WHERE (prospect_completed_at + interval '330 minutes')::date >= cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)
and (prospect_completed_at + interval '330 minutes')::date < (cast(date_trunc('month',CURRENT_DATE + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',prospect_completed_at + interval '330 minutes') <= date_part('day',now() + interval '330 minutes')
and chapter_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)i on a.metric = i.metric 

left join
(
SELECT 
    'Metric' as metric,
    avg(date(maal_laao_at + interval '330 minutes') - date(prospect_completed_at + interval '330 minutes')) as a2s
FROM chapter_opportunities
WHERE (maal_laao_at + interval '330 minutes')::date >= cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)
and (maal_laao_at + interval '330 minutes')::date < (cast(date_trunc('month',CURRENT_DATE + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',maal_laao_at + interval '330 minutes') <= date_part('day',now() + interval '330 minutes')
and chapter_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)j on a.metric = j.metric 
"
LYMTD - Scorecard  | Chapter,"SELECT 
a.metric,
leads + coalesce(leads2,0) as leads,
coalesce(prospects,0) as Prospects,
coalesce(accounts,0) as Accounts,
coalesce(sales,0) as Sales,
f.meetings,
g.viewings,
l2p::int,
p2a::int,
a2s::int

FROM
(
SELECT 'Metric' as metric,
  count(distinct(chapter_opportunities.slug)) as leads
FROM chapter_opportunities
WHERE (enquired_at + interval '330 minutes')::date >= 
        cast(date_trunc('month', (CURRENT_DATE - interval '1 year') + interval '330 minutes') AS date)
  AND (enquired_at + interval '330 minutes')::date < 
        cast(date_trunc('month', (CURRENT_DATE - interval '1 year') + interval '330 minutes' + INTERVAL '1 MONTH') AS date)
  AND date_part('day', enquired_at + interval '330 minutes') <= 
        date_part('day', (now() - interval '1 year') + interval '330 minutes')
  and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
  and lower(chapter_opportunities.name) != 'test')
  and chapter_opportunities.source != 'DnB'
) a

left join
(
select 'Metric' as metric,
      count(id) as leads2
from enquiries
WHERE enquiries.vertical='chapter'
and enquiry_type='enquiry'
and leadable_id is null
and (created_at + interval '330 minutes')::date >= 
    cast(date_trunc('month', (CURRENT_DATE - interval '1 year') + interval '330 minutes') AS date)
and (created_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',created_at + interval '330 minutes') <= 
    date_part('day',(now() - interval '1 year') + interval '330 minutes')
and (lower(enquiries.name) not like '%test%' and lower(enquiries.name) not like 'test%'
and lower(enquiries.name) != 'test')
) b on a.metric = b.metric

left join
(
SELECT
    'Metric' as metric,
     count(distinct(chapter_opportunities.slug)) as prospects
FROM chapter_opportunities
WHERE (lead_completed_at + interval '330 minutes')::date >=
    cast(date_trunc('month',(CURRENT_DATE-interval '1 year') + interval '330 minutes') AS date)
and (lead_completed_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',lead_completed_at + interval '330 minutes') <= 
    date_part('day',now() + interval '330 minutes')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)c on a.metric = c.metric 

left join
(
SELECT
      'Metric' as metric,
      count(distinct(chapter_opportunities.slug)) as accounts
FROM chapter_opportunities
WHERE (prospect_completed_at + interval '330 minutes')::date >= 
    cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes') AS date)
and (prospect_completed_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',prospect_completed_at + interval '330 minutes') <= 
    date_part('day',now()  + interval '330 minutes')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)d on a.metric = d.metric 

left join
(
SELECT 
    'Metric' as metric,
    COUNT(distinct(chapter_opportunities.slug)) AS sales
FROM chapter_opportunities
WHERE (maal_laao_at + interval '330 minutes')::date >= 
    cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes') AS date)
and (maal_laao_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',maal_laao_at + interval '330 minutes') <= 
    date_part('day',now() + interval '330 minutes')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)e on a.metric = e.metric 

left join 
(
select
    'Metric' as metric,
    count(distinct(chapter_opportunities.slug)) as meetings
from tasks
inner join activities on tasks.id= activities.feedable_id
inner join medium on tasks.medium_id=medium.id
inner join chapter_opportunities on chapter_opportunities.id=activities.leadable_id
WHERE (performed_at + interval '330 minutes')::date >= 
    cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes') AS date)
and (performed_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',performed_at + interval '330 minutes') <= 
    date_part('day',now() + interval '330 minutes')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
AND activities.feedable_type='Task' and activities.leadable_type='Chapter::Opportunity'
and ( medium.name='Meeting')
)f on a.metric = f.metric

left join
(
    select 'Metric' as metric,
    count(distinct(chapter_opportunities.slug)) as viewings
from tasks
inner join activities on tasks.id= activities.feedable_id
inner join medium on tasks.medium_id=medium.id
inner join chapter_opportunities on chapter_opportunities.id=activities.leadable_id
inner join staffs on staffs.id=chapter_opportunities.poc_exec_id
where activities.feedable_type='Task' and activities.leadable_type='Chapter::Opportunity'
and medium.name in ('Goa Viewing','Alibaug Viewing','Coonoor Viewing','Viewing','Site Visit')
and (performed_at + interval '330 minutes')::date >= 
    cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes') AS date)
and (performed_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE- interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',performed_at + interval '330 minutes') <= 
    date_part('day',now() + interval '330 minutes')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
) g on a.metric = g.metric

left join 
(
SELECT
    'Metric' as metric, 
    avg(date(lead_completed_at + interval '330 minutes') - date(enquired_at + interval '330 minutes')) as l2p
FROM chapter_opportunities
WHERE (lead_completed_at + interval '330 minutes')::date >= 
    cast(date_trunc('month',(CURRENT_DATE - interval '1 year') + interval '330 minutes') AS date)
and (lead_completed_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE - interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',lead_completed_at + interval '330 minutes') <= 
    date_part('day',(now() - interval '1 year') + interval '330 minutes')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)h on a.metric = h.metric 

left join
(
SELECT
      'Metric' as metric,
      avg(date(prospect_completed_at + interval '330 minutes') - date(lead_completed_at + interval '330 minutes')) as p2a
FROM chapter_opportunities
WHERE (prospect_completed_at + interval '330 minutes')::date >= 
    cast(date_trunc('month',(CURRENT_DATE - interval '1 year') + interval '330 minutes') AS date)
and (prospect_completed_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE - interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',prospect_completed_at + interval '330 minutes') <= 
    date_part('day',(now() - interval '1 year') + interval '330 minutes')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)i on a.metric = i.metric 

left join
(
SELECT 
    'Metric' as metric,
    avg(date(maal_laao_at + interval '330 minutes') - date(prospect_completed_at + interval '330 minutes')) as a2s
FROM chapter_opportunities
WHERE (maal_laao_at + interval '330 minutes')::date >= 
    cast(date_trunc('month',(CURRENT_DATE - interval '1 year') + interval '330 minutes') AS date)
and (maal_laao_at + interval '330 minutes')::date < 
    (cast(date_trunc('month',(CURRENT_DATE - interval '1 year') + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',maal_laao_at + interval '330 minutes') <= 
    date_part('day',(now() - interval '1 year') + interval '330 minutes')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)j on a.metric = j.metric "
Open Leads Status MTD | Chapter,"select a.*, '-' as trash FROM
(
SELECT chapter_opportunities.slug,
       chapter_opportunities.name,
 chapter_opportunities.current_stage,
 INITCAP(REPLACE(chapter_opportunities.status,'_',' ')) as status,
 chapter_opportunities.interested_location,
 date(chapter_opportunities.enquired_at + interval '330 minutes') as enquired_date,
 to_char(date(chapter_opportunities.enquired_at + interval '330 minutes'),'Mon-YY') as enquired_month,
 chapter_opportunities.source,
 agents.name as agent_name,
 chapter_opportunities.source_city,
 chapter_opportunities.source_region,
 --chapter_opportunities.interested_home_types,
 chapter_opportunities.source_others,
 staffs1.name AS poc_exec_name,
 staffs2.name AS poc_head_name,
 chapter_opportunities.meta -> 'utm_source' as utm_source,	chapter_opportunities.meta -> 'utm_campaign' as utm_campaign, 
 chapter_opportunities.meta -> 'utm_medium' as utm_medium
FROM chapter_opportunities
left join agents on agents.id=chapter_opportunities.agent_id
LEFT JOIN staffs AS staffs1 ON chapter_opportunities.poc_exec_id = staffs1.id
LEFT JOIN staffs AS staffs2 ON chapter_opportunities.poc_head_id = staffs2.id
where (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
) as a


WHERE (a.enquired_date + interval '330 minutes')::date >= cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)
and (a.enquired_date + interval '330 minutes')::date < (cast(date_trunc('month',CURRENT_DATE + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',a.enquired_date + interval '330 minutes') <= date_part('day',now() + interval '330 minutes')


union

select enquiries.slug, enquiries.name,
'Enquiry', case when is_trash=TRUE then 'trash' else 'Enquiry' end, enquiries.location, date(enquiries.created_at + interval '5 hours 30 minutes'),
to_char(date(enquiries.created_at + interval '330 minutes'),'Mon-YY') as enquired_month,
INITCAP(REPLACE(enquiries.source, '_', ' ')) AS status,
agents.name, enquiries.source_city, enquiries.source_region, '', '', '',
meta -> 'utm_source' as utm_source,	meta -> 'utm_campaign' as utm_campaign, meta -> 'utm_medium' as utm_medium,
case when is_trash is TRUE then 'Yes' else 'No' end as trash
from enquiries
left join agents on enquiries.agent_id=agents.id
WHERE enquiries.vertical='chapter'
and enquiry_type='enquiry'
and leadable_id is null
and (enquiries.created_at + interval '330 minutes')::date >= cast(date_trunc('month',CURRENT_DATE + interval '330 minutes') AS date)
and (enquiries.created_at + interval '330 minutes')::date < (cast(date_trunc('month',CURRENT_DATE + interval '330 minutes'  + INTERVAL '1 MONTH' ) AS date))
and date_part('day',enquiries.created_at + interval '330 minutes') <= date_part('day',now() + interval '330 minutes')
and (lower(enquiries.name) not like '%test%' and lower(enquiries.name) not like 'test%'
and lower(enquiries.name) != 'test')"
Open Prospects - MTD | Chapter,"SELECT 
    slug,
    name,
    date(enquired_at + interval '330 minutes') AS enquired_date,
    date(lead_completed_at + interval '330 minutes') AS moved_to_prospect,
    date(now() + interval '330 minutes') - date(lead_completed_at + interval '330 minutes') AS ageing,
    current_stage,
    maal_laao_at,
    INITCAP(replace(status,'_',' ')) as status
FROM chapter_opportunities
WHERE current_stage= 'prospect'
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
and date(lead_completed_at + interval '330 minutes') >= '2023-04-01'
AND maal_laao_at IS NULL
AND status != 'closed' 
ORDER BY ageing DESC"
Open Accounts - Chapter,"SELECT 
    slug,
    name,
    current_stage,
    date(enquired_at + interval '330 minutes') AS enquired_date,
    date(prospect_completed_at + interval '330 minutes') AS moved_to_account,
    date(now() + interval '330 minutes') - date(prospect_completed_at + interval '330 minutes') AS ageing,
    maal_laao_at,
    INITCAP(replace(status,'_',' ')) as status
FROM chapter_opportunities
WHERE current_stage= 'account'
AND (lower(name) not like '%test%' and lower(name) not like 'test%')
and date(prospect_completed_at + interval '330 minutes') >= '2023-04-01'
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
AND maal_laao_at IS NULL
AND status != 'closed' 
ORDER BY ageing DESC"
Overall Leads & Closed Leads | Chapter,"select a.*,b.moved_to_prospect,c.moved_to_account,d.maal_laao_date, 
INITCAP(REPLACE(closed_reason,'_',' ')) AS closed_reason, explanation, '-' as Trash FROM
(
SELECT chapter_opportunities.slug,
       chapter_opportunities.name,
 chapter_opportunities.current_stage,
 chapter_opportunities.status,
 chapter_opportunities.interested_location,
 date(chapter_opportunities.enquired_at + interval '330 minutes') as enquired_date,
date_trunc('month',chapter_opportunities.enquired_at + interval '5 hours 30 minutes') as enquired_month,
 chapter_opportunities.source,
 agents.name as agent_name,
 chapter_opportunities.source_city,
 INITCAP(chapter_opportunities.source_region) as source_region,
 --chapter_opportunities.interested_home_types,
 chapter_opportunities.source_others,
 staffs1.name AS poc_exec_name,
 staffs2.name AS poc_head_name,
 chapter_opportunities.meta -> 'utm_source' as utm_source,	chapter_opportunities.meta -> 'utm_campaign' as utm_campaign, 
 chapter_opportunities.meta -> 'utm_medium' as utm_medium
FROM chapter_opportunities
left join agents on agents.id=chapter_opportunities.agent_id
LEFT JOIN staffs AS staffs1 ON chapter_opportunities.poc_exec_id = staffs1.id
LEFT JOIN staffs AS staffs2 ON chapter_opportunities.poc_head_id = staffs2.id
where (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
and chapter_opportunities.source != 'DnB'
) as a
left JOIN
(
select sub_query.slug,date(sub_query.moved_to_prospect) as moved_to_prospect,sub_query.current_stage
FROM
(
select chapter_opportunities.slug as slug,
stage_histories.updated_at + interval '330 minutes' as moved_to_prospect,chapter_opportunities.current_stage as current_stage,
 RANK() OVER (PARTITION BY stage_histories.leadable_id,
                            stage_histories.leadable_type
                             ORDER BY stage_histories.updated_at ASC) date_rank
FROM chapter_opportunities 
inner join stage_histories on chapter_opportunities.id=stage_histories.leadable_id AND leadable_type='Chapter::Opportunity'
inner join stages on stage_histories.stage_id=stages.id
WHERE vertical = 'chapter' AND code = 'prospect'
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
) sub_query
WHERE date_rank=1
) as b on a.slug=b.slug
left join
(
select sub_query.slug,date(sub_query.moved_to_account) as moved_to_account,sub_query.current_stage
FROM
(
select chapter_opportunities.slug as slug,
stage_histories.updated_at + interval '330 minutes' as moved_to_account,chapter_opportunities.current_stage as current_stage,
 RANK() OVER (PARTITION BY stage_histories.leadable_id,
                            stage_histories.leadable_type
                             ORDER BY stage_histories.updated_at ASC) date_rank
FROM chapter_opportunities 
inner join stage_histories on chapter_opportunities.id=stage_histories.leadable_id AND leadable_type='Chapter::Opportunity'
inner join stages on stage_histories.stage_id=stages.id
WHERE vertical = 'chapter' AND code = 'account'
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
) sub_query
WHERE date_rank=1
) as c on a.slug=c.slug
left join
(
SELECT x.slug,resolved_at_date_ist as maal_laao_date
FROM
  (SELECT DATE(tasks.performed_at + interval '5 hours 30 minutes') as resolved_at_date_ist,
          rank() over(PARTITION BY activities.leadable_id
                      ORDER BY tasks.performed_at) AS ranking,
          tasks.rating AS rating, chapter_opportunities.source as source, chapter_opportunities.slug
   FROM tasks
   inner join activities on tasks.id= activities.feedable_id
   INNER JOIN chapter_opportunities ON chapter_opportunities.id=activities.leadable_id
   where activities.feedable_type='Task' and activities.leadable_type='Chapter::Opportunity'
   AND tasks.rating = 'maal_laao'
 and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
 ) x
WHERE ranking = 1
group by resolved_at_date_ist, x.slug
) as d on a.slug=d.slug

left JOIN
(
select slug,case when closed_reason is null or closed_reason = '' then 'other'
when closed_reason in ('others','other') then 'other' else closed_reason end as closed_reason, explanation
from
(
select chapter_opportunities.slug,(jsonb_array_elements(closed_reason)->>'closed_reason_value') as closed_reason,
(jsonb_array_elements(closed_reason)->>'closed_reason_explanation') as explanation,
rank() OVER (Partition by activities.leadable_id order by tasks.performed_at asc) as ranking
from tasks
inner join activities on tasks.id= activities.feedable_id
inner join chapter_opportunities on chapter_opportunities.id=activities.leadable_id
where tasks.rating='closed' 
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test') 
and activities.feedable_type='Task' and activities.leadable_type='Chapter::Opportunity'
) x 
where ranking=1
) e on a.slug=e.slug

WHERE date(a.enquired_date) >= date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(a.enquired_date) <= date_trunc('month', CURRENT_DATE) + interval '1 month'

union

select enquiries.slug, enquiries.name,
'enquiry', '', enquiries.location, date(enquiries.created_at + interval '5 hours 30 minutes'),
date_trunc('month',enquiries.created_at + interval '5 hours 30 minutes'),
enquiries.source,
agents.name, enquiries.source_city, INITCAP(enquiries.source_region) AS source_region, '', '', '',
meta -> 'utm_source' as utm_source,	meta -> 'utm_campaign' as utm_campaign, meta -> 'utm_medium' as utm_medium,
null, null, null, '', '', 
case when is_trash is TRUE then 'Yes' else 'No' end as trash
from enquiries
left join agents on enquiries.agent_id=agents.id
WHERE enquiries.vertical='chapter'
and enquiry_type='enquiry'
and leadable_id is null
and (lower(enquiries.name) not like '%test%' and lower(enquiries.name) not like 'test%'
and lower(enquiries.name) != 'test')
and date(enquiries.created_at + interval '5 hours 30 minutes') >= date_trunc('month', CURRENT_DATE) - interval '12 months'
and date(enquiries.created_at + interval '5 hours 30 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'"
YTD Scorecard | Chapter,"select 
    a.metric, 
    coalesce(leads,0) + coalesce(leads2,0) as leads,
    coalesce(prospects,0) as Prospects,
    coalesce(accounts,0) as Accounts,
    coalesce(sales,0) as Sales,
    f.meetings,
    g.viewings,
    l2p::int as l2p,
    p2a::int as p2a,
    a2s::int as a2s
from
(
SELECT 'Metric' as metric,
count(distinct(chapter_opportunities.slug)) as leads
FROM chapter_opportunities
WHERE date(enquired_at + interval '330 minutes') >= '2025-04-01' 
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
and chapter_opportunities.source != 'DnB'

) a 

left join
(
select 'Metric' as metric,
      count(id) as leads2
from enquiries
WHERE enquiries.vertical='chapter'
and enquiry_type='enquiry'
and leadable_id is null
and (lower(enquiries.name) not like '%test%' and lower(enquiries.name) not like 'test%'
and lower(enquiries.name) != 'test')
and (created_at + interval '330 minutes') >= '2025-04-01'
) b on a.metric = b.metric


left join
(
SELECT
    'Metric' as metric,
     count(distinct(chapter_opportunities.slug)) as prospects
FROM chapter_opportunities
WHERE date(lead_completed_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)c on a.metric = c.metric 

left join
(
SELECT
      'Metric' as metric,
      count(distinct(chapter_opportunities.slug)) as accounts
FROM chapter_opportunities
WHERE date(prospect_completed_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)d on a.metric = d.metric 

left join
(
SELECT 
    'Metric' as metric,
    COUNT(distinct(chapter_opportunities.slug)) AS sales
FROM chapter_opportunities
WHERE date(maal_laao_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)e on a.metric = e.metric 

left join 
(
select
    'Metric' as metric,
    count(distinct(chapter_opportunities.slug)) as meetings
from tasks
inner join activities on tasks.id= activities.feedable_id
inner join medium on tasks.medium_id=medium.id
inner join chapter_opportunities on chapter_opportunities.id=activities.leadable_id
WHERE date(performed_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
AND activities.feedable_type='Task' and activities.leadable_type='Chapter::Opportunity'
and ( medium.name='Meeting')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)f on a.metric = f.metric

left join
(
    select 'Metric' as metric,
    count(distinct(chapter_opportunities.slug)) as viewings
from tasks
inner join activities on tasks.id= activities.feedable_id
inner join medium on tasks.medium_id=medium.id
inner join chapter_opportunities on chapter_opportunities.id=activities.leadable_id
inner join staffs on staffs.id=chapter_opportunities.poc_exec_id
where activities.feedable_type='Task' and activities.leadable_type='Chapter::Opportunity'
and medium.name in ('Goa Viewing','Alibaug Viewing','Coonoor Viewing','Viewing','Site Visit')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
and date(performed_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
) g on a.metric = g.metric

left join 
(
SELECT
    'Metric' as metric, 
    avg(date(lead_completed_at + interval '330 minutes') - date(enquired_at + interval '330 minutes')) as l2p
FROM chapter_opportunities
WHERE date(lead_completed_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)h on a.metric = h.metric 

left join
(
SELECT
      'Metric' as metric,
      avg(date(prospect_completed_at + interval '330 minutes') - date(lead_completed_at + interval '330 minutes')) as p2a
FROM chapter_opportunities
WHERE date(prospect_completed_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)i on a.metric = i.metric 

left join
(
SELECT 
    'Metric' as metric,
    avg(date(maal_laao_at + interval '330 minutes') - date(prospect_completed_at + interval '330 minutes')) as a2s
FROM chapter_opportunities
WHERE date(maal_laao_at + interval '330 minutes') between '2025-04-01' and  date(now() + interval '330 minutes')
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)j on a.metric = j.metric 



"
LYTD Scorecard | Chapter,"SELECT 
a.metric,
leads + coalesce(leads2,0) as leads,
coalesce(prospects,0) as Prospects,
coalesce(accounts,0) as Accounts,
coalesce(sales,0) as Sales,
f.meetings,
g.viewings,
l2p::int,
p2a::int,
a2s::int

FROM
(
SELECT 'Metric' as metric,
  count(distinct(chapter_opportunities.slug)) as leads
FROM chapter_opportunities
WHERE (enquired_at)::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
  and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
  and lower(chapter_opportunities.name) != 'test')
  and chapter_opportunities.source != 'DnB'
) a

left join
(
select 'Metric' as metric,
      count(id) as leads2
from enquiries
WHERE enquiries.vertical='chapter'
and enquiry_type='enquiry'
and leadable_id is null
and (lower(enquiries.name) not like '%test%' and lower(enquiries.name) not like 'test%'
  and lower(enquiries.name) != 'test')
and (created_at)::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
) b on a.metric = b.metric

left join
(
SELECT
    'Metric' as metric,
     count(distinct(chapter_opportunities.slug)) as prospects
FROM chapter_opportunities
WHERE (lead_completed_at + interval '330 minutes')::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)c on a.metric = c.metric 

left join
(
SELECT
      'Metric' as metric,
      count(distinct(chapter_opportunities.slug)) as accounts
FROM chapter_opportunities
WHERE (prospect_completed_at + interval '330 minutes')::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)d on a.metric = d.metric 

left join
(
SELECT 
    'Metric' as metric,
    COUNT(distinct(chapter_opportunities.slug)) AS sales
FROM chapter_opportunities
WHERE (maal_laao_at + interval '330 minutes')::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)e on a.metric = e.metric 

left join 
(
select
    'Metric' as metric,
    count(distinct(chapter_opportunities.slug)) as meetings
from tasks
inner join activities on tasks.id= activities.feedable_id
inner join medium on tasks.medium_id=medium.id
inner join chapter_opportunities on chapter_opportunities.id=activities.leadable_id
WHERE (performed_at + interval '330 minutes')::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
AND activities.feedable_type='Task' and activities.leadable_type='Chapter::Opportunity'
and ( medium.name='Meeting')
)f on a.metric = f.metric

left join
(
    select 'Metric' as metric,
    count(distinct(chapter_opportunities.slug)) as viewings
from tasks
inner join activities on tasks.id= activities.feedable_id
inner join medium on tasks.medium_id=medium.id
inner join chapter_opportunities on chapter_opportunities.id=activities.leadable_id
inner join staffs on staffs.id=chapter_opportunities.poc_exec_id
where activities.feedable_type='Task' and activities.leadable_type='Chapter::Opportunity'
and medium.name in ('Goa Viewing','Alibaug Viewing','Coonoor Viewing','Viewing','Site Visit')
and (performed_at + interval '330 minutes')::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
) g on a.metric = g.metric

left join 
(
SELECT
    'Metric' as metric, 
    avg(date(lead_completed_at + interval '330 minutes') - date(enquired_at + interval '330 minutes')) as l2p
FROM chapter_opportunities
WHERE (lead_completed_at + interval '330 minutes')::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)h on a.metric = h.metric 

left join
(
SELECT
      'Metric' as metric,
      avg(date(prospect_completed_at + interval '330 minutes') - date(lead_completed_at + interval '330 minutes')) as p2a
FROM chapter_opportunities
WHERE (prospect_completed_at + interval '330 minutes')::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)i on a.metric = i.metric 

left join
(
SELECT 
    'Metric' as metric,
    avg(date(maal_laao_at + interval '330 minutes') - date(prospect_completed_at + interval '330 minutes')) as a2s
FROM chapter_opportunities
WHERE (maal_laao_at + interval '330 minutes')::date BETWEEN 
      MAKE_DATE(
        CASE 
          WHEN EXTRACT(MONTH FROM CURRENT_DATE) >= 4 
            THEN EXTRACT(YEAR FROM CURRENT_DATE)::int - 1 
          ELSE EXTRACT(YEAR FROM CURRENT_DATE)::int - 2 
        END, 4, 1)
  AND (CURRENT_DATE - INTERVAL '1 year')::date
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
)j on a.metric = j.metric 

"
Lead - to - Prospect Conversion | Isprava,"select 
    CAST(A.MONTH AS DATE) AS MONTH_SORT,
    TO_CHAR(a.month,'Mon-YY') AS MONTH,
    sum(coalesce((leads),0) + coalesce((leads2),0)) as leads,
    sum(coalesce((prospects),0)) as prospects, sum(coalesce((accounts),0)) as accounts,
    sum(coalesce((sales),0)) as sales

from
(
SELECT date_trunc as month, source
FROM
  (
SELECT date_trunc('month', date)::date
FROM generate_series(
         date_trunc('month', CURRENT_DATE + interval '330 minutes') - interval '12 months',
         date_trunc('month', CURRENT_DATE + interval '330 minutes'),
         interval '1 day') as date
     ) AS datetable
        CROSS JOIN (
       select distinct source FROM
        (
        select case when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when development_opportunities.source in ('mygate') then 'Performance Marketing'
      when development_opportunities.source='google' and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (development_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source='google' or (development_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when development_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source like '%isprava%' or development_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when development_opportunities.source not like '%reference%' and development_opportunities.source != 'word_of_mouth' 
      and (development_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when development_opportunities.source = 'agent' then 'Agent'
      when development_opportunities.source like '%lohono%' then 'Lohono'
      when development_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source,
      date_trunc('month',development_opportunities.enquired_at + interval '5 hours 30 minutes') as month
      from development_opportunities) as source)
group by source, month      
) a

left join
(
select 
    source, 
    month, 
    sum(coalesce(leads,0))::int as leads
FROM
(
SELECT 
case when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when development_opportunities.source in ('mygate') then 'Performance Marketing'
      when development_opportunities.source='google' and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (development_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source='google' or (development_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when development_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source like '%isprava%' or development_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when development_opportunities.source not like '%reference%' and development_opportunities.source != 'word_of_mouth' 
      and (development_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when development_opportunities.source = 'agent' then 'Agent'
      when development_opportunities.source like '%lohono%' then 'Lohono'
      when development_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source,
count(distinct(development_opportunities.slug)) as leads,
date_trunc('month',development_opportunities.enquired_at + interval '5 hours 30 minutes') as month
FROM development_opportunities
WHERE date(enquired_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(enquired_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
and development_opportunities.source != 'DnB'
group by source, development_opportunities.meta, date_trunc('month',development_opportunities.enquired_at + interval '5 hours 30 minutes')
) query_1 
group by source, month
) b on a.source=b.source and a.month = b.month 

left join
(
select 
    source, 
    month,
    sum(coalesce(leads2,0))::int as leads2
FROM
(
select 
case when (enquiries.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when enquiries.source in ('linkedin','facebook','youtube') and ((enquiries.meta -> 'utm_source')::text = '""""'
           or (enquiries.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source in ('linkedin','facebook','youtube') and ((enquiries.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when enquiries.source in ('mygate') then 'Performance Marketing'
      when enquiries.source='google' and ((enquiries.meta -> 'utm_source')::text = '""""'
           or (enquiries.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (enquiries.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source='google' or (enquiries.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when enquiries.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source like '%isprava%' or enquiries.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when enquiries.source not like '%reference%' and enquiries.source != 'word_of_mouth' 
      and (enquiries.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (enquiries.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when enquiries.source = 'agent' then 'Agent'
      when enquiries.source like '%lohono%' then 'Lohono'
      when enquiries.source like '%chapter%' then 'Lohono'
      else 'Other' end as source, 
      count(id) as leads2,
      date_trunc('month',enquiries.created_at + interval '5 hours 30 minutes') as month
from enquiries
WHERE enquiries.vertical='development'
and enquiry_type='enquiry'
and leadable_id is null
and date(enquiries.created_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(enquiries.created_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
group by source, enquiries.meta,date_trunc('month',enquiries.created_at + interval '5 hours 30 minutes')
) x 
group by source,month
) c on a.source=c.source and a.month= c.month 


left join
(
select 
    source, 
    month,
    sum(coalesce(prospects,0))::int as prospects
FROM
(
SELECT
case when  (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when development_opportunities.source in ('mygate') then 'Performance Marketing'
      when development_opportunities.source='google' and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (development_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source='google' or (development_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when development_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source like '%isprava%' or development_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when development_opportunities.source not like '%reference%' and development_opportunities.source != 'word_of_mouth' 
      and (development_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when development_opportunities.source = 'agent' then 'Agent'
      when development_opportunities.source like '%lohono%' then 'Lohono'
      when development_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source,
      count(distinct(development_opportunities.slug)) as prospects,
      date_trunc('month',lead_completed_at + interval '5 hours 30 minutes') as month
FROM development_opportunities
WHERE date(lead_completed_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(lead_completed_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
group by source, development_opportunities.meta,date_trunc('month',lead_completed_at + interval '5 hours 30 minutes')
) query_1 
group by source, month
) d on a.source=d.source and a.month = d.month 

left join
(
select 
    source,
    month, 
    sum(coalesce(accounts,0))::int as accounts
FROM
(
SELECT
case  when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when development_opportunities.source in ('mygate') then 'Performance Marketing'
      when development_opportunities.source='google' and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (development_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source='google' or (development_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when development_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source like '%isprava%' or development_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when development_opportunities.source not like '%reference%' and development_opportunities.source != 'word_of_mouth' 
      and (development_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when development_opportunities.source = 'agent' then 'Agent'
      when development_opportunities.source like '%lohono%' then 'Lohono'
      when development_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source,
      count(distinct(development_opportunities.slug)) as accounts,
      date_trunc('month',prospect_completed_at + interval '5 hours 30 minutes') AS month
FROM development_opportunities
WHERE date(prospect_completed_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(prospect_completed_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
group by source, development_opportunities.meta, date_trunc('month',prospect_completed_at + interval '5 hours 30 minutes')
) query_1 
group by source, month
) e on a.source=e.source and a.month=e.month

left join
(
SELECT 
    x.source,
    x.month,
    sum((slug)) as sales
FROM
  (SELECT 
        date_trunc('month',development_opportunities.maal_laao_at + interval '5 hours 30 minutes') as month,
        COUNT(distinct(development_opportunities.slug)) AS slug, 
         case when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when development_opportunities.source in ('mygate') then 'Performance Marketing'
      when development_opportunities.source='google' and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (development_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source='google' or (development_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when development_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source like '%isprava%' or development_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when development_opportunities.source not like '%reference%' and development_opportunities.source != 'word_of_mouth' 
      and (development_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when development_opportunities.source = 'agent' then 'Agent'
      when development_opportunities.source like '%lohono%' then 'Lohono'
      when development_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source
   FROM development_opportunities
   WHERE date(maal_laao_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(maal_laao_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
group by source, development_opportunities.meta, date_trunc('month',development_opportunities.maal_laao_at + interval '5 hours 30 minutes')
) x
group by source, month 
) f on a.source=f.source and a.month = f.month 
group by CAST(A.MONTH AS DATE),
    TO_CHAR(a.month,'Mon-YY')
order by a.month"
Prospect - to- Account Conversion | Isprava,"select 
    CAST(A.MONTH AS DATE) AS MONTH_SORT,
    TO_CHAR(a.month,'Mon-YY') AS MONTH,
    sum(coalesce((leads),0) + coalesce((leads2),0)) as leads,
    sum(coalesce((prospects),0)) as prospects, sum(coalesce((accounts),0)) as accounts,
    sum(coalesce((sales),0)) as sales

from
(
SELECT date_trunc as month, source
FROM
  (
SELECT date_trunc('month', date)::date
FROM generate_series(
         date_trunc('month', CURRENT_DATE + interval '330 minutes') - interval '12 months',
         date_trunc('month', CURRENT_DATE + interval '330 minutes'),
         interval '1 day') as date
     ) AS datetable
        CROSS JOIN (
       select distinct source FROM
        (
        select case when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when development_opportunities.source in ('mygate') then 'Performance Marketing'
      when development_opportunities.source='google' and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (development_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source='google' or (development_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when development_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source like '%isprava%' or development_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when development_opportunities.source not like '%reference%' and development_opportunities.source != 'word_of_mouth' 
      and (development_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when development_opportunities.source = 'agent' then 'Agent'
      when development_opportunities.source like '%lohono%' then 'Lohono'
      when development_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source,
      date_trunc('month',development_opportunities.enquired_at + interval '5 hours 30 minutes') as month
      from development_opportunities) as source)
group by source, month      
) a

left join
(
select 
    source, 
    month, 
    sum(coalesce(leads,0))::int as leads
FROM
(
SELECT 
case when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when development_opportunities.source in ('mygate') then 'Performance Marketing'
      when development_opportunities.source='google' and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (development_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source='google' or (development_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when development_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source like '%isprava%' or development_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when development_opportunities.source not like '%reference%' and development_opportunities.source != 'word_of_mouth' 
      and (development_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when development_opportunities.source = 'agent' then 'Agent'
      when development_opportunities.source like '%lohono%' then 'Lohono'
      when development_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source,
count(distinct(development_opportunities.slug)) as leads,
date_trunc('month',development_opportunities.enquired_at + interval '5 hours 30 minutes') as month
FROM development_opportunities
WHERE date(enquired_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(enquired_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
and development_opportunities.source != 'DnB'
group by source, development_opportunities.meta, date_trunc('month',development_opportunities.enquired_at + interval '5 hours 30 minutes')
) query_1 
group by source, month
) b on a.source=b.source and a.month = b.month 

left join
(
select 
    source, 
    month,
    sum(coalesce(leads2,0))::int as leads2
FROM
(
select 
case when (enquiries.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when enquiries.source in ('linkedin','facebook','youtube') and ((enquiries.meta -> 'utm_source')::text = '""""'
           or (enquiries.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source in ('linkedin','facebook','youtube') and ((enquiries.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when enquiries.source in ('mygate') then 'Performance Marketing'
      when enquiries.source='google' and ((enquiries.meta -> 'utm_source')::text = '""""'
           or (enquiries.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (enquiries.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source='google' or (enquiries.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when enquiries.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source like '%isprava%' or enquiries.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when enquiries.source not like '%reference%' and enquiries.source != 'word_of_mouth' 
      and (enquiries.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (enquiries.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when enquiries.source = 'agent' then 'Agent'
      when enquiries.source like '%lohono%' then 'Lohono'
      when enquiries.source like '%chapter%' then 'Lohono'
      else 'Other' end as source, 
      count(id) as leads2,
      date_trunc('month',enquiries.created_at + interval '5 hours 30 minutes') as month
from enquiries
WHERE enquiries.vertical='development'
and enquiry_type='enquiry'
and leadable_id is null
and date(enquiries.created_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(enquiries.created_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
group by source, enquiries.meta,date_trunc('month',enquiries.created_at + interval '5 hours 30 minutes')
) x 
group by source,month
) c on a.source=c.source and a.month= c.month 


left join
(
select 
    source, 
    month,
    sum(coalesce(prospects,0))::int as prospects
FROM
(
SELECT
case when  (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when development_opportunities.source in ('mygate') then 'Performance Marketing'
      when development_opportunities.source='google' and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (development_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source='google' or (development_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when development_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source like '%isprava%' or development_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when development_opportunities.source not like '%reference%' and development_opportunities.source != 'word_of_mouth' 
      and (development_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when development_opportunities.source = 'agent' then 'Agent'
      when development_opportunities.source like '%lohono%' then 'Lohono'
      when development_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source,
      count(distinct(development_opportunities.slug)) as prospects,
      date_trunc('month',lead_completed_at + interval '5 hours 30 minutes') as month
FROM development_opportunities
WHERE date(lead_completed_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(lead_completed_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
group by source, development_opportunities.meta,date_trunc('month',lead_completed_at + interval '5 hours 30 minutes')
) query_1 
group by source, month
) d on a.source=d.source and a.month = d.month 

left join
(
select 
    source,
    month, 
    sum(coalesce(accounts,0))::int as accounts
FROM
(
SELECT
case  when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when development_opportunities.source in ('mygate') then 'Performance Marketing'
      when development_opportunities.source='google' and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (development_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source='google' or (development_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when development_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source like '%isprava%' or development_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when development_opportunities.source not like '%reference%' and development_opportunities.source != 'word_of_mouth' 
      and (development_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when development_opportunities.source = 'agent' then 'Agent'
      when development_opportunities.source like '%lohono%' then 'Lohono'
      when development_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source,
      count(distinct(development_opportunities.slug)) as accounts,
      date_trunc('month',prospect_completed_at + interval '5 hours 30 minutes') AS month
FROM development_opportunities
WHERE date(prospect_completed_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(prospect_completed_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
group by source, development_opportunities.meta, date_trunc('month',prospect_completed_at + interval '5 hours 30 minutes')
) query_1 
group by source, month
) e on a.source=e.source and a.month=e.month

left join
(
SELECT 
    x.source,
    x.month,
    sum((slug)) as sales
FROM
  (SELECT 
        date_trunc('month',development_opportunities.maal_laao_at + interval '5 hours 30 minutes') as month,
        COUNT(distinct(development_opportunities.slug)) AS slug, 
         case when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when development_opportunities.source in ('mygate') then 'Performance Marketing'
      when development_opportunities.source='google' and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (development_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source='google' or (development_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when development_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source like '%isprava%' or development_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when development_opportunities.source not like '%reference%' and development_opportunities.source != 'word_of_mouth' 
      and (development_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when development_opportunities.source = 'agent' then 'Agent'
      when development_opportunities.source like '%lohono%' then 'Lohono'
      when development_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source
   FROM development_opportunities
   WHERE date(maal_laao_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(maal_laao_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
group by source, development_opportunities.meta, date_trunc('month',development_opportunities.maal_laao_at + interval '5 hours 30 minutes')
) x
group by source, month 
) f on a.source=f.source and a.month = f.month 
group by CAST(A.MONTH AS DATE),
    TO_CHAR(a.month,'Mon-YY')
order by a.month"
Account - to - Sale Conversion | Isprava,"select 
    CAST(A.MONTH AS DATE) AS MONTH_SORT,
    TO_CHAR(a.month,'Mon-YY') AS MONTH,
    sum(coalesce((leads),0) + coalesce((leads2),0)) as leads,
    sum(coalesce((prospects),0)) as prospects, sum(coalesce((accounts),0)) as accounts,
    sum(coalesce((sales),0)) as sales

from
(
SELECT date_trunc as month, source
FROM
  (
SELECT date_trunc('month', date)::date
FROM generate_series(
         date_trunc('month', CURRENT_DATE + interval '330 minutes') - interval '12 months',
         date_trunc('month', CURRENT_DATE + interval '330 minutes'),
         interval '1 day') as date
     ) AS datetable
        CROSS JOIN (
       select distinct source FROM
        (
        select case when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when development_opportunities.source in ('mygate') then 'Performance Marketing'
      when development_opportunities.source='google' and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (development_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source='google' or (development_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when development_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source like '%isprava%' or development_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when development_opportunities.source not like '%reference%' and development_opportunities.source != 'word_of_mouth' 
      and (development_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when development_opportunities.source = 'agent' then 'Agent'
      when development_opportunities.source like '%lohono%' then 'Lohono'
      when development_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source,
      date_trunc('month',development_opportunities.enquired_at + interval '5 hours 30 minutes') as month
      from development_opportunities) as source)
group by source, month      
) a

left join
(
select 
    source, 
    month, 
    sum(coalesce(leads,0))::int as leads
FROM
(
SELECT 
case when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when development_opportunities.source in ('mygate') then 'Performance Marketing'
      when development_opportunities.source='google' and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (development_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source='google' or (development_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when development_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source like '%isprava%' or development_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when development_opportunities.source not like '%reference%' and development_opportunities.source != 'word_of_mouth' 
      and (development_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when development_opportunities.source = 'agent' then 'Agent'
      when development_opportunities.source like '%lohono%' then 'Lohono'
      when development_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source,
count(distinct(development_opportunities.slug)) as leads,
date_trunc('month',development_opportunities.enquired_at + interval '5 hours 30 minutes') as month
FROM development_opportunities
WHERE date(enquired_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(enquired_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
and development_opportunities.source != 'DnB'
group by source, development_opportunities.meta, date_trunc('month',development_opportunities.enquired_at + interval '5 hours 30 minutes')
) query_1 
group by source, month
) b on a.source=b.source and a.month = b.month 

left join
(
select 
    source, 
    month,
    sum(coalesce(leads2,0))::int as leads2
FROM
(
select 
case when (enquiries.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when enquiries.source in ('linkedin','facebook','youtube') and ((enquiries.meta -> 'utm_source')::text = '""""'
           or (enquiries.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source in ('linkedin','facebook','youtube') and ((enquiries.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when enquiries.source in ('mygate') then 'Performance Marketing'
      when enquiries.source='google' and ((enquiries.meta -> 'utm_source')::text = '""""'
           or (enquiries.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (enquiries.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source='google' or (enquiries.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when enquiries.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source like '%isprava%' or enquiries.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when enquiries.source not like '%reference%' and enquiries.source != 'word_of_mouth' 
      and (enquiries.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (enquiries.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when enquiries.source = 'agent' then 'Agent'
      when enquiries.source like '%lohono%' then 'Lohono'
      when enquiries.source like '%chapter%' then 'Lohono'
      else 'Other' end as source, 
      count(id) as leads2,
      date_trunc('month',enquiries.created_at + interval '5 hours 30 minutes') as month
from enquiries
WHERE enquiries.vertical='development'
and enquiry_type='enquiry'
and leadable_id is null
and date(enquiries.created_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(enquiries.created_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
group by source, enquiries.meta,date_trunc('month',enquiries.created_at + interval '5 hours 30 minutes')
) x 
group by source,month
) c on a.source=c.source and a.month= c.month 


left join
(
select 
    source, 
    month,
    sum(coalesce(prospects,0))::int as prospects
FROM
(
SELECT
case when  (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when development_opportunities.source in ('mygate') then 'Performance Marketing'
      when development_opportunities.source='google' and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (development_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source='google' or (development_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when development_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source like '%isprava%' or development_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when development_opportunities.source not like '%reference%' and development_opportunities.source != 'word_of_mouth' 
      and (development_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when development_opportunities.source = 'agent' then 'Agent'
      when development_opportunities.source like '%lohono%' then 'Lohono'
      when development_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source,
      count(distinct(development_opportunities.slug)) as prospects,
      date_trunc('month',lead_completed_at + interval '5 hours 30 minutes') as month
FROM development_opportunities
WHERE date(lead_completed_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(lead_completed_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
group by source, development_opportunities.meta,date_trunc('month',lead_completed_at + interval '5 hours 30 minutes')
) query_1 
group by source, month
) d on a.source=d.source and a.month = d.month 

left join
(
select 
    source,
    month, 
    sum(coalesce(accounts,0))::int as accounts
FROM
(
SELECT
case  when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when development_opportunities.source in ('mygate') then 'Performance Marketing'
      when development_opportunities.source='google' and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (development_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source='google' or (development_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when development_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source like '%isprava%' or development_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when development_opportunities.source not like '%reference%' and development_opportunities.source != 'word_of_mouth' 
      and (development_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when development_opportunities.source = 'agent' then 'Agent'
      when development_opportunities.source like '%lohono%' then 'Lohono'
      when development_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source,
      count(distinct(development_opportunities.slug)) as accounts,
      date_trunc('month',prospect_completed_at + interval '5 hours 30 minutes') AS month
FROM development_opportunities
WHERE date(prospect_completed_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(prospect_completed_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
group by source, development_opportunities.meta, date_trunc('month',prospect_completed_at + interval '5 hours 30 minutes')
) query_1 
group by source, month
) e on a.source=e.source and a.month=e.month

left join
(
SELECT 
    x.source,
    x.month,
    sum((slug)) as sales
FROM
  (SELECT 
        date_trunc('month',development_opportunities.maal_laao_at + interval '5 hours 30 minutes') as month,
        COUNT(distinct(development_opportunities.slug)) AS slug, 
         case when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('linkedin','facebook','youtube') and ((development_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when development_opportunities.source in ('mygate') then 'Performance Marketing'
      when development_opportunities.source='google' and ((development_opportunities.meta -> 'utm_source')::text = '""""'
           or (development_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (development_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source='google' or (development_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when development_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source like '%isprava%' or development_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when development_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when development_opportunities.source not like '%reference%' and development_opportunities.source != 'word_of_mouth' 
      and (development_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (development_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when development_opportunities.source = 'agent' then 'Agent'
      when development_opportunities.source like '%lohono%' then 'Lohono'
      when development_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source
   FROM development_opportunities
   WHERE date(maal_laao_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(maal_laao_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
and development_opportunities.slug not in ('569657C6','5EB1A14A','075E54DF')
group by source, development_opportunities.meta, date_trunc('month',development_opportunities.maal_laao_at + interval '5 hours 30 minutes')
) x
group by source, month 
) f on a.source=f.source and a.month = f.month 
group by CAST(A.MONTH AS DATE),
    TO_CHAR(a.month,'Mon-YY')
order by a.month"
Lead-to-Prospect Conversion | Chapter,"select 
    CAST(A.MONTH AS DATE) AS MONTH_SORT,
    TO_CHAR(a.month,'Mon-YY') AS MONTH,
    sum(coalesce((leads),0) + coalesce((leads2),0)) as leads,
    sum(coalesce((prospects),0)) as prospects, sum(coalesce((accounts),0)) as accounts,
    sum(coalesce((sales),0)) as sales

from
(
SELECT date_trunc as month, source
FROM
  (
SELECT date_trunc('month', date)::date
FROM generate_series(
         date_trunc('month', CURRENT_DATE + interval '330 minutes') - interval '12 months',
         date_trunc('month', CURRENT_DATE + interval '330 minutes'),
         interval '1 day') as date
     ) AS datetable
        CROSS JOIN (
       select distinct source FROM
        (
        select case when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when chapter_opportunities.source in ('mygate') then 'Performance Marketing'
      when chapter_opportunities.source='google' and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (chapter_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source='google' or (chapter_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when chapter_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source like '%isprava%' or chapter_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source not like '%reference%' and chapter_opportunities.source != 'word_of_mouth' 
      and (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source = 'agent' then 'Agent'
      when chapter_opportunities.source like '%lohono%' then 'Lohono'
      when chapter_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source,
      date_trunc('month',chapter_opportunities.enquired_at + interval '5 hours 30 minutes') as month
      from chapter_opportunities) as source)
group by source, month      
) a

left join
(
select 
    source, 
    month, 
    sum(coalesce(leads,0))::int as leads
FROM
(
SELECT 
case when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when chapter_opportunities.source in ('mygate') then 'Performance Marketing'
      when chapter_opportunities.source='google' and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (chapter_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source='google' or (chapter_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when chapter_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source like '%isprava%' or chapter_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source not like '%reference%' and chapter_opportunities.source != 'word_of_mouth' 
      and (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source = 'agent' then 'Agent'
      when chapter_opportunities.source like '%lohono%' then 'Lohono'
      when chapter_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source,
count(distinct(chapter_opportunities.slug)) as leads,
date_trunc('month',chapter_opportunities.enquired_at + interval '5 hours 30 minutes') as month
FROM chapter_opportunities
WHERE date(enquired_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(enquired_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
and chapter_opportunities.source != 'DnB'
group by source, chapter_opportunities.meta, date_trunc('month',chapter_opportunities.enquired_at + interval '5 hours 30 minutes')
) query_1 
group by source, month
) b on a.source=b.source and a.month = b.month 

left join
(
select 
    source, 
    month,
    sum(coalesce(leads2,0))::int as leads2
FROM
(
select 
case when (enquiries.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when enquiries.source in ('linkedin','facebook','youtube') and ((enquiries.meta -> 'utm_source')::text = '""""'
           or (enquiries.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source in ('linkedin','facebook','youtube') and ((enquiries.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when enquiries.source in ('mygate') then 'Performance Marketing'
      when enquiries.source='google' and ((enquiries.meta -> 'utm_source')::text = '""""'
           or (enquiries.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (enquiries.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source='google' or (enquiries.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when enquiries.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source like '%isprava%' or enquiries.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when enquiries.source not like '%reference%' and enquiries.source != 'word_of_mouth' 
      and (enquiries.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (enquiries.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when enquiries.source = 'agent' then 'Agent'
      when enquiries.source like '%lohono%' then 'Lohono'
      when enquiries.source like '%chapter%' then 'Lohono'
      else 'Other' end as source, 
      count(id) as leads2,
      date_trunc('month',enquiries.created_at + interval '5 hours 30 minutes') as month
from enquiries
WHERE enquiries.vertical='chapter'
and enquiry_type='enquiry'
and leadable_id is null
and (lower(enquiries.name) not like '%test%' and lower(enquiries.name) not like 'test%'
and lower(enquiries.name) != 'test')
and date(enquiries.created_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(enquiries.created_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
group by source, enquiries.meta,date_trunc('month',enquiries.created_at + interval '5 hours 30 minutes')
) x 
group by source,month
) c on a.source=c.source and a.month= c.month 


left join
(
select 
    source, 
    month,
    sum(coalesce(prospects,0))::int as prospects
FROM
(
SELECT
case when  (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when chapter_opportunities.source in ('mygate') then 'Performance Marketing'
      when chapter_opportunities.source='google' and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (chapter_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source='google' or (chapter_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when chapter_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source like '%isprava%' or chapter_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source not like '%reference%' and chapter_opportunities.source != 'word_of_mouth' 
      and (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source = 'agent' then 'Agent'
      when chapter_opportunities.source like '%lohono%' then 'Lohono'
      when chapter_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source,
      count(distinct(chapter_opportunities.slug)) as prospects,
      date_trunc('month',lead_completed_at + interval '5 hours 30 minutes') as month
FROM chapter_opportunities
WHERE date(lead_completed_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(lead_completed_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
group by source, chapter_opportunities.meta,date_trunc('month',lead_completed_at + interval '5 hours 30 minutes')
) query_1 
group by source, month
) d on a.source=d.source and a.month = d.month 

left join
(
select 
    source,
    month, 
    sum(coalesce(accounts,0))::int as accounts
FROM
(
SELECT
case  when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when chapter_opportunities.source in ('mygate') then 'Performance Marketing'
      when chapter_opportunities.source='google' and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (chapter_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source='google' or (chapter_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when chapter_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source like '%isprava%' or chapter_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source not like '%reference%' and chapter_opportunities.source != 'word_of_mouth' 
      and (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source = 'agent' then 'Agent'
      when chapter_opportunities.source like '%lohono%' then 'Lohono'
      when chapter_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source,
      count(distinct(chapter_opportunities.slug)) as accounts,
      date_trunc('month',prospect_completed_at + interval '5 hours 30 minutes') AS month
FROM chapter_opportunities
WHERE date(prospect_completed_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(prospect_completed_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
group by source, chapter_opportunities.meta, date_trunc('month',prospect_completed_at + interval '5 hours 30 minutes')
) query_1 
group by source, month
) e on a.source=e.source and a.month=e.month

left join
(
SELECT 
    x.source,
    x.month,
    sum((slug)) as sales
FROM
  (SELECT 
        date_trunc('month',chapter_opportunities.maal_laao_at + interval '5 hours 30 minutes') as month,
        COUNT(distinct(chapter_opportunities.slug)) AS slug, 
         case when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when chapter_opportunities.source in ('mygate') then 'Performance Marketing'
      when chapter_opportunities.source='google' and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (chapter_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source='google' or (chapter_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when chapter_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source like '%isprava%' or chapter_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source not like '%reference%' and chapter_opportunities.source != 'word_of_mouth' 
      and (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source = 'agent' then 'Agent'
      when chapter_opportunities.source like '%lohono%' then 'Lohono'
      when chapter_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source
   FROM chapter_opportunities
   WHERE date(maal_laao_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(maal_laao_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
group by source, chapter_opportunities.meta, date_trunc('month',chapter_opportunities.maal_laao_at + interval '5 hours 30 minutes')
) x
group by source, month 
) f on a.source=f.source and a.month = f.month 
group by CAST(A.MONTH AS DATE),
    TO_CHAR(a.month,'Mon-YY')
order by a.month"
Prospect-to-Account Conversion | Chapter,"select 
    CAST(A.MONTH AS DATE) AS MONTH_SORT,
    TO_CHAR(a.month,'Mon-YY') AS MONTH,
    sum(coalesce((leads),0) + coalesce((leads2),0)) as leads,
    sum(coalesce((prospects),0)) as prospects, sum(coalesce((accounts),0)) as accounts,
    sum(coalesce((sales),0)) as sales

from
(
SELECT date_trunc as month, source
FROM
  (
SELECT date_trunc('month', date)::date
FROM generate_series(
         date_trunc('month', CURRENT_DATE + interval '330 minutes') - interval '12 months',
         date_trunc('month', CURRENT_DATE + interval '330 minutes'),
         interval '1 day') as date
     ) AS datetable
        CROSS JOIN (
       select distinct source FROM
        (
        select case when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when chapter_opportunities.source in ('mygate') then 'Performance Marketing'
      when chapter_opportunities.source='google' and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (chapter_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source='google' or (chapter_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when chapter_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source like '%isprava%' or chapter_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source not like '%reference%' and chapter_opportunities.source != 'word_of_mouth' 
      and (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source = 'agent' then 'Agent'
      when chapter_opportunities.source like '%lohono%' then 'Lohono'
      when chapter_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source,
      date_trunc('month',chapter_opportunities.enquired_at + interval '5 hours 30 minutes') as month
      from chapter_opportunities) as source)
group by source, month      
) a

left join
(
select 
    source, 
    month, 
    sum(coalesce(leads,0))::int as leads
FROM
(
SELECT 
case when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when chapter_opportunities.source in ('mygate') then 'Performance Marketing'
      when chapter_opportunities.source='google' and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (chapter_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source='google' or (chapter_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when chapter_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source like '%isprava%' or chapter_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source not like '%reference%' and chapter_opportunities.source != 'word_of_mouth' 
      and (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source = 'agent' then 'Agent'
      when chapter_opportunities.source like '%lohono%' then 'Lohono'
      when chapter_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source,
count(distinct(chapter_opportunities.slug)) as leads,
date_trunc('month',chapter_opportunities.enquired_at + interval '5 hours 30 minutes') as month
FROM chapter_opportunities
WHERE date(enquired_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(enquired_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
and chapter_opportunities.source != 'DnB'
group by source, chapter_opportunities.meta, date_trunc('month',chapter_opportunities.enquired_at + interval '5 hours 30 minutes')
) query_1 
group by source, month
) b on a.source=b.source and a.month = b.month 

left join
(
select 
    source, 
    month,
    sum(coalesce(leads2,0))::int as leads2
FROM
(
select 
case when (enquiries.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when enquiries.source in ('linkedin','facebook','youtube') and ((enquiries.meta -> 'utm_source')::text = '""""'
           or (enquiries.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source in ('linkedin','facebook','youtube') and ((enquiries.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when enquiries.source in ('mygate') then 'Performance Marketing'
      when enquiries.source='google' and ((enquiries.meta -> 'utm_source')::text = '""""'
           or (enquiries.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (enquiries.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source='google' or (enquiries.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when enquiries.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source like '%isprava%' or enquiries.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when enquiries.source not like '%reference%' and enquiries.source != 'word_of_mouth' 
      and (enquiries.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (enquiries.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when enquiries.source = 'agent' then 'Agent'
      when enquiries.source like '%lohono%' then 'Lohono'
      when enquiries.source like '%chapter%' then 'Lohono'
      else 'Other' end as source, 
      count(id) as leads2,
      date_trunc('month',enquiries.created_at + interval '5 hours 30 minutes') as month
from enquiries
WHERE enquiries.vertical='chapter'
and enquiry_type='enquiry'
and leadable_id is null
and (lower(enquiries.name) not like '%test%' and lower(enquiries.name) not like 'test%'
and lower(enquiries.name) != 'test')
and date(enquiries.created_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(enquiries.created_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
group by source, enquiries.meta,date_trunc('month',enquiries.created_at + interval '5 hours 30 minutes')
) x 
group by source,month
) c on a.source=c.source and a.month= c.month 


left join
(
select 
    source, 
    month,
    sum(coalesce(prospects,0))::int as prospects
FROM
(
SELECT
case when  (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when chapter_opportunities.source in ('mygate') then 'Performance Marketing'
      when chapter_opportunities.source='google' and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (chapter_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source='google' or (chapter_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when chapter_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source like '%isprava%' or chapter_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source not like '%reference%' and chapter_opportunities.source != 'word_of_mouth' 
      and (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source = 'agent' then 'Agent'
      when chapter_opportunities.source like '%lohono%' then 'Lohono'
      when chapter_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source,
      count(distinct(chapter_opportunities.slug)) as prospects,
      date_trunc('month',lead_completed_at + interval '5 hours 30 minutes') as month
FROM chapter_opportunities
WHERE date(lead_completed_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(lead_completed_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
group by source, chapter_opportunities.meta,date_trunc('month',lead_completed_at + interval '5 hours 30 minutes')
) query_1 
group by source, month
) d on a.source=d.source and a.month = d.month 

left join
(
select 
    source,
    month, 
    sum(coalesce(accounts,0))::int as accounts
FROM
(
SELECT
case  when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when chapter_opportunities.source in ('mygate') then 'Performance Marketing'
      when chapter_opportunities.source='google' and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (chapter_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source='google' or (chapter_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when chapter_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source like '%isprava%' or chapter_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source not like '%reference%' and chapter_opportunities.source != 'word_of_mouth' 
      and (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source = 'agent' then 'Agent'
      when chapter_opportunities.source like '%lohono%' then 'Lohono'
      when chapter_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source,
      count(distinct(chapter_opportunities.slug)) as accounts,
      date_trunc('month',prospect_completed_at + interval '5 hours 30 minutes') AS month
FROM chapter_opportunities
WHERE date(prospect_completed_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(prospect_completed_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
group by source, chapter_opportunities.meta, date_trunc('month',prospect_completed_at + interval '5 hours 30 minutes')
) query_1 
group by source, month
) e on a.source=e.source and a.month=e.month

left join
(
SELECT 
    x.source,
    x.month,
    sum((slug)) as sales
FROM
  (SELECT 
        date_trunc('month',chapter_opportunities.maal_laao_at + interval '5 hours 30 minutes') as month,
        COUNT(distinct(chapter_opportunities.slug)) AS slug, 
         case when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when chapter_opportunities.source in ('mygate') then 'Performance Marketing'
      when chapter_opportunities.source='google' and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (chapter_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source='google' or (chapter_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when chapter_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source like '%isprava%' or chapter_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source not like '%reference%' and chapter_opportunities.source != 'word_of_mouth' 
      and (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source = 'agent' then 'Agent'
      when chapter_opportunities.source like '%lohono%' then 'Lohono'
      when chapter_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source
   FROM chapter_opportunities
   WHERE date(maal_laao_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(maal_laao_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
group by source, chapter_opportunities.meta, date_trunc('month',chapter_opportunities.maal_laao_at + interval '5 hours 30 minutes')
) x
group by source, month 
) f on a.source=f.source and a.month = f.month 
group by CAST(A.MONTH AS DATE),
    TO_CHAR(a.month,'Mon-YY')
order by a.month"
Account-to-Sales Conversion | Chapter,"select 
    CAST(A.MONTH AS DATE) AS MONTH_SORT,
    TO_CHAR(a.month,'Mon-YY') AS MONTH,
    sum(coalesce((leads),0) + coalesce((leads2),0)) as leads,
    sum(coalesce((prospects),0)) as prospects, sum(coalesce((accounts),0)) as accounts,
    sum(coalesce((sales),0)) as sales

from
(
SELECT date_trunc as month, source
FROM
  (
SELECT date_trunc('month', date)::date
FROM generate_series(
         date_trunc('month', CURRENT_DATE + interval '330 minutes') - interval '12 months',
         date_trunc('month', CURRENT_DATE + interval '330 minutes'),
         interval '1 day') as date
     ) AS datetable
        CROSS JOIN (
       select distinct source FROM
        (
        select case when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when chapter_opportunities.source in ('mygate') then 'Performance Marketing'
      when chapter_opportunities.source='google' and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (chapter_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source='google' or (chapter_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when chapter_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source like '%isprava%' or chapter_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source not like '%reference%' and chapter_opportunities.source != 'word_of_mouth' 
      and (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source = 'agent' then 'Agent'
      when chapter_opportunities.source like '%lohono%' then 'Lohono'
      when chapter_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source,
      date_trunc('month',chapter_opportunities.enquired_at + interval '5 hours 30 minutes') as month
      from chapter_opportunities) as source)
group by source, month      
) a

left join
(
select 
    source, 
    month, 
    sum(coalesce(leads,0))::int as leads
FROM
(
SELECT 
case when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when chapter_opportunities.source in ('mygate') then 'Performance Marketing'
      when chapter_opportunities.source='google' and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (chapter_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source='google' or (chapter_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when chapter_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source like '%isprava%' or chapter_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source not like '%reference%' and chapter_opportunities.source != 'word_of_mouth' 
      and (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source = 'agent' then 'Agent'
      when chapter_opportunities.source like '%lohono%' then 'Lohono'
      when chapter_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source,
count(distinct(chapter_opportunities.slug)) as leads,
date_trunc('month',chapter_opportunities.enquired_at + interval '5 hours 30 minutes') as month
FROM chapter_opportunities
WHERE date(enquired_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(enquired_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
and chapter_opportunities.source != 'DnB'
group by source, chapter_opportunities.meta, date_trunc('month',chapter_opportunities.enquired_at + interval '5 hours 30 minutes')
) query_1 
group by source, month
) b on a.source=b.source and a.month = b.month 

left join
(
select 
    source, 
    month,
    sum(coalesce(leads2,0))::int as leads2
FROM
(
select 
case when (enquiries.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when enquiries.source in ('linkedin','facebook','youtube') and ((enquiries.meta -> 'utm_source')::text = '""""'
           or (enquiries.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source in ('linkedin','facebook','youtube') and ((enquiries.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when enquiries.source in ('mygate') then 'Performance Marketing'
      when enquiries.source='google' and ((enquiries.meta -> 'utm_source')::text = '""""'
           or (enquiries.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (enquiries.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source='google' or (enquiries.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when enquiries.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source like '%isprava%' or enquiries.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when enquiries.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when enquiries.source not like '%reference%' and enquiries.source != 'word_of_mouth' 
      and (enquiries.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (enquiries.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when enquiries.source = 'agent' then 'Agent'
      when enquiries.source like '%lohono%' then 'Lohono'
      when enquiries.source like '%chapter%' then 'Lohono'
      else 'Other' end as source, 
      count(id) as leads2,
      date_trunc('month',enquiries.created_at + interval '5 hours 30 minutes') as month
from enquiries
WHERE enquiries.vertical='chapter'
and enquiry_type='enquiry'
and leadable_id is null
and (lower(enquiries.name) not like '%test%' and lower(enquiries.name) not like 'test%'
and lower(enquiries.name) != 'test')
and date(enquiries.created_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(enquiries.created_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
group by source, enquiries.meta,date_trunc('month',enquiries.created_at + interval '5 hours 30 minutes')
) x 
group by source,month
) c on a.source=c.source and a.month= c.month 


left join
(
select 
    source, 
    month,
    sum(coalesce(prospects,0))::int as prospects
FROM
(
SELECT
case when  (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when chapter_opportunities.source in ('mygate') then 'Performance Marketing'
      when chapter_opportunities.source='google' and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (chapter_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source='google' or (chapter_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when chapter_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source like '%isprava%' or chapter_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source not like '%reference%' and chapter_opportunities.source != 'word_of_mouth' 
      and (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source = 'agent' then 'Agent'
      when chapter_opportunities.source like '%lohono%' then 'Lohono'
      when chapter_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source,
      count(distinct(chapter_opportunities.slug)) as prospects,
      date_trunc('month',lead_completed_at + interval '5 hours 30 minutes') as month
FROM chapter_opportunities
WHERE date(lead_completed_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(lead_completed_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
group by source, chapter_opportunities.meta,date_trunc('month',lead_completed_at + interval '5 hours 30 minutes')
) query_1 
group by source, month
) d on a.source=d.source and a.month = d.month 

left join
(
select 
    source,
    month, 
    sum(coalesce(accounts,0))::int as accounts
FROM
(
SELECT
case  when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when chapter_opportunities.source in ('mygate') then 'Performance Marketing'
      when chapter_opportunities.source='google' and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (chapter_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source='google' or (chapter_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when chapter_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source like '%isprava%' or chapter_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source not like '%reference%' and chapter_opportunities.source != 'word_of_mouth' 
      and (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source = 'agent' then 'Agent'
      when chapter_opportunities.source like '%lohono%' then 'Lohono'
      when chapter_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source,
      count(distinct(chapter_opportunities.slug)) as accounts,
      date_trunc('month',prospect_completed_at + interval '5 hours 30 minutes') AS month
FROM chapter_opportunities
WHERE date(prospect_completed_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(prospect_completed_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
group by source, chapter_opportunities.meta, date_trunc('month',prospect_completed_at + interval '5 hours 30 minutes')
) query_1 
group by source, month
) e on a.source=e.source and a.month=e.month

left join
(
SELECT 
    x.source,
    x.month,
    sum((slug)) as sales
FROM
  (SELECT 
        date_trunc('month',chapter_opportunities.maal_laao_at + interval '5 hours 30 minutes') as month,
        COUNT(distinct(chapter_opportunities.slug)) AS slug, 
         case when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
       when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('linkedin','facebook','youtube') and ((chapter_opportunities.meta -> 'utm_source') is not null) 
      then 'Performance Marketing'
      when chapter_opportunities.source in ('mygate') then 'Performance Marketing'
      when chapter_opportunities.source='google' and ((chapter_opportunities.meta -> 'utm_source')::text = '""""'
           or (chapter_opportunities.meta -> 'utm_source')::text is null) 
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when (chapter_opportunities.meta ->> 'original_source')::text = 'Isprava.com'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source='google' or (chapter_opportunities.meta -> 'utm_source')::text in ('google','Google')
      then 'Performance Marketing'
      when chapter_opportunities.source in ('direct_call','incoming_call')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source = 'instagram'
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source like '%isprava%' or chapter_opportunities.source in ('isprava.com','website')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('direct_emailer','emailer')
      then 'WEBSITE, SOCIAL MEDIA & EMAILER (Organic Digital)'
      when chapter_opportunities.source in ('reference','word_of_mouth','isprava_reference','homeowner_ref','press','walk_in') then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source not like '%reference%' and chapter_opportunities.source != 'word_of_mouth' 
      and (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%'
      then 'REFERENCE + WOM + CX'
      when (chapter_opportunities.meta -> 'utm_campaign')::text like '%referral%' then 'REFERENCE + WOM + CX'
      when chapter_opportunities.source = 'agent' then 'Agent'
      when chapter_opportunities.source like '%lohono%' then 'Lohono'
      when chapter_opportunities.source like '%chapter%' then 'Lohono'
      else 'Other' end as source
   FROM chapter_opportunities
   WHERE date(maal_laao_at + interval '330 minutes') > date_trunc('month', CURRENT_DATE) - interval '12 months'
AND date(maal_laao_at + interval '330 minutes') <= date_trunc('month', CURRENT_DATE) + interval '1 month'
and (lower(chapter_opportunities.name) not like '%test%' and lower(chapter_opportunities.name) not like 'test%'
and lower(chapter_opportunities.name) != 'test')
group by source, chapter_opportunities.meta, date_trunc('month',chapter_opportunities.maal_laao_at + interval '5 hours 30 minutes')
) x
group by source, month 
) f on a.source=f.source and a.month = f.month 
group by CAST(A.MONTH AS DATE),
    TO_CHAR(a.month,'Mon-YY')
order by a.month"