# Deployment Modes: Local vs Production

This document explains the architectural differences between local development and production deployment.

## Overview

The application supports two deployment modes, configured via the `DEPLOYMENT_MODE` environment variable:

- **`local`**: For development on your machine
- **`production`**: For AWS deployment with ALB and nginx

## Architecture Comparison

### Local Development Mode

```
Browser
    ↓
Vite Dev Server (localhost:8080)
    ├─ / → React app (hot reload)
    └─ /api/* → Proxy to MCP Client (localhost:3001)
           ↓
    MCP Client (localhost:3001)
           ↓
    MCP Server (localhost:3000)
           ↓
    PostgreSQL (localhost:5433)
    MongoDB (localhost:27017)
```

**Characteristics:**
- Vite dev server proxies API requests to MCP Client
- Hot module replacement for React code
- Direct access to all services on localhost
- No nginx required
- OAuth redirects to `http://localhost:8080/auth/callback`

**Configuration:**
```bash
# .env
DEPLOYMENT_MODE=local
WEB_PORT=8080
CLIENT_PORT=3001
```

**Start command:**
```bash
make dev
# Or individually:
make postgres mongo
make dev-server  # Terminal 1
make dev-client  # Terminal 2
make dev-web     # Terminal 3
```

### Production Mode (AWS)

```
Internet
    ↓
ALB (Application Load Balancer)
    ├─ HTTPS:443 → with SSL certificate
    └─ HTTP:80 → redirect to HTTPS
        ↓
Target Group → EC2 Instance
        ↓
nginx (port 80) - Reverse Proxy
    ├─ https://ailabs.lohono.com/       → Docker: Web UI (port 8080)
    ├─ https://ailabs.lohono.com/api/*  → Docker: MCP Client (port 3001)
    └─ /health                           → Health check
        ↓
Docker Containers:
    ├─ Web UI (port 8080)          - Built React app (nginx serves static)
    ├─ MCP Client (port 3001)      - Express API
    ├─ MCP Server (port 3000)      - INTERNAL only
    ├─ PostgreSQL (port 5432)      - INTERNAL only
    └─ MongoDB (port 27017)        - INTERNAL only
```

**Characteristics:**
- nginx handles SSL termination (via ALB)
- nginx proxies both web and API requests
- Docker containers run production builds
- Only nginx port 80 is exposed to ALB
- OAuth redirects to `https://ailabs.lohono.com/auth/callback`

**Configuration:**
```bash
# .env
DEPLOYMENT_MODE=production
PUBLIC_DOMAIN=ailabs.lohono.com
WEB_PORT=8080
CLIENT_PORT=3001
```

**Start command:**
```bash
make deploy
```

## Key Differences

| Aspect | Local | Production |
|--------|-------|------------|
| **Web Server** | Vite dev server | nginx + Docker nginx |
| **API Proxy** | Vite proxy config | nginx reverse proxy |
| **SSL/HTTPS** | No (HTTP only) | Yes (ALB + ACM) |
| **Domain** | localhost:8080 | ailabs.lohono.com |
| **Hot Reload** | Yes | No (requires rebuild) |
| **Build** | Dev build (fast) | Production build (optimized) |
| **Environment** | Node.js on host | Docker containers |
| **Port Exposure** | All ports exposed | Only nginx:80 to ALB |
| **OAuth Redirect** | http://localhost:8080/auth/callback | https://ailabs.lohono.com/auth/callback |

## Configuration Files

### Local Mode

**Vite configuration** (`web/vite.config.ts`):
```typescript
export default defineConfig({
  server: {
    port: 8080,
    proxy: {
      '/api': {
        target: 'http://localhost:3001',
        changeOrigin: true,
      },
    },
  },
})
```

This makes Vite proxy `/api/*` requests to the MCP Client.

### Production Mode

**Nginx configuration** (generated by script):
```nginx
location /api/ {
    proxy_pass http://localhost:3001;
    # ... proxy headers and timeouts
}

location / {
    proxy_pass http://localhost:8080;
    # ... proxy headers
}
```

## Generating Nginx Configuration

For production deployment, generate the nginx config from your `.env`:

```bash
# Generate config
./scripts/generate-nginx-config.sh /tmp/nginx-lohono-mcp.conf

# Review the generated config
cat /tmp/nginx-lohono-mcp.conf

# Deploy to server (on EC2)
sudo cp /tmp/nginx-lohono-mcp.conf /etc/nginx/sites-available/lohono-mcp
sudo ln -sf /etc/nginx/sites-available/lohono-mcp /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

The script reads these variables from `.env`:
- `PUBLIC_DOMAIN` - Your domain (e.g., ailabs.lohono.com)
- `WEB_PORT` - Docker web container port (default: 8080)
- `CLIENT_PORT` - Docker API container port (default: 3001)

## Environment Variables Reference

### Required for Both Modes

```bash
# Database
DB_PASSWORD=secure_password_here
DB_USER=lohono_api
DB_NAME=lohono_api_production

# Claude API
ANTHROPIC_API_KEY=sk-ant-api03-...
```

### Local-Specific

```bash
DEPLOYMENT_MODE=local
WEB_PORT=8080        # Vite dev server port
CLIENT_PORT=3001     # MCP Client port
DB_EXTERNAL_PORT=5433  # PostgreSQL exposed port
MONGO_PORT=27017     # MongoDB exposed port
```

### Production-Specific

```bash
DEPLOYMENT_MODE=production
PUBLIC_DOMAIN=ailabs.lohono.com
WEB_PORT=8080        # Docker web container internal port
CLIENT_PORT=3001     # Docker API container internal port
# Database ports are NOT exposed externally
```

### OAuth Configuration

**Local:**
```bash
# Google OAuth redirect URI
http://localhost:8080/auth/callback
```

**Production:**
```bash
# Google OAuth redirect URI
https://ailabs.lohono.com/auth/callback
```

You need to configure both in Google Cloud Console for seamless dev-to-prod workflow.

## Switching Between Modes

### From Local to Production

1. **Update `.env`:**
   ```bash
   DEPLOYMENT_MODE=production
   PUBLIC_DOMAIN=ailabs.lohono.com
   ```

2. **Build Docker images:**
   ```bash
   make build
   ```

3. **Deploy:**
   ```bash
   make deploy
   ```

4. **Generate and install nginx config:**
   ```bash
   ./scripts/generate-nginx-config.sh
   # Then copy to server
   ```

### From Production to Local

1. **Update `.env`:**
   ```bash
   DEPLOYMENT_MODE=local
   ```

2. **Stop Docker:**
   ```bash
   make down
   ```

3. **Start local development:**
   ```bash
   make dev
   ```

## Testing Both Modes

### Test Local Setup

```bash
# Start services
make dev

# Test web UI
curl http://localhost:8080

# Test API
curl http://localhost:8080/api/health
# (Proxied by Vite to localhost:3001)

# Verify in browser
open http://localhost:8080
```

### Test Production Setup (locally with Docker)

```bash
# Update .env
DEPLOYMENT_MODE=production

# Deploy with Docker
make deploy

# Install nginx (if on production-like environment)
sudo apt-get install nginx
./scripts/generate-nginx-config.sh /tmp/nginx-lohono-mcp.conf
sudo cp /tmp/nginx-lohono-mcp.conf /etc/nginx/sites-available/lohono-mcp
sudo ln -sf /etc/nginx/sites-available/lohono-mcp /etc/nginx/sites-enabled/
sudo systemctl restart nginx

# Test through nginx
curl http://localhost/health
curl http://localhost/api/health
curl http://localhost/
```

## Troubleshooting

### Local Mode Issues

**Problem:** API requests failing
```bash
# Check Vite is proxying correctly
# Look for proxy logs in terminal

# Verify MCP Client is running
curl http://localhost:3001/api/health
```

**Problem:** Hot reload not working
```bash
# Restart Vite dev server
make dev-web
```

### Production Mode Issues

**Problem:** nginx can't reach Docker containers
```bash
# Check containers are running
docker compose ps

# Check nginx can reach containers
curl http://localhost:8080  # Web container
curl http://localhost:3001/api/health  # API container

# Check nginx config
sudo nginx -t
```

**Problem:** 502 Bad Gateway
```bash
# Usually means nginx can't reach upstream
# Check if Docker containers are healthy
docker compose ps

# Check nginx error logs
sudo tail -f /var/log/nginx/ailabs-error.log
```

## Best Practices

1. **Always use environment variables** - Never hardcode domains or ports
2. **Test locally first** - Use `DEPLOYMENT_MODE=local` for development
3. **Generate nginx config from script** - Don't manually edit production configs
4. **Keep OAuth redirect URIs updated** - Add both local and production URLs
5. **Use separate `.env` files** - `.env.local` and `.env.production` (optional)

## Summary

- **Local**: Fast development with hot reload, Vite proxies API
- **Production**: Optimized builds, nginx handles all routing, SSL via ALB
- **Switch easily**: Change `DEPLOYMENT_MODE` in `.env`
- **Use scripts**: Generate nginx config automatically for consistency
